<% content_for :title, "Milk Analytics Dashboard" %>

<div class="container-fluid">
  <!-- Header with Navigation Tabs -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h2 mb-2 text-dark fw-bold">
            <i class="fas fa-glass-milk text-primary me-3" style="font-size: 2rem;"></i>
            Milk Analytics
          </h1>
          <p class="text-muted mb-0 fs-5">Comprehensive milk procurement and delivery analytics</p>
        </div>
      </div>
      
      <!-- Navigation Tabs -->
      <ul class="nav nav-pills nav-fill" id="milkAnalyticsTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="dashboard-tab" data-bs-toggle="pill" data-bs-target="#dashboard" 
                  type="button" role="tab" aria-controls="dashboard" aria-selected="true">
            <i class="fas fa-chart-line me-2"></i>üìà Dashboard
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="reports-tab" data-bs-toggle="pill" data-bs-target="#reports" 
                  type="button" role="tab" aria-controls="reports" aria-selected="false">
            <i class="fas fa-file-alt me-2"></i>üìä Reports
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="procurement-tab" data-bs-toggle="pill" data-bs-target="#procurement" 
                  type="button" role="tab" aria-controls="procurement" aria-selected="false">
            <i class="fas fa-plus me-2"></i>‚ûï Create Procurement
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="calendar-tab" data-bs-toggle="pill" data-bs-target="#calendar" 
                  type="button" role="tab" aria-controls="calendar" aria-selected="false">
            <i class="fas fa-calendar-alt me-2"></i>üìÖ Procurement Calendar
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content" id="milkAnalyticsTabContent">
    
    <!-- Dashboard & Reports Tab -->
    <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
      <!-- Date Filter Section -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-0 shadow-sm">
            <div class="card-body py-3">
              <%= form_with url: milk_analytics_path, method: :get, local: true, class: "d-flex align-items-center gap-3 flex-wrap" do |form| %>
                <div class="d-flex align-items-center gap-2">
                  <label class="form-label mb-0 fw-bold text-muted">üìÖ Date Range:</label>
                  <%= form.select :date_range, 
                      options_for_select([
                        ['Today', 'today'],
                        ['This Week', 'week'], 
                        ['This Month', 'month'],
                        ['Custom Range', 'custom']
                      ], params[:date_range] || 'today'), 
                      {}, { class: "form-select", style: "width: 150px;", onchange: "toggleCustomDates()" } %>
                </div>
                <div class="custom-dates d-none">
                  <div class="d-flex align-items-center gap-2">
                    <label class="form-label mb-0 fw-bold text-muted">From:</label>
                    <%= form.date_field :from_date, 
                        value: params[:from_date] || Date.current, 
                        class: "form-control form-control-sm", 
                        style: "width: 150px;" %>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <label class="form-label mb-0 fw-bold text-muted">To:</label>
                    <%= form.date_field :to_date, 
                        value: params[:to_date] || Date.current, 
                        class: "form-control form-control-sm", 
                        style: "width: 150px;" %>
                  </div>
                </div>
                <%= form.submit "Apply Filter", class: "btn btn-primary btn-sm px-4" %>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Cards Row -->
      <div class="row mb-4">
        <!-- Card 1: Active Vendors -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-primary">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-users fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Active Vendors
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <%= @total_vendors || 0 %>
              </div>
            </div>
          </div>
        </div>

        <!-- Card 2: Total Liters Procured -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-info">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-glass-milk fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Liters Procured
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <%= number_with_delimiter(@total_liters || 0) %>L
              </div>
            </div>
          </div>
        </div>

        <!-- Card 3: Total Purchase Amount -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-warning">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-rupee-sign fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Purchase Amount
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                ‚Çπ<%= number_with_delimiter(@total_cost || 0) %>
              </div>
            </div>
          </div>
        </div>

        <!-- Card 4: Liters Delivered -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-success">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-truck fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Liters Delivered
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <%= number_with_delimiter(@total_delivered || 0) %>L
              </div>
            </div>
          </div>
        </div>

        <!-- Card 5: Milk Pending -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-warning">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-hourglass-half fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Milk Pending
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <% milk_pending = (@total_liters || 0) - (@total_delivered || 0) %>
                <%= number_with_delimiter(milk_pending) %>L
              </div>
              <div class="text-xs text-white opacity-75">
                <% pending_percentage = (@total_liters && @total_liters > 0) ? ((milk_pending.to_f / @total_liters) * 100).round(1) : 0 %>
                <%= pending_percentage %>% of procurement
              </div>
            </div>
          </div>
        </div>

        <!-- Card 6: Revenue from Deliveries -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-success">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-chart-line fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Revenue
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                ‚Çπ<%= number_with_delimiter(@total_revenue || 0) %>
              </div>
            </div>
          </div>
        </div>

        <!-- Card 7: Profit/Loss -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 <%= (@total_profit || 0) >= 0 ? 'gradient-success' : 'gradient-danger' %>">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-<%= (@total_profit || 0) >= 0 ? 'arrow-up' : 'arrow-down' %> fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                <%= (@total_profit || 0) >= 0 ? 'Profit' : 'Loss' %>
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                ‚Çπ<%= number_with_delimiter((@total_profit || 0).abs) %>
              </div>
            </div>
          </div>
        </div>

        <!-- Card 8: Profit Margin -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-info">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-percentage fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Profit Margin
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <% profit_margin = (@total_revenue && @total_revenue > 0) ? (((@total_profit || 0).to_f / @total_revenue) * 100).round(1) : 0 %>
                <%= profit_margin %>%
              </div>
              <div class="text-xs text-white opacity-75">
                Profit √∑ Revenue √ó 100
              </div>
            </div>
          </div>
        </div>

        <!-- Card 9: Cost Recovery -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 <%= (@total_cost && @total_cost > 0 && @total_revenue && (@total_revenue.to_f / @total_cost * 100) >= 100) ? 'gradient-success' : 'gradient-danger' %>">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-coins fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Cost Recovery
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <% cost_recovery = (@total_cost && @total_cost > 0) ? ((@total_revenue.to_f / @total_cost) * 100).round(2) : 0 %>
                <%= cost_recovery %>%
              </div>
              <div class="text-xs text-white opacity-75">
                Revenue √∑ Cost √ó 100
              </div>
            </div>
          </div>
        </div>

        <!-- Card 10: Break-even Need -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-warning">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-balance-scale fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Break-even Need
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <% breakeven_liters = (@total_cost && @total_cost > 0) ? (@total_cost.to_f / 100).round(0) : 0 %>
                <%= number_with_delimiter(breakeven_liters) %>L
              </div>
              <div class="text-xs text-white opacity-75">
                Cost √∑ ‚Çπ100/L
              </div>
            </div>
          </div>
        </div>

        <!-- Card 11: Utilization Rate -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-primary">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-chart-pie fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Utilization Rate
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <% utilization_rate = (@total_liters && @total_liters > 0) ? ((@total_delivered.to_f / @total_liters) * 100).round(1) : 0 %>
                <%= utilization_rate %>%
              </div>
              <div class="text-xs text-white opacity-75">
                Delivered √∑ Procured √ó 100
              </div>
            </div>
          </div>
        </div>

        <!-- Card 12: Wastage Cost -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-danger">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-exclamation-triangle fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Wastage Cost
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <% 
                  milk_pending = (@total_liters || 0) - (@total_delivered || 0)
                  wastage_cost = (@total_liters && @total_liters > 0) ? (milk_pending * (@total_cost.to_f / @total_liters)).round(0) : 0
                %>
                ‚Çπ<%= number_with_delimiter(wastage_cost) %>
              </div>
              <div class="text-xs text-white opacity-75">
                Pending √ó Avg Cost/L
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Tables -->
      <div class="row">
        <!-- Procurement Summary -->
        <div class="col-lg-6 mb-4">
          <div class="card border-0 shadow-lg">
            <div class="card-header py-4">
              <h5 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-shopping-cart me-2"></i>Procurement Summary
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Vendor</th>
                      <th>Quantity (L)</th>
                      <th>Amount (‚Çπ)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if @vendor_summary&.any? %>
                      <% @vendor_summary.each do |vendor| %>
                        <tr>
                          <td><%= vendor[:name] %></td>
                          <td><%= number_with_delimiter(vendor[:quantity]) %></td>
                          <td>‚Çπ<%= number_with_delimiter(vendor[:amount]) %></td>
                        </tr>
                      <% end %>
                    <% else %>
                      <tr>
                        <td colspan="3" class="text-center text-muted py-4">
                          <i class="fas fa-inbox fa-2x mb-2"></i><br>
                          No procurement data available
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Delivery Summary -->
        <div class="col-lg-6 mb-4">
          <div class="card border-0 shadow-lg">
            <div class="card-header py-4">
              <h5 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-truck me-2"></i>Delivery Summary
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Status</th>
                      <th>Count</th>
                      <th>Quantity (L)</th>
                      <th>Revenue (‚Çπ)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if @delivery_summary&.any? %>
                      <% @delivery_summary.each do |delivery| %>
                        <tr>
                          <td>
                            <span class="badge bg-<%= delivery[:status] == 'completed' ? 'success' : 'warning' %>">
                              <%= delivery[:status].titleize %>
                            </span>
                          </td>
                          <td><%= delivery[:count] %></td>
                          <td><%= number_with_delimiter(delivery[:quantity]) %></td>
                          <td>‚Çπ<%= number_with_delimiter(delivery[:revenue]) %></td>
                        </tr>
                      <% end %>
                    <% else %>
                      <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                          <i class="fas fa-truck fa-2x mb-2"></i><br>
                          No delivery data available
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Calculations Section -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-0 shadow-lg">
            <div class="card-header py-4 bg-gradient-primary text-white">
              <h5 class="m-0 font-weight-bold">
                <i class="fas fa-calculator me-2"></i>üìä Detailed Financial Calculations & Formulas
              </h5>
              <p class="mb-0 small opacity-90">Complete breakdown of procurement costs, delivery revenue, and profit calculations with formulas</p>
            </div>
            <div class="card-body">
              
              <!-- Procurement Calculations -->
              <div class="row mb-5">
                <div class="col-12">
                  <h6 class="text-primary fw-bold mb-3">
                    <i class="fas fa-shopping-cart me-2"></i>üõí Procurement Cost Analysis
                  </h6>
                  
                  <div class="row">
                    <!-- Planned vs Actual Procurement -->
                    <div class="col-lg-6 mb-4">
                      <div class="card bg-light border-0">
                        <div class="card-body">
                          <h6 class="card-title text-info">üìã Planned Procurement</h6>
                          <div class="calculation-breakdown">
                            <% planned_total_quantity = 0 %>
                            <% planned_total_cost = 0 %>
                            <% if @vendor_summary&.any? %>
                              <% @vendor_summary.each do |vendor| %>
                                <% 
                                  # Calculate planned quantities (assuming these are planned values)
                                  planned_quantity = vendor[:quantity] || 0
                                  planned_cost = vendor[:amount] || 0
                                  planned_total_quantity += planned_quantity
                                  planned_total_cost += planned_cost
                                %>
                                <div class="mb-2">
                                  <strong><%= vendor[:name] %>:</strong><br>
                                  <small class="text-muted">
                                    Planned: <%= number_with_delimiter(planned_quantity) %>L √ó ‚Çπ90/L = ‚Çπ<%= number_with_delimiter(planned_cost) %>
                                  </small>
                                </div>
                              <% end %>
                            <% end %>
                            <hr>
                            <div class="fw-bold">
                              <strong>Total Planned:</strong><br>
                              Quantity: <%= number_with_delimiter(planned_total_quantity) %>L<br>
                              Cost: ‚Çπ<%= number_with_delimiter(planned_total_cost) %>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Actual Procurement -->
                    <div class="col-lg-6 mb-4">
                      <div class="card bg-light border-0">
                        <div class="card-body">
                          <h6 class="card-title text-success">‚úÖ Actual Procurement</h6>
                          <div class="calculation-breakdown">
                            <div class="mb-2">
                              <strong>Total Received:</strong> <%= number_with_delimiter(@total_liters || 0) %>L<br>
                              <small class="text-muted">Formula: Sum of all actual quantities received from vendors</small>
                            </div>
                            <div class="mb-2">
                              <strong>Total Cost:</strong> ‚Çπ<%= number_with_delimiter(@total_cost || 0) %><br>
                              <small class="text-muted">Formula: Œ£(Actual Quantity √ó Buying Price per vendor)</small>
                            </div>
                            <div class="mb-2">
                              <strong>Average Cost/L:</strong> ‚Çπ<%= (@total_liters && @total_liters > 0) ? number_with_delimiter((@total_cost.to_f / @total_liters).round(2)) : '0' %><br>
                              <small class="text-muted">Formula: Total Cost √∑ Total Liters</small>
                            </div>
                            <div class="variance-analysis">
                              <% 
                                variance_quantity = (@total_liters || 0) - planned_total_quantity
                                variance_cost = (@total_cost || 0) - planned_total_cost
                                variance_percentage = planned_total_quantity > 0 ? ((variance_quantity.to_f / planned_total_quantity) * 100).round(2) : 0
                              %>
                              <strong>Variance Analysis:</strong><br>
                              <span class="<%= variance_quantity >= 0 ? 'text-success' : 'text-danger' %>">
                                Quantity: <%= variance_quantity >= 0 ? '+' : '' %><%= number_with_delimiter(variance_quantity) %>L (<%= variance_percentage %>%)
                              </span><br>
                              <span class="<%= variance_cost >= 0 ? 'text-danger' : 'text-success' %>">
                                Cost: <%= variance_cost >= 0 ? '+' : '' %>‚Çπ<%= number_with_delimiter(variance_cost) %>
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Delivery Revenue Analysis -->
              <div class="row mb-5">
                <div class="col-12">
                  <h6 class="text-primary fw-bold mb-3">
                    <i class="fas fa-truck me-2"></i>üöö Delivery Revenue Analysis
                  </h6>
                  
                  <div class="row">
                    <!-- Revenue Breakdown -->
                    <div class="col-lg-6 mb-4">
                      <div class="card bg-light border-0">
                        <div class="card-body">
                          <h6 class="card-title text-success">üí∞ Revenue Calculations</h6>
                          <div class="calculation-breakdown">
                            <div class="mb-3">
                              <strong>Total Delivered:</strong> <%= number_with_delimiter(@total_delivered || 0) %>L<br>
                              <small class="text-muted">Formula: Sum of all completed delivery quantities</small>
                            </div>
                            <div class="mb-3">
                              <strong>Total Revenue:</strong> ‚Çπ<%= number_with_delimiter(@total_revenue || 0) %><br>
                              <small class="text-muted">Formula: Œ£(Delivered Quantity √ó Selling Price per delivery)</small>
                            </div>
                            <div class="mb-3">
                              <strong>Average Price/L:</strong> ‚Çπ<%= (@total_delivered && @total_delivered > 0) ? number_with_delimiter((@total_revenue.to_f / @total_delivered).round(2)) : '0' %><br>
                              <small class="text-muted">Formula: Total Revenue √∑ Total Delivered</small>
                            </div>
                            
                            <% if @delivery_summary&.any? %>
                              <div class="delivery-status-breakdown">
                                <strong>Status Breakdown:</strong>
                                <% @delivery_summary.each do |delivery| %>
                                  <div class="small mt-1">
                                    <span class="badge bg-<%= delivery[:status] == 'completed' ? 'success' : 'warning' %> me-2">
                                      <%= delivery[:status].titleize %>
                                    </span>
                                    <%= delivery[:count] %> orders, 
                                    <%= number_with_delimiter(delivery[:quantity]) %>L, 
                                    ‚Çπ<%= number_with_delimiter(delivery[:revenue]) %>
                                  </div>
                                <% end %>
                              </div>
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Utilization Analysis -->
                    <div class="col-lg-6 mb-4">
                      <div class="card bg-light border-0">
                        <div class="card-body">
                          <h6 class="card-title text-warning">üìä Utilization Metrics</h6>
                          <div class="calculation-breakdown">
                            <% 
                              utilization_rate = (@total_liters && @total_liters > 0) ? ((@total_delivered.to_f / @total_liters) * 100).round(2) : 0
                              wastage_quantity = (@total_liters || 0) - (@total_delivered || 0)
                              wastage_percentage = (@total_liters && @total_liters > 0) ? ((wastage_quantity.to_f / @total_liters) * 100).round(2) : 0
                              wastage_cost = (@total_liters && @total_liters > 0) ? (wastage_quantity * (@total_cost.to_f / @total_liters)).round(2) : 0
                            %>
                            
                            <div class="mb-3">
                              <strong>Utilization Rate:</strong> 
                              <span class="<%= utilization_rate > 80 ? 'text-success' : utilization_rate > 50 ? 'text-warning' : 'text-danger' %>">
                                <%= utilization_rate %>%
                              </span><br>
                              <small class="text-muted">Formula: (Delivered √∑ Procured) √ó 100</small><br>
                              <small class="text-muted">Calculation: (<%= @total_delivered %>L √∑ <%= @total_liters %>L) √ó 100 = <%= utilization_rate %>%</small>
                            </div>
                            
                            <div class="mb-3">
                              <strong>Wastage Analysis:</strong><br>
                              <span class="text-danger">
                                Quantity: <%= number_with_delimiter(wastage_quantity) %>L (<%= wastage_percentage %>%)
                              </span><br>
                              <span class="text-danger">
                                Cost Impact: ‚Çπ<%= number_with_delimiter(wastage_cost) %>
                              </span><br>
                              <small class="text-muted">Formula: Procured - Delivered = Wastage</small><br>
                              <small class="text-muted">Calculation: <%= @total_liters %>L - <%= @total_delivered %>L = <%= wastage_quantity %>L</small>
                            </div>

                            <div class="efficiency-score">
                              <% efficiency_score = case utilization_rate
                                   when 80..100 then "Excellent"
                                   when 60..79 then "Good" 
                                   when 40..59 then "Average"
                                   when 20..39 then "Poor"
                                   else "Critical"
                                   end
                                 efficiency_color = case utilization_rate
                                   when 80..100 then "success"
                                   when 60..79 then "info"
                                   when 40..59 then "warning" 
                                   when 20..39 then "danger"
                                   else "dark"
                                   end %>
                              <strong>Efficiency Score:</strong>
                              <span class="badge bg-<%= efficiency_color %> fs-6"><%= efficiency_score %></span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Profit/Loss Detailed Analysis -->
              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-primary fw-bold mb-3">
                    <i class="fas fa-chart-line me-2"></i>üíπ Profit/Loss Detailed Analysis
                  </h6>
                  
                  <div class="row">
                    <!-- Financial Summary -->
                    <div class="col-lg-8 mb-4">
                      <div class="card border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        <div class="card-body">
                          <h6 class="card-title text-dark">üßÆ Complete Financial Formula</h6>
                          
                          <div class="formula-breakdown bg-white p-3 rounded border">
                            <div class="row">
                              <div class="col-md-6">
                                <h6 class="text-info">üì• COSTS (Input)</h6>
                                <div class="mb-2">
                                  <strong>Total Procurement Cost:</strong><br>
                                  <code class="bg-light p-1 rounded">‚Çπ<%= number_with_delimiter(@total_cost || 0) %></code>
                                </div>
                                <small class="text-muted">
                                  Formula: Œ£(Vendor Quantity √ó Buying Price)<br>
                                  <% if @vendor_summary&.any? %>
                                    <% @vendor_summary.each do |vendor| %>
                                      + <%= vendor[:name] %>: <%= number_with_delimiter(vendor[:quantity]) %>L √ó ‚Çπ90 = ‚Çπ<%= number_with_delimiter(vendor[:amount]) %><br>
                                    <% end %>
                                  <% end %>
                                </small>
                              </div>
                              
                              <div class="col-md-6">
                                <h6 class="text-success">üì§ REVENUE (Output)</h6>
                                <div class="mb-2">
                                  <strong>Total Delivery Revenue:</strong><br>
                                  <code class="bg-light p-1 rounded">‚Çπ<%= number_with_delimiter(@total_revenue || 0) %></code>
                                </div>
                                <small class="text-muted">
                                  Formula: Œ£(Delivered Quantity √ó Selling Price)<br>
                                  <%= @total_delivered %>L √ó ‚Çπ100 = ‚Çπ<%= number_with_delimiter(@total_revenue || 0) %>
                                </small>
                              </div>
                            </div>
                            
                            <hr class="my-3">
                            
                            <div class="text-center">
                              <h6 class="<%= (@total_profit || 0) >= 0 ? 'text-success' : 'text-danger' %>">
                                <i class="fas fa-<%= (@total_profit || 0) >= 0 ? 'arrow-up' : 'arrow-down' %> me-2"></i>
                                NET PROFIT/LOSS
                              </h6>
                              <div class="display-6 fw-bold <%= (@total_profit || 0) >= 0 ? 'text-success' : 'text-danger' %>">
                                ‚Çπ<%= number_with_delimiter((@total_profit || 0).abs) %> 
                                <small class="fs-6"><%= (@total_profit || 0) >= 0 ? 'PROFIT' : 'LOSS' %></small>
                              </div>
                              <div class="mt-2">
                                <code class="fs-6">Revenue - Cost = ‚Çπ<%= number_with_delimiter(@total_revenue || 0) %> - ‚Çπ<%= number_with_delimiter(@total_cost || 0) %> = ‚Çπ<%= number_with_delimiter(@total_profit || 0) %></code>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Additional Metrics -->
                          <div class="row mt-4">
                            <div class="col-md-4 text-center">
                              <div class="border rounded p-3">
                                <h6 class="text-muted">Profit Margin</h6>
                                <% profit_margin = (@total_revenue && @total_revenue > 0) ? (((@total_profit || 0).to_f / @total_revenue) * 100).round(2) : 0 %>
                                <div class="h4 <%= profit_margin >= 0 ? 'text-success' : 'text-danger' %>">
                                  <%= profit_margin %>%
                                </div>
                                <small class="text-muted">Profit √∑ Revenue √ó 100</small>
                              </div>
                            </div>
                            
                            <div class="col-md-4 text-center">
                              <div class="border rounded p-3">
                                <h6 class="text-muted">Cost Recovery</h6>
                                <% cost_recovery = (@total_cost && @total_cost > 0) ? ((@total_revenue.to_f / @total_cost) * 100).round(2) : 0 %>
                                <div class="h4 <%= cost_recovery >= 100 ? 'text-success' : 'text-danger' %>">
                                  <%= cost_recovery %>%
                                </div>
                                <small class="text-muted">Revenue √∑ Cost √ó 100</small>
                              </div>
                            </div>
                            
                            <div class="col-md-4 text-center">
                              <div class="border rounded p-3">
                                <h6 class="text-muted">Break-even Need</h6>
                                <% breakeven_liters = (@total_cost && @total_cost > 0) ? (@total_cost.to_f / 100).round(0) : 0 %>
                                <div class="h4 text-info">
                                  <%= number_with_delimiter(breakeven_liters) %>L
                                </div>
                                <small class="text-muted">Cost √∑ ‚Çπ100/L</small>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Optimization Recommendations -->
                    <div class="col-lg-4 mb-4">
                      <div class="card border-0 bg-warning bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title text-warning">üí° Optimization Insights</h6>
                          
                          <% if (@total_profit || 0) < 0 %>
                            <div class="alert alert-danger">
                              <strong>‚ö†Ô∏è LOSS SITUATION</strong><br>
                              Current loss: ‚Çπ<%= number_with_delimiter((@total_profit || 0).abs) %>
                            </div>
                            
                            <div class="recommendations">
                              <h6 class="small text-muted">IMMEDIATE ACTIONS:</h6>
                              <ul class="small">
                                <li>Reduce procurement to <%= breakeven_liters %>L (break-even)</li>
                                <li>Find <%= ((breakeven_liters - (@total_delivered || 0))).round(0) %>L more customers</li>
                                <li>Reduce wastage from <%= wastage_percentage %>% to <20%</li>
                                <li>Potential savings: ‚Çπ<%= number_with_delimiter((wastage_cost * 0.8).round(0)) %></li>
                              </ul>
                            </div>
                          <% else %>
                            <div class="alert alert-success">
                              <strong>‚úÖ PROFITABLE</strong><br>
                              Keep up the good work!
                            </div>
                          <% end %>
                          
                          <div class="mt-3">
                            <h6 class="small text-muted">EFFICIENCY TARGETS:</h6>
                            <div class="progress mb-2">
                              <div class="progress-bar bg-success" style="width: <%= [utilization_rate, 100].min %>%"></div>
                            </div>
                            <small>Utilization: <%= utilization_rate %>% (Target: 80%+)</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
      <!-- Report Selection and Filters -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-0 shadow-sm">
            <div class="card-body py-3">
              <div class="row align-items-center">
                <div class="col-md-3">
                  <label class="form-label mb-0 fw-bold text-muted">üìã Report Type:</label>
                  <select id="reportType" class="form-select" onchange="updateReportFilters()">
                    <option value="daily">Daily Procurement vs Delivery</option>
                    <option value="vendor">Vendor Performance Report</option>
                    <option value="profit">Profit/Loss Statement</option>
                    <option value="wastage">Milk Wastage Analysis</option>
                    <option value="monthly">Monthly Summary Report</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label mb-0 fw-bold text-muted">üìÖ Period:</label>
                  <select id="reportPeriod" class="form-select" onchange="updateDateFields()">
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="custom">Custom Range</option>
                  </select>
                </div>
                <div class="col-md-2 custom-date-fields d-none">
                  <label class="form-label mb-0 fw-bold text-muted">From:</label>
                  <input type="date" id="reportFromDate" class="form-control form-control-sm" value="<%= Date.current %>">
                </div>
                <div class="col-md-2 custom-date-fields d-none">
                  <label class="form-label mb-0 fw-bold text-muted">To:</label>
                  <input type="date" id="reportToDate" class="form-control form-control-sm" value="<%= Date.current %>">
                </div>
                <div class="col-md-2">
                  <label class="form-label mb-0">&nbsp;</label>
                  <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary btn-sm" onclick="generateReport()">
                      <i class="fas fa-chart-bar me-1"></i>Generate
                    </button>
                    <div class="dropdown">
                      <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-download me-1"></i>Export
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportReport('pdf')"><i class="fas fa-file-pdf me-2"></i>PDF</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportReport('excel')"><i class="fas fa-file-excel me-2"></i>Excel</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportReport('csv')"><i class="fas fa-file-csv me-2"></i>CSV</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Report Content Area -->
      <div id="reportContent">
        <!-- Daily Procurement vs Delivery Report -->
        <div id="dailyReport" class="report-section">
          <div class="row">
            <div class="col-12">
              <div class="card border-0 shadow-lg">
                <div class="card-header py-4">
                  <h5 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-comparison me-2"></i>Daily Procurement vs Delivery Report
                  </h5>
                  <p class="text-muted mb-0 small">Compare daily milk procurement against deliveries</p>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover" id="dailyReportTable">
                      <thead class="table-light">
                        <tr>
                          <th>Date</th>
                          <th>Vendor</th>
                          <th>Planned (L)</th>
                          <th>Actual (L)</th>
                          <th>Delivered (L)</th>
                          <th>Remaining (L)</th>
                          <th>Utilization %</th>
                          <th>Cost (‚Çπ)</th>
                          <th>Revenue (‚Çπ)</th>
                          <th>Profit (‚Çπ)</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td colspan="10" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>
                            <span class="text-muted">Click "Generate" to load report data</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vendor Performance Report -->
        <div id="vendorReport" class="report-section d-none">
          <div class="row">
            <div class="col-12">
              <div class="card border-0 shadow-lg">
                <div class="card-header py-4">
                  <h5 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-users me-2"></i>Vendor Performance Report
                  </h5>
                  <p class="text-muted mb-0 small">Analyze vendor reliability, quality, and profitability</p>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover" id="vendorReportTable">
                      <thead class="table-light">
                        <tr>
                          <th>Vendor Name</th>
                          <th>Total Orders</th>
                          <th>Completed</th>
                          <th>Reliability %</th>
                          <th>Avg Price (‚Çπ/L)</th>
                          <th>Total Quantity (L)</th>
                          <th>Total Cost (‚Çπ)</th>
                          <th>Total Profit (‚Çπ)</th>
                          <th>Performance Score</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td colspan="9" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>
                            <span class="text-muted">Click "Generate" to load vendor performance data</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Profit/Loss Statement -->
        <div id="profitReport" class="report-section d-none">
          <div class="row">
            <!-- Summary Cards -->
            <div class="col-lg-3 col-md-6 mb-4">
              <div class="card border-0 shadow-lg h-100 gradient-info">
                <div class="card-body p-4 text-center">
                  <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                    <i class="fas fa-shopping-cart fa-2x text-white"></i>
                  </div>
                  <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                    Total Procurement Cost
                  </div>
                  <div class="h4 mb-0 font-weight-bold text-white" id="totalProcurementCost">
                    ‚Çπ0
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
              <div class="card border-0 shadow-lg h-100 gradient-success">
                <div class="card-body p-4 text-center">
                  <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                    <i class="fas fa-rupee-sign fa-2x text-white"></i>
                  </div>
                  <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                    Total Revenue
                  </div>
                  <div class="h4 mb-0 font-weight-bold text-white" id="totalRevenue">
                    ‚Çπ0
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
              <div class="card border-0 shadow-lg h-100 gradient-warning">
                <div class="card-body p-4 text-center">
                  <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                    <i class="fas fa-chart-line fa-2x text-white"></i>
                  </div>
                  <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                    Gross Profit
                  </div>
                  <div class="h4 mb-0 font-weight-bold text-white" id="grossProfit">
                    ‚Çπ0
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
              <div class="card border-0 shadow-lg h-100 gradient-primary">
                <div class="card-body p-4 text-center">
                  <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                    <i class="fas fa-percentage fa-2x text-white"></i>
                  </div>
                  <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                    Profit Margin
                  </div>
                  <div class="h4 mb-0 font-weight-bold text-white" id="profitMargin">
                    0%
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Detailed P&L Table -->
          <div class="row">
            <div class="col-12">
              <div class="card border-0 shadow-lg">
                <div class="card-header py-4">
                  <h5 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calculator me-2"></i>Detailed Profit & Loss Statement
                  </h5>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover" id="profitLossTable">
                      <thead class="table-light">
                        <tr>
                          <th>Period</th>
                          <th>Procurement Cost (‚Çπ)</th>
                          <th>Delivery Revenue (‚Çπ)</th>
                          <th>Gross Profit (‚Çπ)</th>
                          <th>Wastage Loss (‚Çπ)</th>
                          <th>Net Profit (‚Çπ)</th>
                          <th>Margin %</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td colspan="7" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>
                            <span class="text-muted">Click "Generate" to load profit/loss data</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Wastage Analysis -->
        <div id="wastageReport" class="report-section d-none">
          <div class="row">
            <div class="col-12">
              <div class="card border-0 shadow-lg">
                <div class="card-header py-4">
                  <h5 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-exclamation-triangle me-2"></i>Milk Wastage Analysis
                  </h5>
                  <p class="text-muted mb-0 small">Track milk wastage and identify improvement opportunities</p>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover" id="wastageReportTable">
                      <thead class="table-light">
                        <tr>
                          <th>Date</th>
                          <th>Procured (L)</th>
                          <th>Delivered (L)</th>
                          <th>Wasted (L)</th>
                          <th>Wastage %</th>
                          <th>Wastage Cost (‚Çπ)</th>
                          <th>Reason</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td colspan="7" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>
                            <span class="text-muted">Click "Generate" to load wastage analysis</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Monthly Summary -->
        <div id="monthlyReport" class="report-section d-none">
          <div class="row">
            <div class="col-12">
              <div class="card border-0 shadow-lg">
                <div class="card-header py-4">
                  <h5 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calendar-check me-2"></i>Monthly Summary Report
                  </h5>
                  <p class="text-muted mb-0 small">Comprehensive monthly overview of procurement operations</p>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover" id="monthlyReportTable">
                      <thead class="table-light">
                        <tr>
                          <th>Month</th>
                          <th>Total Vendors</th>
                          <th>Procurement (L)</th>
                          <th>Deliveries (L)</th>
                          <th>Utilization %</th>
                          <th>Cost (‚Çπ)</th>
                          <th>Revenue (‚Çπ)</th>
                          <th>Profit (‚Çπ)</th>
                          <th>Growth %</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td colspan="9" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>
                            <span class="text-muted">Click "Generate" to load monthly summary</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Procurement Tab -->
    <div class="tab-pane fade" id="procurement" role="tabpanel" aria-labelledby="procurement-tab">
      <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-10">
          <div class="card border-0 shadow-lg">
            <div class="card-header py-4">
              <h5 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-plus-circle me-2"></i>Create New Procurement Schedule
              </h5>
              <p class="text-muted mb-0 small">Set up daily milk procurement from vendors</p>
            </div>
            
            <div class="card-body">
              <%= form_with model: ProcurementSchedule.new, url: procurement_schedules_path, local: true, class: "row g-3" do |form| %>
                <!-- Vendor Information -->
                <div class="col-md-6">
                  <%= form.label :vendor_name, "Vendor/Farm Name", class: "form-label fw-bold" %>
                  <%= form.text_field :vendor_name, 
                      class: "form-control",
                      placeholder: "e.g., Nandi Milk Goshala",
                      required: true %>
                  <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>Name of the farm or milk vendor
                  </div>
                </div>

                <div class="col-md-6">
                  <%= form.label :unit, "Unit of Measurement", class: "form-label fw-bold" %>
                  <%= form.select :unit, 
                      options_for_select([
                        ['Liters', 'liters'],
                        ['Gallons', 'gallons']
                      ], 'liters'), 
                      {}, { class: "form-select", required: true } %>
                </div>

                <!-- Date Range -->
                <div class="col-md-6">
                  <%= form.label :from_date, "From Date", class: "form-label fw-bold" %>
                  <%= form.date_field :from_date, class: "form-control", required: true, 
                      value: Date.current %>
                </div>

                <div class="col-md-6">
                  <%= form.label :to_date, "To Date", class: "form-label fw-bold" %>
                  <%= form.date_field :to_date, class: "form-control", required: true,
                      value: Date.current + 30.days %>
                </div>

                <!-- Quantities and Pricing -->
                <div class="col-md-4">
                  <%= form.label :quantity, "Daily Quantity", class: "form-label fw-bold" %>
                  <%= form.number_field :quantity, 
                      class: "form-control",
                      placeholder: "100.00",
                      step: 0.01,
                      min: 0.01,
                      required: true %>
                  <div class="form-text">Liters per day</div>
                </div>

                <div class="col-md-4">
                  <%= form.label :buying_price, "Buying Price (‚Çπ/L)", class: "form-label fw-bold" %>
                  <%= form.number_field :buying_price, 
                      class: "form-control",
                      placeholder: "90.00",
                      step: 0.01,
                      min: 0.01,
                      required: true %>
                  <div class="form-text">Cost per liter</div>
                </div>

                <div class="col-md-4">
                  <%= form.label :selling_price, "Selling Price (‚Çπ/L)", class: "form-label fw-bold" %>
                  <%= form.number_field :selling_price, 
                      class: "form-control",
                      placeholder: "100.00",
                      step: 0.01,
                      min: 0.01,
                      required: true %>
                  <div class="form-text">Price per liter to customers</div>
                </div>

                <!-- Additional Information -->
                <div class="col-12">
                  <%= form.label :notes, "Notes (Optional)", class: "form-label fw-bold" %>
                  <%= form.text_area :notes, class: "form-control", rows: 3,
                      placeholder: "Any additional notes about this procurement schedule..." %>
                </div>

                <!-- Submit Buttons -->
                <div class="col-12">
                  <div class="d-flex gap-2">
                    <%= form.submit "Create Procurement Schedule", class: "btn btn-primary btn-lg" %>
                    <button type="button" class="btn btn-secondary btn-lg" onclick="resetProcurementForm()">
                      Reset Form
                    </button>
                  </div>
                </div>
              <% end %>

              <!-- Info Box -->
              <div class="alert alert-info mt-4">
                <i class="fas fa-lightbulb me-2"></i>
                <strong>How it works:</strong> When you create a procurement schedule, the system will automatically generate daily procurement assignments for each day in the date range. Each assignment will have the planned quantity and prices you specify.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Procurement Calendar Tab -->
    <div class="tab-pane fade" id="calendar" role="tabpanel" aria-labelledby="calendar-tab">
      <div class="row">
        <div class="col-12">
          <div class="card border-0 shadow-lg">
            <div class="card-header py-4">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h5 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calendar-alt me-2"></i>Procurement Assignment Calendar
                  </h5>
                  <p class="text-muted mb-0 small">Click on any date to edit procurement assignments</p>
                </div>
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-primary" onclick="previousMonth()">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="nextMonth()">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                  <button type="button" class="btn btn-primary" onclick="goToToday()">
                    Today
                  </button>
                </div>
              </div>
            </div>
            
            <div class="card-body">
              <div id="procurementCalendar">
                <!-- Calendar will be rendered here -->
                <div class="text-center py-5">
                  <i class="fas fa-calendar fa-3x text-muted mb-3"></i>
                  <h4>Calendar Loading...</h4>
                  <p class="text-muted">Please wait while we load your procurement calendar</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Custom Styles -->
<style>
/* Tab Pills Styling */
.nav-pills .nav-link {
  border-radius: 0.5rem;
  padding: 1rem 1.5rem;
  margin: 0 0.25rem;
  font-weight: 600;
  color: #6c757d;
  background: transparent;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.nav-pills .nav-link:hover {
  background: rgba(108, 117, 125, 0.1);
  color: #495057;
}

.nav-pills .nav-link.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-color: #667eea;
  transform: translateY(-2px);
  box-shadow: 0 0.5rem 1rem rgba(102, 126, 234, 0.25);
}

/* Gradient Card Styles */
.gradient-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.gradient-info {
  background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
}

.gradient-warning {
  background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
}

.gradient-success {
  background: linear-gradient(135deg, #55a3ff 0%, #003d82 100%);
}

.gradient-danger {
  background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
}

/* Icon Circle */
.icon-circle-lg {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Form Enhancements */
.form-control:focus,
.form-select:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

/* Table Styling */
.table-hover tbody tr:hover {
  background-color: rgba(102, 126, 234, 0.05);
}

/* Custom Date Fields Toggle */
.custom-dates {
  transition: all 0.3s ease;
}

.custom-dates.show {
  display: flex !important;
}
</style>

<!-- JavaScript for Tab and Form Functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize date range selector
  const dateRangeSelect = document.querySelector('select[name="date_range"]');
  if (dateRangeSelect) {
    toggleCustomDates();
  }
});

function toggleCustomDates() {
  const dateRangeSelect = document.querySelector('select[name="date_range"]');
  const customDates = document.querySelector('.custom-dates');
  
  if (dateRangeSelect && customDates) {
    if (dateRangeSelect.value === 'custom') {
      customDates.classList.remove('d-none');
      customDates.classList.add('show');
    } else {
      customDates.classList.add('d-none');
      customDates.classList.remove('show');
    }
  }
}

function resetProcurementForm() {
  const form = document.querySelector('#procurement form');
  if (form) {
    form.reset();
    // Reset to default values
    document.querySelector('#procurement_schedule_from_date').value = '<%= Date.current %>';
    document.querySelector('#procurement_schedule_to_date').value = '<%= Date.current + 30.days %>';
  }
}

// Calendar Navigation Functions
function previousMonth() {
  // Calendar navigation logic will be implemented
  console.log('Previous month');
}

function nextMonth() {
  // Calendar navigation logic will be implemented  
  console.log('Next month');
}

function goToToday() {
  // Go to today logic will be implemented
  console.log('Go to today');
}

// Auto-submit form when date range changes (except custom)
document.addEventListener('change', function(e) {
  if (e.target.name === 'date_range' && e.target.value !== 'custom') {
    e.target.closest('form').submit();
  }
});

// Reports Tab Functionality
function updateReportFilters() {
  const reportType = document.getElementById('reportType').value;
  
  // Hide all report sections
  document.querySelectorAll('.report-section').forEach(section => {
    section.classList.add('d-none');
  });
  
  // Show selected report section
  const sectionMap = {
    'daily': 'dailyReport',
    'vendor': 'vendorReport', 
    'profit': 'profitReport',
    'wastage': 'wastageReport',
    'monthly': 'monthlyReport'
  };
  
  const targetSection = document.getElementById(sectionMap[reportType]);
  if (targetSection) {
    targetSection.classList.remove('d-none');
  }
}

function updateDateFields() {
  const period = document.getElementById('reportPeriod').value;
  const customFields = document.querySelectorAll('.custom-date-fields');
  
  if (period === 'custom') {
    customFields.forEach(field => field.classList.remove('d-none'));
  } else {
    customFields.forEach(field => field.classList.add('d-none'));
  }
}

function generateReport() {
  const reportType = document.getElementById('reportType').value;
  const period = document.getElementById('reportPeriod').value;
  let fromDate, toDate;
  
  // Calculate date range based on period
  const today = new Date();
  switch(period) {
    case 'today':
      fromDate = toDate = today.toISOString().split('T')[0];
      break;
    case 'week':
      const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
      fromDate = weekStart.toISOString().split('T')[0];
      toDate = new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      break;
    case 'month':
      fromDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
      toDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
      break;
    case 'custom':
      fromDate = document.getElementById('reportFromDate').value;
      toDate = document.getElementById('reportToDate').value;
      break;
  }
  
  if (!fromDate || !toDate) {
    alert('Please select valid dates');
    return;
  }
  
  // Show loading state
  showReportLoading(reportType);
  
  // Make API call to generate report
  const url = `/milk-supply-analytics/generate_reports?report_type=${getReportTypeParam(reportType)}&from_date=${fromDate}&to_date=${toDate}`;
  
  fetch(url, {
    method: 'GET',
    headers: {
      'Accept': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    populateReportData(reportType, data);
  })
  .catch(error => {
    console.error('Error generating report:', error);
    showReportError(reportType);
  });
}

function getReportTypeParam(reportType) {
  const paramMap = {
    'daily': 'daily_procurement_delivery',
    'vendor': 'vendor_performance',
    'profit': 'profit_loss',
    'wastage': 'wastage_analysis',
    'monthly': 'monthly_summary'
  };
  return paramMap[reportType];
}

function showReportLoading(reportType) {
  const tableMap = {
    'daily': 'dailyReportTable',
    'vendor': 'vendorReportTable',
    'profit': 'profitLossTable',
    'wastage': 'wastageReportTable',
    'monthly': 'monthlyReportTable'
  };
  
  const table = document.getElementById(tableMap[reportType]);
  if (table) {
    const tbody = table.getElementsByTagName('tbody')[0];
    tbody.innerHTML = `
      <tr>
        <td colspan="10" class="text-center py-4">
          <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>
          <span class="text-muted">Generating report...</span>
        </td>
      </tr>
    `;
  }
}

function showReportError(reportType) {
  const tableMap = {
    'daily': 'dailyReportTable',
    'vendor': 'vendorReportTable', 
    'profit': 'profitLossTable',
    'wastage': 'wastageReportTable',
    'monthly': 'monthlyReportTable'
  };
  
  const table = document.getElementById(tableMap[reportType]);
  if (table) {
    const tbody = table.getElementsByTagName('tbody')[0];
    tbody.innerHTML = `
      <tr>
        <td colspan="10" class="text-center py-4">
          <i class="fas fa-exclamation-triangle fa-2x mb-2 text-danger"></i><br>
          <span class="text-danger">Error generating report. Please try again.</span>
        </td>
      </tr>
    `;
  }
}

function populateReportData(reportType, data) {
  switch(reportType) {
    case 'daily':
      populateDailyReport(data);
      break;
    case 'vendor':
      populateVendorReport(data);
      break;
    case 'profit':
      populateProfitReport(data);
      break;
    case 'wastage':
      populateWastageReport(data);
      break;
    case 'monthly':
      populateMonthlyReport(data);
      break;
  }
}

function populateDailyReport(data) {
  const tbody = document.querySelector('#dailyReportTable tbody');
  if (!data || data.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="10" class="text-center py-4">
          <i class="fas fa-info-circle fa-2x mb-2 text-info"></i><br>
          <span class="text-muted">No data available for the selected period</span>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  data.forEach(row => {
    const utilizationClass = row.utilization_rate > 80 ? 'text-success' : row.utilization_rate > 60 ? 'text-warning' : 'text-danger';
    const profitClass = row.profit >= 0 ? 'text-success' : 'text-danger';
    
    html += `
      <tr>
        <td>${row.date}</td>
        <td>-</td>
        <td>-</td>
        <td>${row.procurement_liters.toFixed(2)}</td>
        <td>${row.delivery_liters.toFixed(2)}</td>
        <td>${row.wastage_liters.toFixed(2)}</td>
        <td><span class="${utilizationClass}">${row.utilization_rate}%</span></td>
        <td>‚Çπ${row.procurement_cost.toFixed(2)}</td>
        <td>‚Çπ${row.delivery_revenue.toFixed(2)}</td>
        <td><span class="${profitClass}">‚Çπ${row.profit.toFixed(2)}</span></td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function populateVendorReport(data) {
  const tbody = document.querySelector('#vendorReportTable tbody');
  if (!data || data.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="text-center py-4">
          <i class="fas fa-info-circle fa-2x mb-2 text-info"></i><br>
          <span class="text-muted">No vendor data available for the selected period</span>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  data.forEach(vendor => {
    const reliabilityClass = vendor.reliability_percentage > 80 ? 'text-success' : vendor.reliability_percentage > 60 ? 'text-warning' : 'text-danger';
    const scoreClass = vendor.performance_score > 80 ? 'text-success' : vendor.performance_score > 60 ? 'text-warning' : 'text-danger';
    
    html += `
      <tr>
        <td><strong>${vendor.vendor_name}</strong></td>
        <td>${vendor.total_assignments}</td>
        <td>${vendor.completed_assignments}</td>
        <td><span class="${reliabilityClass}">${vendor.reliability_percentage}%</span></td>
        <td>‚Çπ${vendor.average_price}</td>
        <td>${vendor.total_quantity.toFixed(2)} L</td>
        <td>‚Çπ${vendor.total_cost.toFixed(2)}</td>
        <td>‚Çπ${vendor.total_cost.toFixed(2)}</td>
        <td><span class="${scoreClass}">${vendor.performance_score}%</span></td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function populateProfitReport(data) {
  // Update summary cards
  document.getElementById('totalProcurementCost').textContent = `‚Çπ${data.summary.total_cost.toFixed(2)}`;
  document.getElementById('totalRevenue').textContent = `‚Çπ${data.summary.total_revenue.toFixed(2)}`;
  document.getElementById('grossProfit').textContent = `‚Çπ${data.summary.gross_profit.toFixed(2)}`;
  document.getElementById('profitMargin').textContent = `${data.summary.profit_margin}%`;
  
  // Update table
  const tbody = document.querySelector('#profitLossTable tbody');
  if (!data.daily_breakdown || data.daily_breakdown.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center py-4">
          <i class="fas fa-info-circle fa-2x mb-2 text-info"></i><br>
          <span class="text-muted">No profit/loss data available for the selected period</span>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  data.daily_breakdown.forEach(day => {
    const profitClass = day.profit >= 0 ? 'text-success' : 'text-danger';
    const margin = day.revenue > 0 ? ((day.profit / day.revenue) * 100).toFixed(2) : 0;
    
    html += `
      <tr>
        <td>${day.date}</td>
        <td>‚Çπ${day.cost.toFixed(2)}</td>
        <td>‚Çπ${day.revenue.toFixed(2)}</td>
        <td><span class="${profitClass}">‚Çπ${day.profit.toFixed(2)}</span></td>
        <td>‚Çπ0.00</td>
        <td><span class="${profitClass}">‚Çπ${day.profit.toFixed(2)}</span></td>
        <td>${margin}%</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function populateWastageReport(data) {
  const tbody = document.querySelector('#wastageReportTable tbody');
  if (!data.daily_data || data.daily_data.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center py-4">
          <i class="fas fa-info-circle fa-2x mb-2 text-info"></i><br>
          <span class="text-muted">No wastage data available for the selected period</span>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  data.daily_data.forEach(day => {
    const wastageClass = day.wastage_percentage > 20 ? 'text-danger' : day.wastage_percentage > 10 ? 'text-warning' : 'text-success';
    
    html += `
      <tr>
        <td>${day.date}</td>
        <td>${day.procurement_liters.toFixed(2)} L</td>
        <td>${day.delivery_liters.toFixed(2)} L</td>
        <td>${day.wastage_liters.toFixed(2)} L</td>
        <td><span class="${wastageClass}">${day.wastage_percentage}%</span></td>
        <td>‚Çπ${day.wastage_cost.toFixed(2)}</td>
        <td>Excess procurement</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function populateMonthlyReport(data) {
  const tbody = document.querySelector('#monthlyReportTable tbody');
  if (!data || Object.keys(data).length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="text-center py-4">
          <i class="fas fa-info-circle fa-2x mb-2 text-info"></i><br>
          <span class="text-muted">No monthly data available for the selected period</span>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  Object.entries(data).forEach(([month, monthData]) => {
    const profitClass = monthData.profit >= 0 ? 'text-success' : 'text-danger';
    
    html += `
      <tr>
        <td><strong>${month}</strong></td>
        <td>-</td>
        <td>${monthData.procurement_liters.toFixed(2)} L</td>
        <td>${monthData.delivery_liters.toFixed(2)} L</td>
        <td>${monthData.utilization_rate}%</td>
        <td>‚Çπ${monthData.procurement_cost.toFixed(2)}</td>
        <td>‚Çπ${monthData.delivery_revenue.toFixed(2)}</td>
        <td><span class="${profitClass}">‚Çπ${monthData.profit.toFixed(2)}</span></td>
        <td>-</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function exportReport(format) {
  const reportType = document.getElementById('reportType').value;
  alert(`Export to ${format.toUpperCase()} functionality will be implemented soon for ${reportType} report.`);
}

// Initialize report sections on page load
document.addEventListener('DOMContentLoaded', function() {
  updateReportFilters();
  updateDateFields();
});
</script>
<% content_for :title, "Milk Analytics Dashboard" %>

<div class="container-fluid">
  <!-- Header with Navigation Tabs -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h2 mb-2 text-dark fw-bold">
            <i class="fas fa-glass-milk text-primary me-3" style="font-size: 2rem;"></i>
            Milk Analytics
          </h1>
          <p class="text-muted mb-0 fs-5">Comprehensive milk procurement and delivery analytics</p>
        </div>
      </div>
      
      <!-- Navigation Tabs -->
      <ul class="nav nav-pills nav-fill" id="milkAnalyticsTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="dashboard-tab" data-bs-toggle="pill" data-bs-target="#dashboard" 
                  type="button" role="tab" aria-controls="dashboard" aria-selected="false">
            <i class="fas fa-chart-line me-2"></i>📈 Dashboard
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="reports-tab" data-bs-toggle="pill" data-bs-target="#reports" 
                  type="button" role="tab" aria-controls="reports" aria-selected="false">
            <i class="fas fa-file-alt me-2"></i>📊 Daily Report
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="procurement-tab" data-bs-toggle="pill" data-bs-target="#procurement" 
                  type="button" role="tab" aria-controls="procurement" aria-selected="false">
            <i class="fas fa-plus me-2"></i>➕ Create Procurement
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="calendar-tab" data-bs-toggle="pill" data-bs-target="#calendar" 
                  type="button" role="tab" aria-controls="calendar" aria-selected="true">
            <i class="fas fa-calendar-alt me-2"></i>📅 Procurement Calendar
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content" id="milkAnalyticsTabContent">
    
    <!-- Dashboard & Reports Tab -->
    <div class="tab-pane fade" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
      <!-- Date Filter Section -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-0 shadow-sm">
            <div class="card-body py-3">
              <%= form_with url: milk_analytics_path, method: :get, local: true, class: "d-flex align-items-center gap-3 flex-wrap" do |form| %>
                <div class="d-flex align-items-center gap-2">
                  <label class="form-label mb-0 fw-bold text-muted">📅 Date Range:</label>
                  <%= form.select :date_range, 
                      options_for_select([
                        ['Today', 'today'],
                        ['This Week', 'week'], 
                        ['This Month', 'month'],
                        ['Custom Range', 'custom']
                      ], params[:date_range] || 'month'), 
                      {}, { class: "form-select", style: "width: 150px;", onchange: "toggleCustomDates()" } %>
                </div>
                <div class="custom-dates d-none">
                  <div class="d-flex align-items-center gap-2">
                    <label class="form-label mb-0 fw-bold text-muted">From:</label>
                    <%= form.date_field :from_date, 
                        value: params[:from_date] || Date.current, 
                        class: "form-control form-control-sm", 
                        style: "width: 150px;" %>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <label class="form-label mb-0 fw-bold text-muted">To:</label>
                    <%= form.date_field :to_date, 
                        value: params[:to_date] || Date.current, 
                        class: "form-control form-control-sm", 
                        style: "width: 150px;" %>
                  </div>
                </div>
                <%= form.submit "Apply Filter", class: "btn btn-primary btn-sm px-4" %>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Cards Row -->
      <div class="row mb-4">
        <!-- Card 1: Active Vendors -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-primary">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-users fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Active Vendors
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <%= @total_vendors || 0 %>
              </div>
            </div>
          </div>
        </div>

        <!-- Card 2: Total Liters Procured -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-info">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-glass-milk fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Liters Procured
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <%= number_with_delimiter(@total_liters || 0) %>L
              </div>
            </div>
          </div>
        </div>

        <!-- Card 3: Total Purchase Amount -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-warning">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-rupee-sign fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Purchase Amount
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                ₹<%= number_with_delimiter(@total_cost || 0) %>
              </div>
            </div>
          </div>
        </div>

        <!-- Card 4: Liters Delivered -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-success">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-truck fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Liters Delivered
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <%= number_with_delimiter(@total_delivered || 0) %>L
              </div>
            </div>
          </div>
        </div>

        <!-- Card 5: Milk Pending -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-warning">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-hourglass-half fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Milk Pending
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <% milk_pending = (@total_liters || 0) - (@total_delivered || 0) %>
                <%= number_with_delimiter(milk_pending) %>L
              </div>
              <div class="text-xs text-white opacity-75">
                <% pending_percentage = (@total_liters && @total_liters > 0) ? ((milk_pending.to_f / @total_liters) * 100).round(1) : 0 %>
                <%= pending_percentage %>% of procurement
              </div>
            </div>
          </div>
        </div>

        <!-- Card 6: Revenue from Deliveries -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-success">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-chart-line fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Revenue
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                ₹<%= number_with_delimiter(@total_revenue || 0) %>
              </div>
            </div>
          </div>
        </div>

        <!-- Card 7: Profit/Loss -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 <%= (@total_profit || 0) >= 0 ? 'gradient-success' : 'gradient-danger' %>">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-<%= (@total_profit || 0) >= 0 ? 'arrow-up' : 'arrow-down' %> fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                <%= (@total_profit || 0) >= 0 ? 'Profit' : 'Loss' %>
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                ₹<%= number_with_delimiter((@total_profit || 0).abs) %>
              </div>
            </div>
          </div>
        </div>

        <!-- Card 8: Profit Margin -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-info">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-percentage fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Profit Margin
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <% profit_margin = (@total_revenue && @total_revenue > 0) ? (((@total_profit || 0).to_f / @total_revenue) * 100).round(1) : 0 %>
                <%= profit_margin %>%
              </div>
              <div class="text-xs text-white opacity-75">
                Profit ÷ Revenue × 100
              </div>
            </div>
          </div>
        </div>

        <!-- Card 9: Cost Recovery -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 <%= (@total_cost && @total_cost > 0 && @total_revenue && (@total_revenue.to_f / @total_cost * 100) >= 100) ? 'gradient-success' : 'gradient-danger' %>">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-coins fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Cost Recovery
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <% cost_recovery = (@total_cost && @total_cost > 0) ? ((@total_revenue.to_f / @total_cost) * 100).round(2) : 0 %>
                <%= cost_recovery %>%
              </div>
              <div class="text-xs text-white opacity-75">
                Revenue ÷ Cost × 100
              </div>
            </div>
          </div>
        </div>

        <!-- Card 10: Break-even Need -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-warning">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-balance-scale fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Break-even Need
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <% breakeven_liters = (@total_cost && @total_cost > 0) ? (@total_cost.to_f / 100).round(0) : 0 %>
                <%= number_with_delimiter(breakeven_liters) %>L
              </div>
              <div class="text-xs text-white opacity-75">
                Cost ÷ ₹100/L
              </div>
            </div>
          </div>
        </div>

        <!-- Card 11: Utilization Rate -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-primary">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-chart-pie fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Utilization Rate
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <% utilization_rate = (@total_liters && @total_liters > 0) ? ((@total_delivered.to_f / @total_liters) * 100).round(1) : 0 %>
                <%= utilization_rate %>%
              </div>
              <div class="text-xs text-white opacity-75">
                Delivered ÷ Procured × 100
              </div>
            </div>
          </div>
        </div>

        <!-- Card 12: Wastage Cost -->
        <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
          <div class="card border-0 shadow-lg h-100 gradient-danger">
            <div class="card-body p-4 text-center">
              <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                <i class="fas fa-exclamation-triangle fa-2x text-white"></i>
              </div>
              <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                Wastage Cost
              </div>
              <div class="h4 mb-0 font-weight-bold text-white">
                <% 
                  milk_pending = (@total_liters || 0) - (@total_delivered || 0)
                  wastage_cost = (@total_liters && @total_liters > 0) ? (milk_pending * (@total_cost.to_f / @total_liters)).round(0) : 0
                %>
                ₹<%= number_with_delimiter(wastage_cost) %>
              </div>
              <div class="text-xs text-white opacity-75">
                Pending × Avg Cost/L
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Tables -->
      <div class="row">
        <!-- Procurement Summary -->
        <div class="col-lg-6 mb-4">
          <div class="card border-0 shadow-lg">
            <div class="card-header py-4">
              <h5 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-shopping-cart me-2"></i>Procurement Summary
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Vendor</th>
                      <th>Quantity (L)</th>
                      <th>Amount (₹)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if @vendor_summary&.any? %>
                      <% @vendor_summary.each do |vendor| %>
                        <tr>
                          <td><%= vendor[:name] %></td>
                          <td><%= number_with_delimiter(vendor[:quantity]) %></td>
                          <td>₹<%= number_with_delimiter(vendor[:amount]) %></td>
                        </tr>
                      <% end %>
                    <% else %>
                      <tr>
                        <td colspan="3" class="text-center text-muted py-4">
                          <i class="fas fa-inbox fa-2x mb-2"></i><br>
                          No procurement data available
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Delivery Summary -->
        <div class="col-lg-6 mb-4">
          <div class="card border-0 shadow-lg">
            <div class="card-header py-4">
              <h5 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-truck me-2"></i>Delivery Summary
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Status</th>
                      <th>Count</th>
                      <th>Quantity (L)</th>
                      <th>Revenue (₹)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if @delivery_summary&.any? %>
                      <% @delivery_summary.each do |delivery| %>
                        <tr>
                          <td>
                            <span class="badge bg-<%= delivery[:status] == 'completed' ? 'success' : 'warning' %>">
                              <%= delivery[:status].titleize %>
                            </span>
                          </td>
                          <td><%= delivery[:count] %></td>
                          <td><%= number_with_delimiter(delivery[:quantity]) %></td>
                          <td>₹<%= number_with_delimiter(delivery[:revenue]) %></td>
                        </tr>
                      <% end %>
                    <% else %>
                      <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                          <i class="fas fa-truck fa-2x mb-2"></i><br>
                          No delivery data available
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Calculations Section -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-0 shadow-lg">
            <div class="card-header py-4 bg-gradient-primary text-white">
              <h5 class="m-0 font-weight-bold">
                <i class="fas fa-calculator me-2"></i>📊 Detailed Financial Calculations & Formulas
              </h5>
              <p class="mb-0 small opacity-90">Complete breakdown of procurement costs, delivery revenue, and profit calculations with formulas</p>
            </div>
            <div class="card-body">
              
              <!-- Procurement Calculations -->
              <div class="row mb-5">
                <div class="col-12">
                  <h6 class="text-primary fw-bold mb-3">
                    <i class="fas fa-shopping-cart me-2"></i>🛒 Procurement Cost Analysis
                  </h6>
                  
                  <div class="row">
                    <!-- Planned vs Actual Procurement -->
                    <div class="col-lg-6 mb-4">
                      <div class="card bg-light border-0">
                        <div class="card-body">
                          <h6 class="card-title text-info">📋 Planned Procurement</h6>
                          <div class="calculation-breakdown">
                            <% planned_total_quantity = 0 %>
                            <% planned_total_cost = 0 %>
                            <% if @vendor_summary&.any? %>
                              <% @vendor_summary.each do |vendor| %>
                                <% 
                                  # Calculate planned quantities (assuming these are planned values)
                                  planned_quantity = vendor[:quantity] || 0
                                  planned_cost = vendor[:amount] || 0
                                  planned_total_quantity += planned_quantity
                                  planned_total_cost += planned_cost
                                %>
                                <div class="mb-2">
                                  <strong><%= vendor[:name] %>:</strong><br>
                                  <small class="text-muted">
                                    Planned: <%= number_with_delimiter(planned_quantity) %>L × ₹90/L = ₹<%= number_with_delimiter(planned_cost) %>
                                  </small>
                                </div>
                              <% end %>
                            <% end %>
                            <hr>
                            <div class="fw-bold">
                              <strong>Total Planned:</strong><br>
                              Quantity: <%= number_with_delimiter(planned_total_quantity) %>L<br>
                              Cost: ₹<%= number_with_delimiter(planned_total_cost) %>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Actual Procurement -->
                    <div class="col-lg-6 mb-4">
                      <div class="card bg-light border-0">
                        <div class="card-body">
                          <h6 class="card-title text-success">✅ Actual Procurement</h6>
                          <div class="calculation-breakdown">
                            <div class="mb-2">
                              <strong>Total Received:</strong> <%= number_with_delimiter(@total_liters || 0) %>L<br>
                              <small class="text-muted">Formula: Sum of all actual quantities received from vendors</small>
                            </div>
                            <div class="mb-2">
                              <strong>Total Cost:</strong> ₹<%= number_with_delimiter(@total_cost || 0) %><br>
                              <small class="text-muted">Formula: Σ(Actual Quantity × Buying Price per vendor)</small>
                            </div>
                            <div class="mb-2">
                              <strong>Average Cost/L:</strong> ₹<%= (@total_liters && @total_liters > 0) ? number_with_delimiter((@total_cost.to_f / @total_liters).round(2)) : '0' %><br>
                              <small class="text-muted">Formula: Total Cost ÷ Total Liters</small>
                            </div>
                            <div class="variance-analysis">
                              <% 
                                variance_quantity = (@total_liters || 0) - planned_total_quantity
                                variance_cost = (@total_cost || 0) - planned_total_cost
                                variance_percentage = planned_total_quantity > 0 ? ((variance_quantity.to_f / planned_total_quantity) * 100).round(2) : 0
                              %>
                              <strong>Variance Analysis:</strong><br>
                              <span class="<%= variance_quantity >= 0 ? 'text-success' : 'text-danger' %>">
                                Quantity: <%= variance_quantity >= 0 ? '+' : '' %><%= number_with_delimiter(variance_quantity) %>L (<%= variance_percentage %>%)
                              </span><br>
                              <span class="<%= variance_cost >= 0 ? 'text-danger' : 'text-success' %>">
                                Cost: <%= variance_cost >= 0 ? '+' : '' %>₹<%= number_with_delimiter(variance_cost) %>
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Delivery Revenue Analysis -->
              <div class="row mb-5">
                <div class="col-12">
                  <h6 class="text-primary fw-bold mb-3">
                    <i class="fas fa-truck me-2"></i>🚚 Delivery Revenue Analysis
                  </h6>
                  
                  <div class="row">
                    <!-- Revenue Breakdown -->
                    <div class="col-lg-6 mb-4">
                      <div class="card bg-light border-0">
                        <div class="card-body">
                          <h6 class="card-title text-success">💰 Revenue Calculations</h6>
                          <div class="calculation-breakdown">
                            <div class="mb-3">
                              <strong>Total Delivered:</strong> <%= number_with_delimiter(@total_delivered || 0) %>L<br>
                              <small class="text-muted">Formula: Sum of all completed delivery quantities</small>
                            </div>
                            <div class="mb-3">
                              <strong>Total Revenue:</strong> ₹<%= number_with_delimiter(@total_revenue || 0) %><br>
                              <small class="text-muted">Formula: Σ(Delivered Quantity × Selling Price per delivery)</small>
                            </div>
                            <div class="mb-3">
                              <strong>Average Price/L:</strong> ₹<%= (@total_delivered && @total_delivered > 0) ? number_with_delimiter((@total_revenue.to_f / @total_delivered).round(2)) : '0' %><br>
                              <small class="text-muted">Formula: Total Revenue ÷ Total Delivered</small>
                            </div>
                            
                            <% if @delivery_summary&.any? %>
                              <div class="delivery-status-breakdown">
                                <strong>Status Breakdown:</strong>
                                <% @delivery_summary.each do |delivery| %>
                                  <div class="small mt-1">
                                    <span class="badge bg-<%= delivery[:status] == 'completed' ? 'success' : 'warning' %> me-2">
                                      <%= delivery[:status].titleize %>
                                    </span>
                                    <%= delivery[:count] %> orders, 
                                    <%= number_with_delimiter(delivery[:quantity]) %>L, 
                                    ₹<%= number_with_delimiter(delivery[:revenue]) %>
                                  </div>
                                <% end %>
                              </div>
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Utilization Analysis -->
                    <div class="col-lg-6 mb-4">
                      <div class="card bg-light border-0">
                        <div class="card-body">
                          <h6 class="card-title text-warning">📊 Utilization Metrics</h6>
                          <div class="calculation-breakdown">
                            <% 
                              utilization_rate = (@total_liters && @total_liters > 0) ? ((@total_delivered.to_f / @total_liters) * 100).round(2) : 0
                              wastage_quantity = (@total_liters || 0) - (@total_delivered || 0)
                              wastage_percentage = (@total_liters && @total_liters > 0) ? ((wastage_quantity.to_f / @total_liters) * 100).round(2) : 0
                              wastage_cost = (@total_liters && @total_liters > 0) ? (wastage_quantity * (@total_cost.to_f / @total_liters)).round(2) : 0
                            %>
                            
                            <div class="mb-3">
                              <strong>Utilization Rate:</strong> 
                              <span class="<%= utilization_rate > 80 ? 'text-success' : utilization_rate > 50 ? 'text-warning' : 'text-danger' %>">
                                <%= utilization_rate %>%
                              </span><br>
                              <small class="text-muted">Formula: (Delivered ÷ Procured) × 100</small><br>
                              <small class="text-muted">Calculation: (<%= @total_delivered %>L ÷ <%= @total_liters %>L) × 100 = <%= utilization_rate %>%</small>
                            </div>
                            
                            <div class="mb-3">
                              <strong>Wastage Analysis:</strong><br>
                              <span class="text-danger">
                                Quantity: <%= number_with_delimiter(wastage_quantity) %>L (<%= wastage_percentage %>%)
                              </span><br>
                              <span class="text-danger">
                                Cost Impact: ₹<%= number_with_delimiter(wastage_cost) %>
                              </span><br>
                              <small class="text-muted">Formula: Procured - Delivered = Wastage</small><br>
                              <small class="text-muted">Calculation: <%= @total_liters %>L - <%= @total_delivered %>L = <%= wastage_quantity %>L</small>
                            </div>

                            <div class="efficiency-score">
                              <% efficiency_score = case utilization_rate
                                   when 80..100 then "Excellent"
                                   when 60..79 then "Good" 
                                   when 40..59 then "Average"
                                   when 20..39 then "Poor"
                                   else "Critical"
                                   end
                                 efficiency_color = case utilization_rate
                                   when 80..100 then "success"
                                   when 60..79 then "info"
                                   when 40..59 then "warning" 
                                   when 20..39 then "danger"
                                   else "dark"
                                   end %>
                              <strong>Efficiency Score:</strong>
                              <span class="badge bg-<%= efficiency_color %> fs-6"><%= efficiency_score %></span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Profit/Loss Detailed Analysis -->
              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-primary fw-bold mb-3">
                    <i class="fas fa-chart-line me-2"></i>💹 Profit/Loss Detailed Analysis
                  </h6>
                  
                  <div class="row">
                    <!-- Financial Summary -->
                    <div class="col-lg-8 mb-4">
                      <div class="card border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        <div class="card-body">
                          <h6 class="card-title text-dark">🧮 Complete Financial Formula</h6>
                          
                          <div class="formula-breakdown bg-white p-3 rounded border">
                            <div class="row">
                              <div class="col-md-6">
                                <h6 class="text-info">📥 COSTS (Input)</h6>
                                <div class="mb-2">
                                  <strong>Total Procurement Cost:</strong><br>
                                  <code class="bg-light p-1 rounded">₹<%= number_with_delimiter(@total_cost || 0) %></code>
                                </div>
                                <small class="text-muted">
                                  Formula: Σ(Vendor Quantity × Buying Price)<br>
                                  <% if @vendor_summary&.any? %>
                                    <% @vendor_summary.each do |vendor| %>
                                      + <%= vendor[:name] %>: <%= number_with_delimiter(vendor[:quantity]) %>L × ₹90 = ₹<%= number_with_delimiter(vendor[:amount]) %><br>
                                    <% end %>
                                  <% end %>
                                </small>
                              </div>
                              
                              <div class="col-md-6">
                                <h6 class="text-success">📤 REVENUE (Output)</h6>
                                <div class="mb-2">
                                  <strong>Total Delivery Revenue:</strong><br>
                                  <code class="bg-light p-1 rounded">₹<%= number_with_delimiter(@total_revenue || 0) %></code>
                                </div>
                                <small class="text-muted">
                                  Formula: Σ(Delivered Quantity × Selling Price)<br>
                                  <%= @total_delivered %>L × ₹100 = ₹<%= number_with_delimiter(@total_revenue || 0) %>
                                </small>
                              </div>
                            </div>
                            
                            <hr class="my-3">
                            
                            <div class="text-center">
                              <h6 class="<%= (@total_profit || 0) >= 0 ? 'text-success' : 'text-danger' %>">
                                <i class="fas fa-<%= (@total_profit || 0) >= 0 ? 'arrow-up' : 'arrow-down' %> me-2"></i>
                                NET PROFIT/LOSS
                              </h6>
                              <div class="display-6 fw-bold <%= (@total_profit || 0) >= 0 ? 'text-success' : 'text-danger' %>">
                                ₹<%= number_with_delimiter((@total_profit || 0).abs) %> 
                                <small class="fs-6"><%= (@total_profit || 0) >= 0 ? 'PROFIT' : 'LOSS' %></small>
                              </div>
                              <div class="mt-2">
                                <code class="fs-6">Revenue - Cost = ₹<%= number_with_delimiter(@total_revenue || 0) %> - ₹<%= number_with_delimiter(@total_cost || 0) %> = ₹<%= number_with_delimiter(@total_profit || 0) %></code>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Additional Metrics -->
                          <div class="row mt-4">
                            <div class="col-md-4 text-center">
                              <div class="border rounded p-3">
                                <h6 class="text-muted">Profit Margin</h6>
                                <% profit_margin = (@total_revenue && @total_revenue > 0) ? (((@total_profit || 0).to_f / @total_revenue) * 100).round(2) : 0 %>
                                <div class="h4 <%= profit_margin >= 0 ? 'text-success' : 'text-danger' %>">
                                  <%= profit_margin %>%
                                </div>
                                <small class="text-muted">Profit ÷ Revenue × 100</small>
                              </div>
                            </div>
                            
                            <div class="col-md-4 text-center">
                              <div class="border rounded p-3">
                                <h6 class="text-muted">Cost Recovery</h6>
                                <% cost_recovery = (@total_cost && @total_cost > 0) ? ((@total_revenue.to_f / @total_cost) * 100).round(2) : 0 %>
                                <div class="h4 <%= cost_recovery >= 100 ? 'text-success' : 'text-danger' %>">
                                  <%= cost_recovery %>%
                                </div>
                                <small class="text-muted">Revenue ÷ Cost × 100</small>
                              </div>
                            </div>
                            
                            <div class="col-md-4 text-center">
                              <div class="border rounded p-3">
                                <h6 class="text-muted">Break-even Need</h6>
                                <% breakeven_liters = (@total_cost && @total_cost > 0) ? (@total_cost.to_f / 100).round(0) : 0 %>
                                <div class="h4 text-info">
                                  <%= number_with_delimiter(breakeven_liters) %>L
                                </div>
                                <small class="text-muted">Cost ÷ ₹100/L</small>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Optimization Recommendations -->
                    <div class="col-lg-4 mb-4">
                      <div class="card border-0 bg-warning bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title text-warning">💡 Optimization Insights</h6>
                          
                          <% if (@total_profit || 0) < 0 %>
                            <div class="alert alert-danger">
                              <strong>⚠️ LOSS SITUATION</strong><br>
                              Current loss: ₹<%= number_with_delimiter((@total_profit || 0).abs) %>
                            </div>
                            
                            <div class="recommendations">
                              <h6 class="small text-muted">IMMEDIATE ACTIONS:</h6>
                              <ul class="small">
                                <li>Reduce procurement to <%= breakeven_liters %>L (break-even)</li>
                                <li>Find <%= ((breakeven_liters - (@total_delivered || 0))).round(0) %>L more customers</li>
                                <li>Reduce wastage from <%= wastage_percentage %>% to <20%</li>
                                <li>Potential savings: ₹<%= number_with_delimiter((wastage_cost * 0.8).round(0)) %></li>
                              </ul>
                            </div>
                          <% else %>
                            <div class="alert alert-success">
                              <strong>✅ PROFITABLE</strong><br>
                              Keep up the good work!
                            </div>
                          <% end %>
                          
                          <div class="mt-3">
                            <h6 class="small text-muted">EFFICIENCY TARGETS:</h6>
                            <div class="progress mb-2">
                              <div class="progress-bar bg-success" style="width: <%= [utilization_rate, 100].min %>%"></div>
                            </div>
                            <small>Utilization: <%= utilization_rate %>% (Target: 80%+)</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
      <!-- Report Selection and Filters -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-0 shadow-sm">
            <div class="card-body py-3">
              <div class="row align-items-center">
                <!-- Report Type and Period filters removed as requested -->
                <div class="col-md-3" style="display: none;">
                  <select id="reportType" class="form-select" onchange="updateReportFilters()">
                    <option value="daily">Daily Procurement vs Delivery</option>
                    <option value="vendor">Vendor Performance Report</option>
                    <option value="profit">Profit/Loss Statement</option>
                    <option value="wastage">Milk Wastage Analysis</option>
                    <option value="monthly">Monthly Summary Report</option>
                  </select>
                </div>
                <div class="col-md-2" style="display: none;">
                  <select id="reportPeriod" class="form-select" onchange="updateDateFields()">
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="custom">Custom Range</option>
                  </select>
                </div>
                <div class="col-md-2 custom-date-fields d-none">
                  <label class="form-label mb-0 fw-bold text-muted">From:</label>
                  <input type="date" id="reportFromDate" class="form-control form-control-sm" value="<%= Date.current %>">
                </div>
                <div class="col-md-2 custom-date-fields d-none">
                  <label class="form-label mb-0 fw-bold text-muted">To:</label>
                  <input type="date" id="reportToDate" class="form-control form-control-sm" value="<%= Date.current %>">
                </div>
                <!-- Generate and Export buttons removed as requested -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Report Content Area -->
      <div id="reportContent">
        <!-- Daily Procurement vs Delivery Report -->
        <div id="dailyReport" class="report-section">
          <div class="row">
            <div class="col-12">
              <div class="card border-0 shadow-lg">
                <div class="card-header py-4">
                  <h5 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-comparison me-2"></i>Daily Calculations Report
                  </h5>
                  <p class="text-muted mb-0 small">Simple daily calculations for the selected date range</p>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover" id="dailyReportTable">
                      <thead class="table-light">
                        <tr>
                          <th>Date</th>
                          <th>Procured (L)</th>
                          <th>Cost (₹)</th>
                          <th>Delivered (L)</th>
                          <th>Revenue (₹)</th>
                          <th>Profit/Loss (₹)</th>
                          <th>Utilization %</th>
                          <th>Wastage (L)</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if @daily_calculations&.any? %>
                          <% @daily_calculations.each do |day| %>
                            <tr>
                              <td><%= day[:date].strftime('%b %d, %Y') %></td>
                              <td><%= number_with_delimiter(day[:procured]) %></td>
                              <td>₹<%= number_with_delimiter(day[:cost]) %></td>
                              <td><%= number_with_delimiter(day[:delivered]) %></td>
                              <td>₹<%= number_with_delimiter(day[:revenue]) %></td>
                              <td class="<%= day[:profit] >= 0 ? 'text-success' : 'text-danger' %>">
                                <%= day[:profit] >= 0 ? '+' : '' %>₹<%= number_with_delimiter(day[:profit]) %>
                              </td>
                              <td>
                                <span class="<%= day[:utilization] > 80 ? 'text-success' : day[:utilization] > 50 ? 'text-warning' : 'text-danger' %>">
                                  <%= day[:utilization] %>%
                                </span>
                              </td>
                              <td class="<%= day[:wastage] > 0 ? 'text-warning' : 'text-success' %>">
                                <%= number_with_delimiter(day[:wastage]) %>
                              </td>
                            </tr>
                          <% end %>
                        <% else %>
                          <tr>
                            <td colspan="8" class="text-center py-4">
                              <i class="fas fa-info-circle fa-2x mb-2 text-muted"></i><br>
                              <span class="text-muted">No data available for the selected date range</span>
                            </td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                  
                  <% if @daily_calculations&.any? %>
                    <!-- Summary Row -->
                    <div class="row mt-4">
                      <div class="col-12">
                        <div class="card bg-light">
                          <div class="card-body">
                            <h6 class="card-title">Summary for <%= @start_date.strftime('%b %d') %> - <%= @end_date.strftime('%b %d, %Y') %></h6>
                            <div class="row">
                              <div class="col-md-2">
                                <strong>Total Procured:</strong><br>
                                <%= number_with_delimiter(@daily_calculations.sum { |d| d[:procured] }) %> L
                              </div>
                              <div class="col-md-2">
                                <strong>Total Cost:</strong><br>
                                ₹<%= number_with_delimiter(@daily_calculations.sum { |d| d[:cost] }) %>
                              </div>
                              <div class="col-md-2">
                                <strong>Total Delivered:</strong><br>
                                <%= number_with_delimiter(@daily_calculations.sum { |d| d[:delivered] }) %> L
                              </div>
                              <div class="col-md-2">
                                <strong>Total Revenue:</strong><br>
                                ₹<%= number_with_delimiter(@daily_calculations.sum { |d| d[:revenue] }) %>
                              </div>
                              <div class="col-md-2">
                                <% total_profit = @daily_calculations.sum { |d| d[:profit] } %>
                                <strong>Net <%= total_profit >= 0 ? 'Profit' : 'Loss' %>:</strong><br>
                                <span class="<%= total_profit >= 0 ? 'text-success' : 'text-danger' %>">
                                  ₹<%= number_with_delimiter(total_profit.abs) %>
                                </span>
                              </div>
                              <div class="col-md-2">
                                <% total_procured = @daily_calculations.sum { |d| d[:procured] } %>
                                <% total_delivered = @daily_calculations.sum { |d| d[:delivered] } %>
                                <% avg_utilization = total_procured > 0 ? (total_delivered / total_procured * 100).round(1) : 0 %>
                                <strong>Avg Utilization:</strong><br>
                                <span class="<%= avg_utilization > 80 ? 'text-success' : avg_utilization > 50 ? 'text-warning' : 'text-danger' %>">
                                  <%= avg_utilization %>%
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vendor Performance Report -->
        <div id="vendorReport" class="report-section d-none">
          <div class="row">
            <div class="col-12">
              <div class="card border-0 shadow-lg">
                <div class="card-header py-4">
                  <h5 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-users me-2"></i>Vendor Performance Report
                  </h5>
                  <p class="text-muted mb-0 small">Analyze vendor reliability, quality, and profitability</p>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover" id="vendorReportTable">
                      <thead class="table-light">
                        <tr>
                          <th>Vendor Name</th>
                          <th>Total Orders</th>
                          <th>Completed</th>
                          <th>Reliability %</th>
                          <th>Avg Price (₹/L)</th>
                          <th>Total Quantity (L)</th>
                          <th>Total Cost (₹)</th>
                          <th>Total Profit (₹)</th>
                          <th>Performance Score</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td colspan="9" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>
                            <span class="text-muted">Click "Generate" to load vendor performance data</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Profit/Loss Statement -->
        <div id="profitReport" class="report-section d-none">
          <div class="row">
            <!-- Summary Cards -->
            <div class="col-lg-3 col-md-6 mb-4">
              <div class="card border-0 shadow-lg h-100 gradient-info">
                <div class="card-body p-4 text-center">
                  <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                    <i class="fas fa-shopping-cart fa-2x text-white"></i>
                  </div>
                  <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                    Total Procurement Cost
                  </div>
                  <div class="h4 mb-0 font-weight-bold text-white" id="totalProcurementCost">
                    ₹0
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
              <div class="card border-0 shadow-lg h-100 gradient-success">
                <div class="card-body p-4 text-center">
                  <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                    <i class="fas fa-rupee-sign fa-2x text-white"></i>
                  </div>
                  <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                    Total Revenue
                  </div>
                  <div class="h4 mb-0 font-weight-bold text-white" id="totalRevenue">
                    ₹0
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
              <div class="card border-0 shadow-lg h-100 gradient-warning">
                <div class="card-body p-4 text-center">
                  <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                    <i class="fas fa-chart-line fa-2x text-white"></i>
                  </div>
                  <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                    Gross Profit
                  </div>
                  <div class="h4 mb-0 font-weight-bold text-white" id="grossProfit">
                    ₹0
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
              <div class="card border-0 shadow-lg h-100 gradient-primary">
                <div class="card-body p-4 text-center">
                  <div class="icon-circle-lg bg-white bg-opacity-25 mx-auto mb-3">
                    <i class="fas fa-percentage fa-2x text-white"></i>
                  </div>
                  <div class="text-xs font-weight-bold text-white text-uppercase mb-2 opacity-90">
                    Profit Margin
                  </div>
                  <div class="h4 mb-0 font-weight-bold text-white" id="profitMargin">
                    0%
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Detailed P&L Table -->
          <div class="row">
            <div class="col-12">
              <div class="card border-0 shadow-lg">
                <div class="card-header py-4">
                  <h5 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calculator me-2"></i>Detailed Profit & Loss Statement
                  </h5>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover" id="profitLossTable">
                      <thead class="table-light">
                        <tr>
                          <th>Period</th>
                          <th>Procurement Cost (₹)</th>
                          <th>Delivery Revenue (₹)</th>
                          <th>Gross Profit (₹)</th>
                          <th>Wastage Loss (₹)</th>
                          <th>Net Profit (₹)</th>
                          <th>Margin %</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td colspan="7" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>
                            <span class="text-muted">Click "Generate" to load profit/loss data</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Wastage Analysis -->
        <div id="wastageReport" class="report-section d-none">
          <div class="row">
            <div class="col-12">
              <div class="card border-0 shadow-lg">
                <div class="card-header py-4">
                  <h5 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-exclamation-triangle me-2"></i>Milk Wastage Analysis
                  </h5>
                  <p class="text-muted mb-0 small">Track milk wastage and identify improvement opportunities</p>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover" id="wastageReportTable">
                      <thead class="table-light">
                        <tr>
                          <th>Date</th>
                          <th>Procured (L)</th>
                          <th>Delivered (L)</th>
                          <th>Wasted (L)</th>
                          <th>Wastage %</th>
                          <th>Wastage Cost (₹)</th>
                          <th>Reason</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td colspan="7" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>
                            <span class="text-muted">Click "Generate" to load wastage analysis</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Monthly Summary -->
        <div id="monthlyReport" class="report-section d-none">
          <div class="row">
            <div class="col-12">
              <div class="card border-0 shadow-lg">
                <div class="card-header py-4">
                  <h5 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calendar-check me-2"></i>Monthly Summary Report
                  </h5>
                  <p class="text-muted mb-0 small">Comprehensive monthly overview of procurement operations</p>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover" id="monthlyReportTable">
                      <thead class="table-light">
                        <tr>
                          <th>Month</th>
                          <th>Total Vendors</th>
                          <th>Procurement (L)</th>
                          <th>Deliveries (L)</th>
                          <th>Utilization %</th>
                          <th>Cost (₹)</th>
                          <th>Revenue (₹)</th>
                          <th>Profit (₹)</th>
                          <th>Growth %</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td colspan="9" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>
                            <span class="text-muted">Click "Generate" to load monthly summary</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Procurement Tab -->
    <div class="tab-pane fade" id="procurement" role="tabpanel" aria-labelledby="procurement-tab">
      <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-10">
          <div class="card border-0 shadow-lg">
            <div class="card-header py-4">
              <h5 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-plus-circle me-2"></i>Create New Procurement Schedule
              </h5>
              <p class="text-muted mb-0 small">Set up daily milk procurement from vendors</p>
            </div>
            
            <div class="card-body">
              <%= form_with model: ProcurementSchedule.new, url: procurement_schedules_path, local: true, class: "row g-3" do |form| %>
                <!-- Product Selection (PROMINENTLY DISPLAYED) -->
                <div class="col-12 mb-4">
                  <div class="alert alert-info border-0">
                    <h6 class="alert-heading">
                      <i class="fas fa-box text-primary me-2"></i>Product Selection
                    </h6>
                    <%= form.label :product_id, "Select Product", class: "form-label fw-bold" %>
                    
                    <!-- Search Input for Product -->
                    <div class="position-relative mb-2">
                      <input type="text" id="product-search" class="form-control form-control-lg" 
                             placeholder="🔍 Start typing to search products (e.g., 'milk', 'butter')..." 
                             autocomplete="off">
                      <div id="product-search-results" class="position-absolute w-100" style="z-index: 1000; display: none; max-height: 300px; overflow-y: auto;">
                        <!-- Search results will be populated here -->
                      </div>
                    </div>
                    
                    <!-- Hidden select for form submission -->
                    <%= form.hidden_field :product_id, id: "selected-product-id" %>
                    
                    <!-- Selected Product Display -->
                    <div id="selected-product-display" class="alert alert-success" style="display: none;">
                      <div class="d-flex justify-content-between align-items-center">
                        <div id="selected-product-info">
                          <!-- Product info will be displayed here -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearProductSelection()">
                          <i class="fas fa-times"></i> Change
                        </button>
                      </div>
                    </div>
                    
                    <!-- Product Dropdown (fallback) -->
                    <div id="product-dropdown-container">
                      <%= form.select :product_id, 
                          options_from_collection_for_select(Product.all, :id, 
                            ->(product) { "#{product.name} (#{product.unit_type}) - ₹#{product.price}" }),
                          { prompt: "🔍 Or select from dropdown (#{Product.count} available products)" },
                          { class: "form-select form-select-lg", id: "product-dropdown" } %>
                    </div>
                    
                    <div class="form-text mt-2">
                      <i class="fas fa-lightbulb text-warning me-1"></i>
                      <strong>Selecting a product will automatically set the unit type and suggested pricing.</strong>
                    </div>
                  </div>
                </div>

                <!-- Vendor Information -->
                <div class="col-md-6">
                  <%= form.label :vendor_name, "Vendor/Farm Name", class: "form-label fw-bold" %>
                  <%= form.text_field :vendor_name, 
                      class: "form-control",
                      placeholder: "e.g., Nandi Milk Goshala",
                      required: true %>
                  <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>Name of the farm or milk vendor
                  </div>
                </div>

                <div class="col-md-6">
                  <%= form.label :unit, "Unit of Measurement", class: "form-label fw-bold" %>
                  <%= form.select :unit, 
                      options_for_select([
                        ['Liters', 'liters'],
                        ['Gallons', 'gallons']
                      ], 'liters'), 
                      {}, { class: "form-select", required: true } %>
                </div>

                <!-- Date Range -->
                <div class="col-md-6">
                  <%= form.label :from_date, "From Date", class: "form-label fw-bold" %>
                  <%= form.date_field :from_date, class: "form-control", required: true, 
                      value: Date.current %>
                </div>

                <div class="col-md-6">
                  <%= form.label :to_date, "To Date", class: "form-label fw-bold" %>
                  <%= form.date_field :to_date, class: "form-control", required: true,
                      value: Date.current + 30.days %>
                </div>

                <!-- Quantities and Pricing -->
                <div class="col-md-4">
                  <%= form.label :quantity, "Daily Quantity", class: "form-label fw-bold" %>
                  <%= form.number_field :quantity, 
                      class: "form-control",
                      placeholder: "100.00",
                      step: 0.01,
                      min: 0.01,
                      required: true %>
                  <div class="form-text">Liters per day</div>
                </div>

                <div class="col-md-4">
                  <%= form.label :buying_price, "Buying Price (₹/L)", class: "form-label fw-bold" %>
                  <%= form.number_field :buying_price, 
                      class: "form-control",
                      placeholder: "90.00",
                      step: 0.01,
                      min: 0.01,
                      required: true %>
                  <div class="form-text">Cost per liter</div>
                </div>

                <div class="col-md-4">
                  <%= form.label :selling_price, "Selling Price (₹/L)", class: "form-label fw-bold" %>
                  <%= form.number_field :selling_price, 
                      class: "form-control",
                      placeholder: "100.00",
                      step: 0.01,
                      min: 0.01,
                      required: true %>
                  <div class="form-text">Price per liter to customers</div>
                </div>

                <!-- Additional Information -->
                <div class="col-12">
                  <%= form.label :notes, "Notes (Optional)", class: "form-label fw-bold" %>
                  <%= form.text_area :notes, class: "form-control", rows: 3,
                      placeholder: "Any additional notes about this procurement schedule..." %>
                </div>

                <!-- Submit Buttons -->
                <div class="col-12">
                  <div class="d-flex gap-2">
                    <%= form.submit "Create Procurement Schedule", class: "btn btn-primary btn-lg" %>
                    <button type="button" class="btn btn-secondary btn-lg" onclick="resetProcurementForm()">
                      Reset Form
                    </button>
                  </div>
                </div>
              <% end %>

              <!-- Info Box -->
              <div class="alert alert-info mt-4">
                <i class="fas fa-lightbulb me-2"></i>
                <strong>How it works:</strong> When you create a procurement schedule, the system will automatically generate daily procurement assignments for each day in the date range. Each assignment will have the planned quantity and prices you specify.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Procurement Calendar Tab -->
    <div class="tab-pane fade show active" id="calendar" role="tabpanel" aria-labelledby="calendar-tab">
      <div class="card border-0 shadow-lg">
        <!-- Card header removed to prevent duplicate heading -->
        
        <div class="card-body p-0" id="calendarContent">
          <!-- Calendar will be loaded here dynamically -->
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
              <span class="visually-hidden">Loading...</span>
            </div>
            <h4 class="mt-3">Loading Procurement Calendar...</h4>
            <p class="text-muted">Please wait while we load your calendar</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Custom Styles -->
<style>
/* Product Dropdown Styling */
#product-dropdown {
  border: 3px solid #4e73df !important;
  font-size: 1.1rem;
  font-weight: 600;
  background-color: #f8f9fc;
}

#product-dropdown:focus {
  border-color: #2e59d9 !important;
  box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25) !important;
}

.alert-info {
  background: linear-gradient(135deg, rgba(78, 115, 223, 0.1) 0%, rgba(78, 115, 223, 0.05) 100%);
  border: 2px solid rgba(78, 115, 223, 0.3);
}

/* Tab Pills Styling */
.nav-pills .nav-link {
  border-radius: 0.5rem;
  padding: 1rem 1.5rem;
  margin: 0 0.25rem;
  font-weight: 600;
  color: #6c757d;
  background: transparent;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.nav-pills .nav-link:hover {
  background: rgba(108, 117, 125, 0.1);
  color: #495057;
}

.nav-pills .nav-link.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-color: #667eea;
  transform: translateY(-2px);
  box-shadow: 0 0.5rem 1rem rgba(102, 126, 234, 0.25);
}

/* Gradient Card Styles */
.gradient-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.gradient-info {
  background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
}

.gradient-warning {
  background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
}

.gradient-success {
  background: linear-gradient(135deg, #55a3ff 0%, #003d82 100%);
}

.gradient-danger {
  background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
}

/* Icon Circle */
.icon-circle-lg {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Form Enhancements */
.form-control:focus,
.form-select:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

/* Table Styling */
.table-hover tbody tr:hover {
  background-color: rgba(102, 126, 234, 0.05);
}

/* Custom Date Fields Toggle */
.custom-dates {
  transition: all 0.3s ease;
}

.custom-dates.show {
  display: flex !important;
}

/* Product Search Enhancements */
#product-search {
  border: 3px solid #4e73df !important;
  font-size: 1.1rem;
  font-weight: 600;
}
#product-search-results {
  background: #fff;
  border-radius: 0.5rem;
  margin-top: 0.25rem;
}
.product-option {
  cursor: pointer;
  transition: all 0.2s ease;
}
.product-option:hover {
  background-color: rgba(78, 115, 223, 0.05);
  transform: translateX(2px);
}
#selected-product-display {
  border: 2px solid #28a745;
  background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
}
</style>

<!-- JavaScript for Tab and Form Functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize date range selector
  const dateRangeSelect = document.querySelector('select[name="date_range"]');
  if (dateRangeSelect) {
    toggleCustomDates();
  }
  
  // Initialize product search functionality
  initializeProductSearch();
});

function toggleCustomDates() {
  const dateRangeSelect = document.querySelector('select[name="date_range"]');
  const customDates = document.querySelector('.custom-dates');
  
  if (dateRangeSelect && customDates) {
    if (dateRangeSelect.value === 'custom') {
      customDates.classList.remove('d-none');
      customDates.classList.add('show');
    } else {
      customDates.classList.add('d-none');
      customDates.classList.remove('show');
    }
  }
}

function resetProcurementForm() {
  const form = document.querySelector('#procurement form');
  if (form) {
    form.reset();
    // Reset product selection
    clearProductSelection();
    // Reset to default values
    document.querySelector('#procurement_schedule_from_date').value = '<%= Date.current %>';
    document.querySelector('#procurement_schedule_to_date').value = '<%= Date.current + 30.days %>';
  }
}

// Product Search Functionality
let productSearchTimeout;
let availableProducts = [
  <% Product.all.each_with_index do |product, index| %>
    {
      id: <%= product.id %>,
      name: "<%= product.name.gsub('"', '\\"') %>",
      unit_type: "<%= product.unit_type %>",
      price: "<%= product.price %>",
      available_quantity: "<%= product.available_quantity %>",
      description: "<%= product.description&.gsub('"', '\\"') %>",
      category: "<%= product.category_name.gsub('"', '\\"') %>"
    }<%= index < Product.all.count - 1 ? ',' : '' %>
  <% end %>
];

function initializeProductSearch() {
  const searchInput = document.getElementById('product-search');
  const resultsContainer = document.getElementById('product-search-results');
  const selectedDisplay = document.getElementById('selected-product-display');
  const selectedInfo = document.getElementById('selected-product-info');
  const selectedProductId = document.getElementById('selected-product-id');
  const dropdownContainer = document.getElementById('product-dropdown-container');
  const originalDropdown = document.getElementById('product-dropdown');

  if (!searchInput) return;

  // Handle search input
  searchInput.addEventListener('input', function() {
    clearTimeout(productSearchTimeout);
    const query = this.value.trim().toLowerCase();
    
    if (query.length < 2) {
      resultsContainer.style.display = 'none';
      return;
    }

    productSearchTimeout = setTimeout(() => {
      searchProducts(query);
    }, 300);
  });

  // Handle dropdown selection as fallback
  if (originalDropdown) {
    originalDropdown.addEventListener('change', function() {
      if (this.value) {
        const product = availableProducts.find(p => p.id == this.value);
        if (product) {
          selectProduct(product);
        }
      }
    });
  }

  // Hide results when clicking outside
  document.addEventListener('click', function(event) {
    if (!searchInput.contains(event.target) && !resultsContainer.contains(event.target)) {
      resultsContainer.style.display = 'none';
    }
  });
}

function searchProducts(query) {
  const resultsContainer = document.getElementById('product-search-results');
  
  const filteredProducts = availableProducts.filter(product => 
    product.name.toLowerCase().includes(query) ||
    product.description.toLowerCase().includes(query) ||
    product.category.toLowerCase().includes(query) ||
    product.unit_type.toLowerCase().includes(query)
  );

  if (filteredProducts.length === 0) {
    resultsContainer.innerHTML = `
      <div class="card shadow-sm">
        <div class="card-body text-center py-4">
          <i class="fas fa-search fa-2x text-muted mb-2"></i>
          <p class="mb-0 text-muted">No products found for "${query}"</p>
        </div>
      </div>
    `;
  } else {
    resultsContainer.innerHTML = `
      <div class="card shadow-lg border-primary">
        <div class="card-header bg-primary text-white py-2">
          <small><i class="fas fa-search me-1"></i>Found ${filteredProducts.length} product(s)</small>
        </div>
        <div class="list-group list-group-flush">
          ${filteredProducts.map(product => `
            <div class="list-group-item list-group-item-action cursor-pointer product-option" 
                 onclick="selectProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <h6 class="mb-1 text-primary">${product.name}</h6>
                  <p class="mb-1 small text-muted">${product.description || 'No description'}</p>
                  <div class="d-flex gap-3">
                    <small class="text-success"><i class="fas fa-tag me-1"></i>₹${product.price}/${product.unit_type}</small>
                    <small class="text-info"><i class="fas fa-box me-1"></i>${product.available_quantity} ${product.unit_type}</small>
                    <small class="text-warning"><i class="fas fa-folder me-1"></i>${product.category}</small>
                  </div>
                </div>
                <div class="text-end">
                  <span class="badge bg-success">Available</span>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  resultsContainer.style.display = 'block';
}

function selectProduct(product) {
  const searchInput = document.getElementById('product-search');
  const resultsContainer = document.getElementById('product-search-results');
  const selectedDisplay = document.getElementById('selected-product-display');
  const selectedInfo = document.getElementById('selected-product-info');
  const selectedProductId = document.getElementById('selected-product-id');
  const dropdownContainer = document.getElementById('product-dropdown-container');

  // Update hidden field
  selectedProductId.value = product.id;

  // Update search input
  searchInput.value = product.name;

  // Show selected product info
  selectedInfo.innerHTML = `
    <div>
      <h6 class="mb-1 text-success">✓ Selected: ${product.name}</h6>
      <div class="d-flex gap-3 small">
        <span class="text-muted"><i class="fas fa-tag me-1"></i>Price: ₹${product.price}/${product.unit_type}</span>
        <span class="text-muted"><i class="fas fa-box me-1"></i>Available: ${product.available_quantity} ${product.unit_type}</span>
        <span class="text-muted"><i class="fas fa-folder me-1"></i>Category: ${product.category}</span>
      </div>
    </div>
  `;

  // Auto-fill form fields based on product selection
  const unitSelect = document.querySelector('select[name="procurement_schedule[unit]"]');
  const sellingPriceInput = document.querySelector('input[name="procurement_schedule[selling_price]"]');

  if (unitSelect) {
    // Set unit based on product unit type
    const unitMapping = {
      'liters': 'liters',
      'gallons': 'gallons', 
      'kg': 'kg',
      'pounds': 'pounds'
    };
    unitSelect.value = unitMapping[product.unit_type] || 'liters';
  }

  if (sellingPriceInput && !sellingPriceInput.value) {
    // Suggest selling price (add 10% margin to product price)
    sellingPriceInput.value = (parseFloat(product.price) * 1.1).toFixed(2);
  }

  // Hide elements
  resultsContainer.style.display = 'none';
  selectedDisplay.style.display = 'block';
  dropdownContainer.style.display = 'none';

  // Trigger form validation/calculation updates if available
  if (typeof updateCalculationPreview === 'function') {
    updateCalculationPreview();
  }
}

function clearProductSelection() {
  const searchInput = document.getElementById('product-search');
  const selectedDisplay = document.getElementById('selected-product-display');
  const selectedProductId = document.getElementById('selected-product-id');
  const dropdownContainer = document.getElementById('product-dropdown-container');
  const originalDropdown = document.getElementById('product-dropdown');

  // Clear values
  searchInput.value = '';
  selectedProductId.value = '';
  if (originalDropdown) originalDropdown.value = '';

  // Reset display
  selectedDisplay.style.display = 'none';
  dropdownContainer.style.display = 'block';

  // Focus back to search
  searchInput.focus();
}

// Calendar Navigation Functions
let currentCalendarDate = new Date();

function previousMonth() {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
  loadCalendarData();
}

function nextMonth() {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
  loadCalendarData();
}

function goToToday() {
  currentCalendarDate = new Date();
  loadCalendarData();
}

function loadCalendarData() {
  console.log('loadCalendarData called');
  const calendarContainer = document.getElementById('calendarContent');
  
  if (!calendarContainer) {
    console.error('calendarContent element not found');
    return;
  }

  console.log('Calendar container found, showing loading state');

  // Show loading state
  calendarContainer.innerHTML = `
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h4 class="mt-3">Loading Procurement Calendar...</h4>
      <p class="text-muted">Please wait while we load your calendar</p>
    </div>
  `;

  // Format date for API call
  const dateStr = currentCalendarDate ? currentCalendarDate.toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
  const url = `/milk-supply-analytics/calendar_view?date=${dateStr}&view_type=month`;
  
  console.log('Fetching calendar data from:', url);
  
  // Fetch calendar data from our modern calendar view
  fetch(url, {
    method: 'GET',
    headers: {
      'Accept': 'text/html',
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
    }
  })
  .then(response => {
    console.log('Response status:', response.status);
    console.log('Response headers:', response.headers);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.text();
  })
  .then(html => {
    console.log('HTML response length:', html.length);
    
    // Create a temporary container to parse the response
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    
    // Extract the calendar content (everything inside the main container)
    const calendarContent = tempDiv.querySelector('.container-fluid');
    if (calendarContent) {
      console.log('Calendar content found, updating container');
      calendarContainer.innerHTML = calendarContent.innerHTML;
      
      // Initialize any JavaScript functionality after loading
      initializeCalendarFeatures();
    } else {
      console.error('Calendar content not found in response');
      // Try to show the entire response for debugging
      calendarContainer.innerHTML = html;
    }
  })
  .catch(error => {
    console.error('Error loading calendar:', error);
    calendarContainer.innerHTML = `
      <div class="text-center py-5">
        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
        <h4>Error Loading Calendar</h4>
        <p class="text-muted">Failed to load calendar data. Please try refreshing the page or try again.</p>
        <div class="mt-3">
          <button class="btn btn-primary me-2" onclick="loadCalendarData()">
            <i class="fas fa-refresh me-1"></i>Retry
          </button>
          <button class="btn btn-outline-secondary" onclick="window.location.reload()">
            <i class="fas fa-sync-alt me-1"></i>Refresh Page
          </button>
          <button class="btn btn-outline-info" onclick="window.open('/milk-supply-analytics/calendar_view', '_blank')">
            <i class="fas fa-external-link-alt me-1"></i>Open in New Tab
          </button>
        </div>
        <small class="text-muted d-block mt-2">Error: ${error.message}</small>
        <small class="text-muted d-block">URL: /milk-supply-analytics/calendar_view?date=${dateStr}&view_type=month</small>
      </div>
    `;
  });
}

// Initialize calendar features after dynamic loading
function initializeCalendarFeatures() {
  // Initialize Bootstrap tooltips
  if (typeof bootstrap !== 'undefined') {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  }
  
  // Re-attach event listeners for editable fields
  document.querySelectorAll('.editable-field').forEach(field => {
    field.addEventListener('click', function() {
      const assignmentId = this.dataset.assignmentId;
      const fieldName = this.dataset.field;
      quickEditField(assignmentId, fieldName);
    });
  });
}

// Helper function for inline editing (if not already defined in calendar view)
function quickEditField(assignmentId, fieldName) {
  const fieldElement = document.querySelector(`[data-assignment-id="${assignmentId}"] [data-field="${fieldName}"]`);
  if (!fieldElement) return;
  
  const currentValue = fieldElement.textContent.replace('L', '').replace('Click to add', '').trim();
  
  // Create inline input
  const input = document.createElement('input');
  input.type = fieldName === 'actual_quantity' ? 'number' : 'text';
  input.value = currentValue;
  input.className = 'form-control form-control-sm';
  input.style.width = '80px';
  input.style.display = 'inline-block';
  
  // Replace content with input
  const originalContent = fieldElement.innerHTML;
  fieldElement.innerHTML = '';
  fieldElement.appendChild(input);
  input.focus();
  input.select();
  
  // Handle save/cancel
  function saveField() {
    const newValue = input.value;
    if (newValue !== currentValue) {
      const data = {};
      data[fieldName] = parseFloat(newValue) || newValue;
      
      // Update via API
      fetch(`/milk-assignments/${assignmentId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ procurement_assignment: data })
      })
      .then(response => {
        if (response.ok) {
          fieldElement.innerHTML = newValue ? `${newValue}L` : '<span class="text-muted">Click to add</span>';
          showToast('Assignment updated successfully!', 'success');
        } else {
          throw new Error('Update failed');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        fieldElement.innerHTML = originalContent;
        showToast('Error updating assignment', 'error');
      });
    } else {
      fieldElement.innerHTML = originalContent;
    }
  }
  
  function cancelEdit() {
    fieldElement.innerHTML = originalContent;
  }
  
  input.addEventListener('blur', saveField);
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      saveField();
    } else if (e.key === 'Escape') {
      cancelEdit();
    }
  });
}

// Toast notification helper
function showToast(message, type = 'info') {
  // Simple toast notification
  const toastHtml = `
    <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0" style="position: fixed; top: 20px; right: 20px; z-index: 1050;">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', toastHtml);
  
  const toastElement = document.body.lastElementChild;
  if (typeof bootstrap !== 'undefined') {
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', () => {
      toastElement.remove();
    });
  } else {
    setTimeout(() => {
      toastElement.remove();
    }, 3000);
  }
}

// Fallback function to load calendar via iframe
function loadCalendarFallback() {
  console.log('Loading calendar via iframe fallback');
  const calendarContainer = document.getElementById('calendarContent');
  if (!calendarContainer) return;

  calendarContainer.innerHTML = `
    <div class="text-center py-3 mb-3">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading calendar...</span>
      </div>
      <p class="mt-2 text-muted">Loading calendar in frame...</p>
    </div>
  `;

  // Create iframe to load calendar with loading handling
  setTimeout(() => {
    calendarContainer.innerHTML = `
      <div class="position-relative" style="min-height: 800px;">
        <iframe src="/milk-supply-analytics/calendar_view" 
                width="100%" 
                height="800" 
                frameborder="0" 
                style="border: none; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
                onload="console.log('Calendar iframe loaded successfully')"
                onerror="console.error('Calendar iframe failed to load')">
          <p>Your browser does not support iframes. <a href="/milk-supply-analytics/calendar_view" target="_blank">Click here to open the calendar</a></p>
        </iframe>
      </div>
    `;
  }, 500);
}

// Manual calendar load function for testing
function loadCalendarManual() {
  console.log('Manual calendar load triggered');
  const calendarContainer = document.getElementById('calendarContent');
  if (!calendarContainer) {
    console.error('Calendar container not found');
    return;
  }

  // Direct navigation approach
  window.location.href = '/milk-supply-analytics/calendar_view';
}

// Auto-submit form when date range changes (except custom)
document.addEventListener('change', function(e) {
  if (e.target.name === 'date_range' && e.target.value !== 'custom') {
    e.target.closest('form').submit();
  }
});

// Reports Tab Functionality
function updateReportFilters() {
  const reportType = document.getElementById('reportType').value;
  
  // Hide all report sections
  document.querySelectorAll('.report-section').forEach(section => {
    section.classList.add('d-none');
  });
  
  // Show selected report section
  const sectionMap = {
    'daily': 'dailyReport',
    'vendor': 'vendorReport', 
    'profit': 'profitReport',
    'wastage': 'wastageReport',
    'monthly': 'monthlyReport'
  };
  
  const targetSection = document.getElementById(sectionMap[reportType]);
  if (targetSection) {
    targetSection.classList.remove('d-none');
  }
}

function updateDateFields() {
  const period = document.getElementById('reportPeriod').value;
  const customFields = document.querySelectorAll('.custom-date-fields');
  
  if (period === 'custom') {
    customFields.forEach(field => field.classList.remove('d-none'));
  } else {
    customFields.forEach(field => field.classList.add('d-none'));
  }
}

function generateReport() {
  const reportType = document.getElementById('reportType').value;
  const period = document.getElementById('reportPeriod').value;
  let fromDate, toDate;
  
  // Calculate date range based on period
  const today = new Date();
  switch(period) {
    case 'today':
      fromDate = toDate = today.toISOString().split('T')[0];
      break;
    case 'week':
      const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
      fromDate = weekStart.toISOString().split('T')[0];
      toDate = new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      break;
    case 'month':
      fromDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
      toDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
      break;
    case 'custom':
      fromDate = document.getElementById('reportFromDate').value;
      toDate = document.getElementById('reportToDate').value;
      break;
  }
  
  if (!fromDate || !toDate) {
    alert('Please select valid dates');
    return;
  }
  
  // Show loading state
  showReportLoading(reportType);
  
  // Make API call to generate report
  const url = `/milk-supply-analytics/generate_reports?report_type=${getReportTypeParam(reportType)}&from_date=${fromDate}&to_date=${toDate}`;
  
  fetch(url, {
    method: 'GET',
    headers: {
      'Accept': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      populateReportData(reportType, data.data);
      // Show success message
      if (data.message) {
        showReportSuccess(data.message);
      }
    } else {
      throw new Error(data.error || 'Unknown error');
    }
  })
  .catch(error => {
    console.error('Error generating report:', error);
    showReportError(reportType, error.message);
  });
}

function getReportTypeParam(reportType) {
  const paramMap = {
    'daily': 'daily_procurement_delivery',
    'vendor': 'vendor_performance',
    'profit': 'profit_loss',
    'wastage': 'wastage_analysis',
    'monthly': 'monthly_summary'
  };
  return paramMap[reportType];
}

function showReportLoading(reportType) {
  const tableMap = {
    'daily': 'dailyReportTable',
    'vendor': 'vendorReportTable',
    'profit': 'profitLossTable',
    'wastage': 'wastageReportTable',
    'monthly': 'monthlyReportTable'
  };
  
  const table = document.getElementById(tableMap[reportType]);
  if (table) {
    const tbody = table.getElementsByTagName('tbody')[0];
    tbody.innerHTML = `
      <tr>
        <td colspan="10" class="text-center py-4">
          <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>
          <span class="text-muted">Generating report...</span>
        </td>
      </tr>
    `;
  }
}

function showReportError(reportType, errorMessage = 'Error generating report. Please try again.') {
  const tableMap = {
    'daily': 'dailyReportTable',
    'vendor': 'vendorReportTable', 
    'profit': 'profitLossTable',
    'wastage': 'wastageReportTable',
    'monthly': 'monthlyReportTable'
  };
  
  const table = document.getElementById(tableMap[reportType]);
  if (table) {
    const tbody = table.getElementsByTagName('tbody')[0];
    tbody.innerHTML = `
      <tr>
        <td colspan="10" class="text-center py-4">
          <i class="fas fa-exclamation-triangle fa-2x mb-2 text-danger"></i><br>
          <span class="text-danger">${errorMessage}</span>
        </td>
      </tr>
    `;
  }
}

function showReportSuccess(message) {
  // Create a toast notification for success
  const toast = document.createElement('div');
  toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 1055;';
  toast.setAttribute('role', 'alert');
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">
        <i class="fas fa-check-circle me-2"></i>${message}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // Initialize and show the toast
  const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
  bsToast.show();
  
  // Remove from DOM after it's hidden
  toast.addEventListener('hidden.bs.toast', function() {
    toast.remove();
  });
}

function populateReportData(reportType, data) {
  switch(reportType) {
    case 'daily':
      populateDailyReport(data);
      break;
    case 'vendor':
      populateVendorReport(data);
      break;
    case 'profit':
      populateProfitReport(data);
      break;
    case 'wastage':
      populateWastageReport(data);
      break;
    case 'monthly':
      populateMonthlyReport(data);
      break;
  }
}

function populateDailyReport(data) {
  const tbody = document.querySelector('#dailyReportTable tbody');
  if (!data || data.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="10" class="text-center py-4">
          <i class="fas fa-info-circle fa-2x mb-2 text-info"></i><br>
          <span class="text-muted">No data available for the selected period</span>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  data.forEach(row => {
    const utilizationClass = row.utilization_rate > 80 ? 'text-success' : row.utilization_rate > 60 ? 'text-warning' : 'text-danger';
    const profitClass = row.profit >= 0 ? 'text-success' : 'text-danger';
    
    html += `
      <tr>
        <td>${row.date}</td>
        <td>-</td>
        <td>-</td>
        <td>${row.procurement_liters.toFixed(2)}</td>
        <td>${row.delivery_liters.toFixed(2)}</td>
        <td>${row.wastage_liters.toFixed(2)}</td>
        <td><span class="${utilizationClass}">${row.utilization_rate}%</span></td>
        <td>₹${row.procurement_cost.toFixed(2)}</td>
        <td>₹${row.delivery_revenue.toFixed(2)}</td>
        <td><span class="${profitClass}">₹${row.profit.toFixed(2)}</span></td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function populateVendorReport(data) {
  const tbody = document.querySelector('#vendorReportTable tbody');
  if (!data || data.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="text-center py-4">
          <i class="fas fa-info-circle fa-2x mb-2 text-info"></i><br>
          <span class="text-muted">No vendor data available for the selected period</span>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  data.forEach(vendor => {
    const reliabilityClass = vendor.reliability_percentage > 80 ? 'text-success' : vendor.reliability_percentage > 60 ? 'text-warning' : 'text-danger';
    const scoreClass = vendor.performance_score > 80 ? 'text-success' : vendor.performance_score > 60 ? 'text-warning' : 'text-danger';
    
    html += `
      <tr>
        <td><strong>${vendor.vendor_name}</strong></td>
        <td>${vendor.total_assignments}</td>
        <td>${vendor.completed_assignments}</td>
        <td><span class="${reliabilityClass}">${vendor.reliability_percentage}%</span></td>
        <td>₹${vendor.average_price}</td>
        <td>${vendor.total_quantity.toFixed(2)} L</td>
        <td>₹${vendor.total_cost.toFixed(2)}</td>
        <td>₹${vendor.total_cost.toFixed(2)}</td>
        <td><span class="${scoreClass}">${vendor.performance_score}%</span></td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function populateProfitReport(data) {
  // Update summary cards
  document.getElementById('totalProcurementCost').textContent = `₹${data.summary.total_cost.toFixed(2)}`;
  document.getElementById('totalRevenue').textContent = `₹${data.summary.total_revenue.toFixed(2)}`;
  document.getElementById('grossProfit').textContent = `₹${data.summary.gross_profit.toFixed(2)}`;
  document.getElementById('profitMargin').textContent = `${data.summary.profit_margin}%`;
  
  // Update table
  const tbody = document.querySelector('#profitLossTable tbody');
  if (!data.daily_breakdown || data.daily_breakdown.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center py-4">
          <i class="fas fa-info-circle fa-2x mb-2 text-info"></i><br>
          <span class="text-muted">No profit/loss data available for the selected period</span>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  data.daily_breakdown.forEach(day => {
    const profitClass = day.profit >= 0 ? 'text-success' : 'text-danger';
    const margin = day.revenue > 0 ? ((day.profit / day.revenue) * 100).toFixed(2) : 0;
    
    html += `
      <tr>
        <td>${day.date}</td>
        <td>₹${day.cost.toFixed(2)}</td>
        <td>₹${day.revenue.toFixed(2)}</td>
        <td><span class="${profitClass}">₹${day.profit.toFixed(2)}</span></td>
        <td>₹0.00</td>
        <td><span class="${profitClass}">₹${day.profit.toFixed(2)}</span></td>
        <td>${margin}%</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function populateWastageReport(data) {
  const tbody = document.querySelector('#wastageReportTable tbody');
  if (!data.daily_data || data.daily_data.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center py-4">
          <i class="fas fa-info-circle fa-2x mb-2 text-info"></i><br>
          <span class="text-muted">No wastage data available for the selected period</span>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  data.daily_data.forEach(day => {
    const wastageClass = day.wastage_percentage > 20 ? 'text-danger' : day.wastage_percentage > 10 ? 'text-warning' : 'text-success';
    
    html += `
      <tr>
        <td>${day.date}</td>
        <td>${day.procurement_liters.toFixed(2)} L</td>
        <td>${day.delivery_liters.toFixed(2)} L</td>
        <td>${day.wastage_liters.toFixed(2)} L</td>
        <td><span class="${wastageClass}">${day.wastage_percentage}%</span></td>
        <td>₹${day.wastage_cost.toFixed(2)}</td>
        <td>Excess procurement</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function populateMonthlyReport(data) {
  const tbody = document.querySelector('#monthlyReportTable tbody');
  if (!data || Object.keys(data).length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="text-center py-4">
          <i class="fas fa-info-circle fa-2x mb-2 text-info"></i><br>
          <span class="text-muted">No monthly data available for the selected period</span>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  Object.entries(data).forEach(([month, monthData]) => {
    const profitClass = monthData.profit >= 0 ? 'text-success' : 'text-danger';
    
    html += `
      <tr>
        <td><strong>${month}</strong></td>
        <td>-</td>
        <td>${monthData.procurement_liters.toFixed(2)} L</td>
        <td>${monthData.delivery_liters.toFixed(2)} L</td>
        <td>${monthData.utilization_rate}%</td>
        <td>₹${monthData.procurement_cost.toFixed(2)}</td>
        <td>₹${monthData.delivery_revenue.toFixed(2)}</td>
        <td><span class="${profitClass}">₹${monthData.profit.toFixed(2)}</span></td>
        <td>-</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function exportReport(format) {
  const reportType = document.getElementById('reportType').value;
  alert(`Export to ${format.toUpperCase()} functionality will be implemented soon for ${reportType} report.`);
}

// Saved Reports Functions
function loadSavedReports() {
  const container = document.getElementById('savedReportsContainer');
  if (!container) return;

  // Show loading state
  container.innerHTML = `
    <div class="text-center py-5">
      <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
      <h4>Loading Saved Reports...</h4>
      <p class="text-muted">Please wait while we load your saved reports</p>
    </div>
  `;

  // Fetch saved reports
  fetch('/milk-supply-analytics/saved_reports', {
    method: 'GET',
    headers: {
      'Accept': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(reports => {
    displaySavedReports(reports);
  })
  .catch(error => {
    console.error('Error loading saved reports:', error);
    container.innerHTML = `
      <div class="text-center py-5">
        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
        <h4>Error Loading Saved Reports</h4>
        <p class="text-muted">Failed to load saved reports. Please try again.</p>
        <button class="btn btn-primary" onclick="loadSavedReports()">
          <i class="fas fa-refresh me-1"></i>Retry
        </button>
      </div>
    `;
  });
}

function displaySavedReports(reports) {
  const container = document.getElementById('savedReportsContainer');
  
  if (!reports || reports.length === 0) {
    container.innerHTML = `
      <div class="text-center py-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <h4>No Saved Reports</h4>
        <p class="text-muted">Generate some reports first, and they will appear here for future reference.</p>
      </div>
    `;
    return;
  }

  let html = `
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>Report Name</th>
            <th>Type</th>
            <th>Date Range</th>
            <th>Generated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
  `;

  reports.forEach(report => {
    const reportTypeNames = {
      'daily_procurement_delivery': 'Daily Procurement vs Delivery',
      'vendor_performance': 'Vendor Performance',
      'profit_loss': 'Profit & Loss',
      'wastage_analysis': 'Wastage Analysis',
      'monthly_summary': 'Monthly Summary'
    };

    const typeName = reportTypeNames[report.report_type] || report.report_type;
    const generatedDate = new Date(report.created_at).toLocaleDateString();
    
    html += `
      <tr>
        <td>
          <strong>${report.name}</strong>
        </td>
        <td>
          <span class="badge bg-primary">${typeName}</span>
        </td>
        <td>${report.from_date} to ${report.to_date}</td>
        <td>${generatedDate}</td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="viewSavedReport(${report.id})" title="View Report">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-outline-success" onclick="downloadSavedReport(${report.id})" title="Download">
              <i class="fas fa-download"></i>
            </button>
            <button class="btn btn-outline-danger" onclick="deleteSavedReport(${report.id})" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
    </div>
  `;

  container.innerHTML = html;
}

function viewSavedReport(reportId) {
  // For now, show an alert. In the future, this could open a modal or new page
  alert(`Viewing report ${reportId}. This functionality will open the full report view.`);
}

function downloadSavedReport(reportId) {
  // For now, show an alert. In the future, this could trigger a download
  alert(`Downloading report ${reportId}. This functionality will be implemented soon.`);
}

function deleteSavedReport(reportId) {
  if (confirm('Are you sure you want to delete this saved report?')) {
    alert(`Deleting report ${reportId}. This functionality will be implemented soon.`);
  }
}

// Initialize report sections on page load
document.addEventListener('DOMContentLoaded', function() {
  // Show the daily report by default
  updateReportFilters();
  updateDateFields();
  
  // Set daily report as default visible
  document.querySelectorAll('.report-section').forEach(section => {
    section.classList.add('d-none');
  });
  const dailyReport = document.getElementById('dailyReport');
  if (dailyReport) {
    dailyReport.classList.remove('d-none');
  }
  
  // Load calendar when calendar tab is clicked
  const calendarTab = document.getElementById('calendar-tab');
  if (calendarTab) {
    calendarTab.addEventListener('shown.bs.tab', function() {
      console.log('Calendar tab shown, loading calendar...');
      loadCalendarFallback(); // Use iframe method which is more reliable
    });
  }
  
  // Load saved reports when saved reports tab is clicked
  const savedReportsTab = document.getElementById('saved-reports-tab');
  if (savedReportsTab) {
    savedReportsTab.addEventListener('shown.bs.tab', function() {
      loadSavedReports();
    });
  }
  
  // Load calendar immediately since it's the default active tab
  setTimeout(() => {
    console.log('Loading calendar automatically on page load...');
    loadCalendarFallback(); // Use iframe method which is more reliable
  }, 500);
  
  // Product Selection Auto-Population
  const productDropdown = document.getElementById('product-dropdown');
  const unitField = document.querySelector('select[name="procurement_schedule[unit]"]');
  const sellingPriceField = document.querySelector('input[name="procurement_schedule[selling_price]"]');
  
  if (productDropdown) {
    productDropdown.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      if (selectedOption.value && selectedOption.textContent) {
        const optionText = selectedOption.textContent;
        console.log('Selected product:', optionText);
        
        // Extract unit type from product text (e.g., "Milk (liters) - ₹50")
        const unitMatch = optionText.match(/\(([^)]+)\)/);
        if (unitMatch && unitField) {
          const productUnit = unitMatch[1].toLowerCase();
          unitField.value = productUnit;
          console.log('Auto-set unit to:', productUnit);
        }
        
        // Extract price from product text
        const priceMatch = optionText.match(/₹([\d.]+)/);
        if (priceMatch && sellingPriceField && !sellingPriceField.value) {
          sellingPriceField.value = priceMatch[1];
          console.log('Auto-set selling price to:', priceMatch[1]);
        }
      }
    });
  }
});
</script>
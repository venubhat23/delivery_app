<div class="container-fluid px-4 py-3">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="h4 mb-1">
        <i class="fas fa-truck me-2 text-primary"></i>
        Delivery Assignments - <%= @customer.name %>
      </h2>
      <p class="text-muted mb-0"><%= @month_name %></p>
    </div>
    <div>
      <%= link_to customer_patterns_path, class: "btn btn-outline-secondary" do %>
        <i class="fas fa-arrow-left me-1"></i>Back to Patterns
      <% end %>
    </div>
  </div>

  <% if @delivery_assignments.any? %>
    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card border-primary">
          <div class="card-body text-center">
            <h3 class="text-primary mb-0"><%= @delivery_assignments.count %></h3>
            <small class="text-muted">Total Assignments</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-success">
          <div class="card-body text-center">
            <h3 class="text-success mb-0"><%= @delivery_assignments.where(status: 'completed').count %></h3>
            <small class="text-muted">Completed</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-warning">
          <div class="card-body text-center">
            <h3 class="text-warning mb-0"><%= @delivery_assignments.where(status: 'pending').count %></h3>
            <small class="text-muted">Pending</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-info">
          <div class="card-body text-center">
            <h3 class="text-info mb-0">₹<%= @delivery_assignments.sum(&:final_amount).round(0) %></h3>
            <small class="text-muted">Total Amount</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Assignments Table -->
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <i class="fas fa-list me-2"></i>
          Delivery Assignments (<%= @delivery_assignments.count %>)
        </h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Product</th>
                <th>Quantity</th>
                <th>Delivery Person</th>
                <th>Status</th>
                <th>Amount</th>
                <th>Discount</th>
                <th>Final Amount</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @delivery_assignments.each do |assignment| %>
                <tr>
                  <td>
                    <div class="fw-semibold"><%= assignment.scheduled_date.strftime("%d %b") %></div>
                    <small class="text-muted"><%= assignment.scheduled_date.strftime("%a") %></small>
                  </td>
                  <td>
                    <div class="fw-semibold"><%= assignment.product.name %></div>
                    <small class="text-muted"><%= assignment.product.unit_type %></small>
                  </td>
                  <td>
                    <span class="fw-semibold"><%= assignment.quantity %></span>
                    <small class="text-muted"><%= assignment.unit %></small>
                  </td>
                  <td>
                    <span class="badge bg-info">
                      <%= assignment.user.name %>
                    </span>
                  </td>
                  <td>
                    <% case assignment.status %>
                    <% when 'completed' %>
                      <span class="badge bg-success">Completed</span>
                    <% when 'pending' %>
                      <span class="badge bg-warning">Pending</span>
                    <% when 'in_progress' %>
                      <span class="badge bg-info">In Progress</span>
                    <% else %>
                      <span class="badge bg-danger">Cancelled</span>
                    <% end %>
                  </td>
                  <td>
                    ₹<%= number_with_precision(assignment.total_amount, precision: 2) %>
                  </td>
                  <td>
                    <% if assignment.has_discount? %>
                      <span class="text-danger">
                        -₹<%= number_with_precision(assignment.discount_amount, precision: 2) %>
                      </span>
                      <small class="text-muted d-block">
                        (<%= assignment.discount_percentage %>%)
                      </small>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                  <td class="fw-semibold">
                    ₹<%= number_with_precision(assignment.final_amount, precision: 2) %>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <%= link_to delivery_assignment_path(assignment), class: "btn btn-outline-primary btn-sm", title: "View" do %>
                        <i class="fas fa-eye"></i>
                      <% end %>
                      <%= link_to edit_delivery_assignment_path(assignment), class: "btn btn-outline-warning btn-sm", title: "Edit" do %>
                        <i class="fas fa-edit"></i>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
            <tfoot class="table-light">
              <tr>
                <th colspan="5">Total</th>
                <th>₹<%= number_with_precision(@delivery_assignments.sum(&:total_amount), precision: 2) %></th>
                <th>
                  <% total_discount = @delivery_assignments.sum { |a| a.discount_amount.to_f } %>
                  <% if total_discount > 0 %>
                    <span class="text-danger">-₹<%= number_with_precision(total_discount, precision: 2) %></span>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </th>
                <th class="fw-bold">
                  ₹<%= number_with_precision(@delivery_assignments.sum(&:final_amount), precision: 2) %>
                </th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <% pending_till_today = @delivery_assignments.where(status: 'pending').where('scheduled_date <= ?', Date.current) %>
    <% if pending_till_today.any? %>
      <div class="mt-3">
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          There are <strong><%= pending_till_today.count %></strong> pending assignments till today.
          <div class="mt-2">
            <%= form_with url: complete_till_today_customer_patterns_path, method: :post, local: true, class: "d-inline" do |form| %>
              <%= form.hidden_field :customer_id, value: @customer.id %>
              <%= form.hidden_field :month, value: @month %>
              <%= form.hidden_field :year, value: @year %>
              <%= form.submit "Complete All Till Today (#{pending_till_today.count})",
                  class: "btn btn-success",
                  data: {
                    confirm: "Are you sure you want to mark all #{pending_till_today.count} pending assignment(s) till today as completed? This action cannot be undone."
                  } %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

  <% else %>
    <!-- Empty State -->
    <div class="card">
      <div class="card-body text-center py-5">
        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No delivery assignments found</h5>
        <p class="text-muted">No delivery assignments were found for <strong><%= @customer.name %></strong> in <strong><%= @month_name %></strong>.</p>
        <%= link_to new_delivery_assignment_path(customer_id: @customer.id), class: "btn btn-primary" do %>
          <i class="fas fa-plus me-1"></i>Create Assignment
        <% end %>
      </div>
    </div>
  <% end %>
</div>
<div class="delivery-review-page">
  <div class="page-header mb-3">
    <h2>üöö Delivery Review</h2>
    <p class="text-muted">Track and analyze delivery performance and customer delivery details</p>
  </div>

  <div class="filter-section card mb-4" data-enhanced-selects>
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Delivery Filters</h5>
    </div>
    <div class="card-body">
      <form id="deliveryReviewFilters">
        <!-- Main Filters Row -->
        <div class="row g-3 mb-3">
          <div class="col-lg-3 col-md-6">
            <label class="form-label fw-semibold">üë§ Customer</label>
            <select id="filterCustomer" class="form-select form-select-enhanced">
              <option value="all" selected>All Customers</option>
              <% @customers.each do |c| %>
                <option value="<%= c.id %>" data-phone="<%= c.phone_number %>" data-member="<%= c.member_id %>">
                  <%= c.name.truncate(25) %>
                </option>
              <% end %>
            </select>
          </div>

          <div class="col-lg-2 col-md-6">
            <label class="form-label fw-semibold">üìÖ Date Range</label>
            <select id="filterDate" class="form-select form-select-enhanced">
              <option value="monthly" selected>Monthly</option>
              <option value="weekly">Weekly</option>
              <option value="today">Today</option>
              <option value="custom">Custom Range</option>
            </select>
          </div>

          <div class="col-lg-2 col-md-6">
            <label class="form-label fw-semibold">üì¶ Product</label>
            <select id="filterProduct" class="form-select form-select-enhanced">
              <option value="all" selected>All Products</option>
              <% @products.each do |p| %>
                <option value="<%= p.id %>"><%= p.name %></option>
              <% end %>
            </select>
          </div>

          <div class="col-lg-2 col-md-6">
            <label class="form-label fw-semibold">üè∑Ô∏è Status</label>
            <select id="filterStatus" class="form-select form-select-enhanced">
              <option value="all" selected>All Status</option>
              <option value="completed">‚úÖ Completed</option>
              <option value="pending">‚è≥ Pending</option>
              <option value="cancelled">‚ùå Cancelled</option>
            </select>
          </div>

          <div class="col-lg-3 col-md-6">
            <label class="form-label fw-semibold">üöö Delivery Person</label>
            <select id="filterDeliveryPerson" class="form-select form-select-enhanced">
              <option value="all" selected>All Delivery Persons</option>
              <% @delivery_persons.each do |dp| %>
                <option value="<%= dp.id %>"><%= dp.name %></option>
              <% end %>
            </select>
          </div>
        </div>

        <!-- Custom Date Range Row -->
        <div class="row g-3 mb-3 d-none" id="customDateRange">
          <div class="col-md-3">
            <label class="form-label fw-semibold">Start Date</label>
            <input type="date" id="startDate" class="form-control" value="<%= Date.today.to_s %>" />
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">End Date</label>
            <input type="date" id="endDate" class="form-control" value="<%= Date.today.to_s %>" />
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">üîç Search</label>
            <input type="text" id="globalSearch" class="form-control" placeholder="Search customer name or product..." />
          </div>
        </div>

        <!-- Search Row (when custom dates are hidden) -->
        <div class="row g-3 mb-3" id="searchRow">
          <div class="col-md-4">
            <label class="form-label fw-semibold">üîç Search</label>
            <input type="text" id="globalSearchMain" class="form-control" placeholder="Search customer name or product..." />
          </div>
          <div class="col-md-8 d-flex align-items-end">
            <!-- Action Buttons -->
            <div class="btn-group me-2" role="group">
              <button type="button" id="applyFiltersBtn" class="btn btn-primary px-4">
                <i class="fas fa-search me-1"></i>Apply Filters
              </button>
              <button type="button" id="bulkCompleteBtn" class="btn btn-success" style="display: none;">
                <i class="fas fa-check-circle me-1"></i><span id="bulkCompleteText">Complete 0</span>
              </button>
            </div>
            <div class="btn-group" role="group">
              <button type="button" id="exportCsvBtn" class="btn btn-outline-primary">
                <i class="fas fa-download me-1"></i>Export CSV
              </button>
              <button type="button" id="printBtn" class="btn btn-outline-secondary">
                <i class="fas fa-print me-1"></i>Print
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="summary-section row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="card-title">Total Deliveries</h6>
          <div class="fs-4" id="sumTotalDeliveries">0</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="card-title">Total Customers</h6>
          <div class="fs-4" id="sumTotalCustomers">0</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="card-title">Total Amount</h6>
          <div class="fs-4" id="sumTotalAmount">‚Çπ0</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="card-title">Completion Rate</h6>
          <div class="fs-4" id="sumCompletionRate">0%</div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-section card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">üìã Delivery Details</h5>
      <div class="text-muted small" id="hasMoreNotice" style="display:none;">Showing first 1000 rows</div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">Date</th>
              <th scope="col">Customer Name</th>
              <th scope="col">Product</th>
              <th scope="col">Quantity</th>
              <th scope="col">Amount</th>
              <th scope="col">Discount</th>
              <th scope="col">Product Cost</th>
              <th scope="col">Status</th>
              <th scope="col">Delivery Person</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody id="deliveryTableBody">
            <tr><td colspan="9" class="text-center text-muted">Use filters to load data</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<style>
/* Enhanced Delivery Review Dropdown Styles */
.delivery-review-page .filter-section {
  background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
  border: 1px solid rgba(99, 102, 241, 0.1);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}

.delivery-review-page .filter-section .card-header {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.03) 100%);
  border-bottom: 1px solid rgba(99, 102, 241, 0.15);
}

.delivery-review-page .form-select-enhanced {
  background: #ffffff;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 0.75rem 2.5rem 0.75rem 1rem;
  font-size: 0.95rem;
  font-weight: 500;
  color: #1e293b;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 0.75rem center;
  background-repeat: no-repeat;
  background-size: 1.25rem;
}

.delivery-review-page .form-select-enhanced:focus {
  border-color: #6366f1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 0 4px 12px rgba(99, 102, 241, 0.15);
  background-color: #ffffff;
  outline: none;
  transform: translateY(-1px);
}

.delivery-review-page .form-select-enhanced:hover:not(:focus) {
  border-color: #c7d2fe;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.delivery-review-page .focused-filter {
  transform: scale(1.02);
  transition: transform 0.2s ease;
}

.delivery-review-page .form-control {
  background: #ffffff;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 0.75rem 1rem;
  font-size: 0.95rem;
  font-weight: 500;
  color: #1e293b;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.delivery-review-page .form-control:focus {
  border-color: #6366f1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 0 4px 12px rgba(99, 102, 241, 0.15);
  background-color: #ffffff;
  outline: none;
  transform: translateY(-1px);
}

.delivery-review-page .form-control:hover:not(:focus) {
  border-color: #c7d2fe;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.delivery-review-page .form-label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
  letter-spacing: 0.025em;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.delivery-review-page .btn {
  border-radius: 10px;
  font-weight: 600;
  padding: 0.75rem 1.5rem;
  font-size: 0.9rem;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
}

.delivery-review-page .btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.delivery-review-page .btn-primary {
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  border-color: transparent;
  color: white;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.delivery-review-page .btn-primary:hover:not(:disabled) {
  box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
}

.delivery-review-page .btn-success {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  border-color: transparent;
  color: white;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.delivery-review-page .btn-success:hover:not(:disabled) {
  box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
}

.delivery-review-page .btn-outline-primary {
  background: transparent;
  border-color: #6366f1;
  color: #6366f1;
}

.delivery-review-page .btn-outline-primary:hover:not(:disabled) {
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  border-color: transparent;
  color: white;
  box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
}

.delivery-review-page .btn-outline-secondary {
  background: transparent;
  border-color: #6b7280;
  color: #6b7280;
}

.delivery-review-page .btn-outline-secondary:hover:not(:disabled) {
  background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
  border-color: transparent;
  color: white;
  box-shadow: 0 8px 25px rgba(107, 114, 128, 0.3);
}

/* Enhanced dropdown animations */
.delivery-review-page .form-select-enhanced {
  animation: fadeInUp 0.3s ease-out;
}

.delivery-review-page .form-control {
  animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Select2 custom theme for this page */
.delivery-review-page .select2-container--bootstrap-5 .select2-dropdown {
  border-radius: 12px;
  border: 2px solid #e2e8f0;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
  animation: slideInDown 0.2s ease-out;
}

.delivery-review-page .select2-container--bootstrap-5 .select2-selection {
  border-radius: 12px;
  border: 2px solid #e2e8f0;
  min-height: 44px;
  background: #ffffff;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.delivery-review-page .select2-container--bootstrap-5.select2-container--focus .select2-selection {
  border-color: #6366f1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

@keyframes slideInDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Responsive improvements */
@media (max-width: 768px) {
  .delivery-review-page .btn-group {
    flex-direction: column;
    width: 100%;
  }

  .delivery-review-page .btn-group .btn {
    margin-bottom: 0.5rem;
    border-radius: 10px !important;
  }

  .delivery-review-page .form-select-enhanced,
  .delivery-review-page .form-control {
    font-size: 16px; /* Prevents zoom on iOS */
  }
}

/* Loading states */
.delivery-review-page .loading {
  position: relative;
  opacity: 0.7;
  pointer-events: none;
}

.delivery-review-page .loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(99, 102, 241, 0.3);
  border-top: 2px solid #6366f1;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  transform: translate(-50%, -50%);
  z-index: 10;
}

@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}
</style>

<script>
(function() {
  'use strict';
  
  // Store pending assignment IDs for bulk completion
  var pendingAssignmentIds = [];

  function formatINR(value) {
    try {
      return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 }).format(value || 0);
    } catch(e) { return '‚Çπ' + (value || 0); }
  }

  function statusBadge(status) {
    switch(status) {
      case 'completed': return '<span class="badge bg-success">Completed</span>';
      case 'pending': return '<span class="badge bg-warning text-dark">Pending</span>';
      case 'cancelled': return '<span class="badge bg-danger">Cancelled</span>';
      case 'in_progress': return '<span class="badge bg-info text-white">In Progress</span>';
      default: return '<span class="badge bg-secondary">' + (status || '-') + '</span>';
    }
  }

  function toggleCustomDates() {
    var type = document.getElementById('filterDate').value;
    var customDateRange = document.getElementById('customDateRange');
    var searchRow = document.getElementById('searchRow');

    if (type === 'custom') {
      customDateRange.classList.remove('d-none');
      searchRow.classList.add('d-none');
    } else {
      customDateRange.classList.add('d-none');
      searchRow.classList.remove('d-none');
    }
  }

  // Fixed date handling - v2025-09-01-07:05
  function getFilters() {
    var dateType = document.getElementById('filterDate').value;
    var params = {
      customer_id: document.getElementById('filterCustomer').value,
      date_filter: dateType,
      product_id: document.getElementById('filterProduct').value,
      status: document.getElementById('filterStatus').value,
      delivery_person_id: document.getElementById('filterDeliveryPerson').value,
      search: (document.getElementById('globalSearch') ? document.getElementById('globalSearch').value.trim() : document.getElementById('globalSearchMain').value.trim())
    };
    
    // SIMPLE DATE HANDLING - NO CONVERSION
    if (dateType === 'custom') {
      var startInput = document.getElementById('startDate');
      var endInput = document.getElementById('endDate');
      
      // Just use the values directly - they're already YYYY-MM-DD
      params.start_date = startInput.value || '';
      params.end_date = endInput.value || '';
      
      console.log('FIXED: start_date =', params.start_date);
      console.log('FIXED: end_date =', params.end_date);
    }
    return params;
  }


  function setSummary(summary) {
    document.getElementById('sumTotalDeliveries').textContent = summary.total_deliveries || 0;
    document.getElementById('sumTotalCustomers').textContent = summary.total_customers || 0;
    document.getElementById('sumTotalAmount').textContent = formatINR(summary.total_amount || 0);
    document.getElementById('sumCompletionRate').textContent = (summary.completion_rate || 0) + '%';
    
    // Update bulk complete button
    updateBulkCompleteButton(summary.pending_deliveries || 0);
  }

  function updateBulkCompleteButton(pendingCount) {
    var bulkBtn = document.getElementById('bulkCompleteBtn');
    var bulkText = document.getElementById('bulkCompleteText');
    
    if (pendingCount > 0) {
      bulkText.textContent = 'Complete ' + pendingCount;
      bulkBtn.style.display = 'inline-block';
    } else {
      bulkBtn.style.display = 'none';
    }
  }

  function renderRows(deliveries) {
    var tbody = document.getElementById('deliveryTableBody');
    tbody.innerHTML = '';
    
    // Clear and rebuild pending assignment IDs
    pendingAssignmentIds = [];
    
    if (!deliveries || deliveries.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No records found</td></tr>';
      return;
    }
    
    var rows = deliveries.map(function(d) {
      // Track pending assignments for bulk completion
      if (d.status === 'pending') {
        pendingAssignmentIds.push(d.id);
      }
      
      return '<tr data-delivery-id="' + d.id + '">' +
        '<td class="editable-date" data-field="scheduled_date">' + d.date + '</td>' +
        '<td>' + (d.customer_name || '-') + '</td>' +
        '<td class="editable-product" data-field="product_id">' + (d.product || '-') + '</td>' +
        '<td class="editable-quantity" data-field="quantity">' + (d.quantity || '-') + '</td>' +
        '<td class="editable-amount" data-field="final_amount_after_discount">' + formatINR(d.amount || 0) + '</td>' +
        '<td>' + formatINR(d.discount || 0) + '</td>' +
        '<td class="text-info fw-bold">' + formatINR(d.product_cost || 0) + '</td>' +
        '<td class="editable-status" data-field="status">' + statusBadge(d.status) + '</td>' +
        '<td class="editable-delivery-person" data-field="user_id">' + (d.delivery_person || '-') + '</td>' +
        '<td class="actions-cell">' +
          '<button class="btn btn-sm btn-outline-primary me-1 edit-btn" data-id="' + d.id + '">Edit</button>' +
          '<button class="btn btn-sm btn-outline-danger delete-btn" data-id="' + d.id + '">Delete</button>' +
        '</td>' +
      '</tr>';
    }).join('');
    tbody.innerHTML = rows;
  }

  function fetchData() {
    var btn = document.getElementById('applyFiltersBtn');
    btn.disabled = true; btn.classList.add('loading');
    var params = getFilters();
    
    // Debug the final URL being sent
    var query = new URLSearchParams(params).toString();
    console.log('FINAL URL BEING SENT:', '/delivery-review/data.json?' + query);
    
    // Add timestamp to break cache
    var url = '/delivery-review/data.json?' + query + '&_=' + Date.now();
    
    fetch(url, { headers: { 'Accept': 'application/json' } })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        setSummary(data.summary || {});
        renderRows(data.deliveries || []);
        document.getElementById('hasMoreNotice').style.display = data.has_more ? '' : 'none';
      })
      .catch(function(e) { console.error(e); })
      .finally(function(){ btn.disabled = false; btn.classList.remove('loading'); });
  }


  document.addEventListener('DOMContentLoaded', function() {
    // Initialize enhanced selects
    initializeEnhancedSelects();

    // Add hover effects and better styling
    document.querySelectorAll('.form-select-enhanced').forEach(function(select) {
      select.addEventListener('focus', function() {
        this.parentElement.classList.add('focused-filter');
      });
      select.addEventListener('blur', function() {
        this.parentElement.classList.remove('focused-filter');
      });
    });
    document.getElementById('filterDate').addEventListener('change', toggleCustomDates);
    document.getElementById('applyFiltersBtn').addEventListener('click', fetchData);
    document.getElementById('bulkCompleteBtn').addEventListener('click', handleBulkComplete);
    document.getElementById('printBtn').addEventListener('click', function(){ window.print(); });

    document.getElementById('exportCsvBtn').addEventListener('click', function() {
      var params = getFilters();
      var form = document.createElement('form');
      form.method = 'POST';
      form.action = '/delivery-review/export';
      form.style.display = 'none';
      var csrf = document.querySelector('meta[name="csrf-token"]');
      if (csrf) {
        var t = document.createElement('input'); t.type = 'hidden'; t.name = 'authenticity_token'; t.value = csrf.getAttribute('content'); form.appendChild(t);
      }
      Object.keys(params).forEach(function(k){
        var input = document.createElement('input'); input.type = 'hidden'; input.name = k; input.value = params[k]; form.appendChild(input);
      });
      document.body.appendChild(form);
      form.submit();
      setTimeout(function(){ document.body.removeChild(form); }, 1000);
    });

    // Edit and Delete functionality
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('edit-btn')) {
        handleEdit(e.target.dataset.id);
      } else if (e.target.classList.contains('delete-btn')) {
        handleDelete(e.target.dataset.id);
      } else if (e.target.classList.contains('save-btn')) {
        handleSave(e.target.dataset.id);
      } else if (e.target.classList.contains('cancel-btn')) {
        handleCancel(e.target.dataset.id);
      }
    });

    // Auto load defaults (Monthly + All Customers)
    fetchData();
  });

  function handleEdit(deliveryId) {
    var row = document.querySelector('tr[data-delivery-id="' + deliveryId + '"]');
    if (!row) return;

    // Store original values
    row.setAttribute('data-editing', 'true');
    var cells = row.querySelectorAll('td');
    
    console.log('Edit mode - Total cells found:', cells.length);
    console.log('Cells array:', Array.from(cells).map((cell, idx) => ({ index: idx, content: cell.textContent.trim() })));
    
    // Convert editable cells to form inputs
    // Table structure: Date, Customer, Product, Quantity, Amount, Discount, Product Cost, Status, Delivery Person, Actions
    convertCellToInput(cells[0], 'date', getDateValue(cells[0].textContent)); // Date (index 0)
    convertCellToSelect(cells[2], 'product', cells[2].textContent); // Product (index 2)
    convertCellToInput(cells[3], 'quantity', getQuantityValue(cells[3].textContent)); // Quantity (index 3)
    convertCellToInput(cells[4], 'amount', getAmountValue(cells[4].textContent)); // Amount (index 4)
    convertCellToSelect(cells[7], 'status', getStatusValue(cells[7].innerHTML)); // Status (index 7)
    convertCellToSelect(cells[8], 'delivery-person', cells[8].textContent); // Delivery Person (index 8)

    // Change action buttons (index 9 - Actions column)
    var actionsCell = cells[9];
    if (actionsCell) {
      actionsCell.innerHTML = 
        '<button class="btn btn-sm btn-success me-1 save-btn" data-id="' + deliveryId + '">Save</button>' +
        '<button class="btn btn-sm btn-secondary cancel-btn" data-id="' + deliveryId + '">Cancel</button>';
    } else {
      console.error('Actions cell not found at index 9 for delivery ID:', deliveryId);
    }
  }

  function convertCellToInput(cell, type, value) {
    var field = cell.dataset.field;
    var inputType = type === 'date' ? 'date' : type === 'amount' ? 'number' : 'text';
    var step = type === 'amount' ? 'step="0.01"' : '';
    cell.innerHTML = '<input type="' + inputType + '" class="form-control form-control-sm" value="' + value + '" data-field="' + field + '" ' + step + '>';
  }

  function convertCellToSelect(cell, type, currentValue) {
    var field = cell.dataset.field;
    var options = '';
    
    if (type === 'product') {
      options = '<option value="">Select Product</option>';
      // Add products from the filter dropdown
      var productSelect = document.getElementById('filterProduct');
      for (var i = 1; i < productSelect.options.length; i++) {
        var option = productSelect.options[i];
        var selected = option.text === currentValue ? 'selected' : '';
        options += '<option value="' + option.value + '" ' + selected + '>' + option.text + '</option>';
      }
    } else if (type === 'status') {
      var statusOptions = [
        { value: 'pending', text: 'Pending' },
        { value: 'completed', text: 'Completed' },
        { value: 'cancelled', text: 'Cancelled' },
        { value: 'in_progress', text: 'In Progress' }
      ];
      options = '';
      statusOptions.forEach(function(opt) {
        var selected = opt.text === currentValue || opt.value === currentValue ? 'selected' : '';
        options += '<option value="' + opt.value + '" ' + selected + '>' + opt.text + '</option>';
      });
    } else if (type === 'delivery-person') {
      options = '<option value="">Select Delivery Person</option>';
      var deliverySelect = document.getElementById('filterDeliveryPerson');
      for (var i = 1; i < deliverySelect.options.length; i++) {
        var option = deliverySelect.options[i];
        var selected = option.text === currentValue ? 'selected' : '';
        options += '<option value="' + option.value + '" ' + selected + '>' + option.text + '</option>';
      }
    }
    
    cell.innerHTML = '<select class="form-select form-select-sm" data-field="' + field + '">' + options + '</select>';
  }

  function getDateValue(dateText) {
    // NO CONVERSION - Return date exactly as received
    // HTML5 date inputs use YYYY-MM-DD format automatically
    return dateText || '';
  }

  function getQuantityValue(quantityText) {
    // Extract number from "5 L" format
    return quantityText.split(' ')[0] || '';
  }

  function getAmountValue(amountText) {
    // Extract number from "‚Çπ150.00" format
    return amountText.replace(/[‚Çπ,]/g, '') || '';
  }

  function getStatusValue(statusHtml) {
    // Extract status from badge HTML
    var tempDiv = document.createElement('div');
    tempDiv.innerHTML = statusHtml;
    var badge = tempDiv.querySelector('.badge');
    return badge ? badge.textContent.trim() : '';
  }

  function handleSave(deliveryId) {
    var row = document.querySelector('tr[data-delivery-id="' + deliveryId + '"]');
    if (!row) return;

    var data = {};
    var inputs = row.querySelectorAll('input, select');
    
    inputs.forEach(function(input) {
      var field = input.dataset.field;
      if (field) {
        data[field] = input.value;
      }
    });

    // Send update request
    var csrf = document.querySelector('meta[name="csrf-token"]');
    fetch('/delivery-review/' + deliveryId, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrf ? csrf.getAttribute('content') : ''
      },
      body: JSON.stringify({ delivery_assignment: data })
    })
    .then(function(response) { return response.json(); })
    .then(function(result) {
      if (result.success) {
        // Refresh the data to show updated values
        fetchData();
      } else {
        alert('Error: ' + (result.errors ? result.errors.join(', ') : result.message));
      }
    })
    .catch(function(error) {
      console.error('Error:', error);
      alert('Failed to update delivery');
    });
  }

  function handleCancel(deliveryId) {
    // Simply refresh the data to restore original values
    fetchData();
  }

  function handleDelete(deliveryId) {
    if (!confirm('Are you sure you want to delete this delivery assignment?')) {
      return;
    }

    var csrf = document.querySelector('meta[name="csrf-token"]');
    fetch('/delivery-review/' + deliveryId, {
      method: 'DELETE',
      headers: {
        'X-CSRF-Token': csrf ? csrf.getAttribute('content') : ''
      }
    })
    .then(function(response) { return response.json(); })
    .then(function(result) {
      if (result.success) {
        // Refresh the data to remove deleted row
        fetchData();
      } else {
        alert('Error: ' + result.message);
      }
    })
    .catch(function(error) {
      console.error('Error:', error);
      alert('Failed to delete delivery');
    });
  }

  function handleBulkComplete() {
    if (pendingAssignmentIds.length === 0) {
      alert('No pending assignments found to complete.');
      return;
    }

    if (!confirm('Are you sure you want to mark ' + pendingAssignmentIds.length + ' pending assignment(s) as completed?')) {
      return;
    }

    var btn = document.getElementById('bulkCompleteBtn');
    var originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Completing...';

    var csrf = document.querySelector('meta[name="csrf-token"]');
    fetch('/delivery-review/bulk-complete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrf ? csrf.getAttribute('content') : ''
      },
      body: JSON.stringify({ assignment_ids: pendingAssignmentIds })
    })
    .then(function(response) { return response.json(); })
    .then(function(result) {
      if (result.success) {
        // Show success message
        alert(result.message);
        // Refresh the data to show updated statuses
        fetchData();
      } else {
        alert('Error: ' + result.message);
      }
    })
    .catch(function(error) {
      console.error('Error:', error);
      alert('Failed to complete assignments');
    })
    .finally(function() {
      btn.disabled = false;
      btn.innerHTML = originalText;
    });
  }

  function initializeEnhancedSelects() {
    // Try Select2 first, fallback to custom styling
    if (window.jQuery && jQuery.fn.select2) {
      jQuery('.form-select-enhanced').select2({
        theme: 'bootstrap-5',
        width: '100%',
        dropdownAutoWidth: true,
        placeholder: function() {
          return jQuery(this).data('placeholder') || jQuery(this).find('option:first').text();
        },
        templateResult: function(state) {
          if (!state.id) return state.text;

          var $state = jQuery('<span></span>');
          $state.text(state.text);

          // Add phone and member info for customer dropdown
          if (state.element && state.element.dataset) {
            if (state.element.dataset.phone && state.element.dataset.member) {
              var $info = jQuery('<small class="text-muted d-block"></small>');
              $info.text('üìû ' + state.element.dataset.phone + ' | ID: ' + state.element.dataset.member);
              $state.append($info);
            }
          }

          return $state;
        }
      });
    } else {
      // Fallback: Add custom styling classes
      document.querySelectorAll('.form-select-enhanced').forEach(function(select) {
        select.classList.add('enhanced-dropdown');
      });
    }
  }

})();
</script>
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="text-dark mb-0">
    <i class="fas fa-shopping-cart me-2 text-primary"></i>
    Shopping Cart
  </h2>
  <div class="d-flex gap-2">
    <%= link_to affiliate_products_path, class: "btn btn-outline-primary" do %>
      <i class="fas fa-arrow-left me-1"></i>
      Continue Shopping
    <% end %>
  </div>
</div>

<% if @cart_items.any? %>
  <div class="row">
    <!-- Cart Items -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-light">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-list me-2"></i>
              Cart Items (<%= @cart_count %> items)
            </h5>
            <%= link_to affiliate_cart_clear_path,
                method: :delete,
                class: "btn btn-sm btn-outline-danger",
                data: { confirm: "Are you sure you want to clear your cart?" } do %>
              <i class="fas fa-trash me-1"></i>
              Clear Cart
            <% end %>
          </div>
        </div>
        <div class="card-body p-0">
          <% @cart_items.each_with_index do |item, index| %>
            <div class="border-bottom p-3 cart-item" data-product-id="<%= item[:product].id %>">
              <div class="row align-items-center">
                <!-- Product Image -->
                <div class="col-2">
                  <% if item[:product].image_url.present? %>
                    <img src="<%= item[:product].image_url %>"
                         class="img-fluid rounded"
                         style="height: 60px; width: 60px; object-fit: cover;"
                         alt="<%= item[:product].name %>" />
                  <% else %>
                    <div class="bg-light rounded d-flex align-items-center justify-content-center"
                         style="height: 60px; width: 60px;">
                      <i class="fas fa-image text-muted"></i>
                    </div>
                  <% end %>
                </div>

                <!-- Product Details -->
                <div class="col-4">
                  <h6 class="mb-1 fw-bold">
                    <%= link_to item[:product].name, affiliate_product_path(item[:product]),
                        class: "text-decoration-none text-dark" %>
                  </h6>
                  <small class="text-muted">
                    ₹<%= item[:price] %> per <%= item[:product].unit_type || 'unit' %>
                  </small>
                  <% if item[:product].category %>
                    <br><small class="badge bg-light text-dark"><%= item[:product].category.name %></small>
                  <% end %>
                </div>

                <!-- Quantity Controls -->
                <div class="col-3">
                  <%= form_with url: affiliate_cart_update_path, method: :patch,
                      class: "quantity-form", data: { remote: true } do |form| %>
                    <%= form.hidden_field :product_id, value: item[:product].id %>
                    <div class="input-group input-group-sm">
                      <button class="btn btn-outline-secondary quantity-btn" type="button" data-action="decrease">
                        <i class="fas fa-minus"></i>
                      </button>
                      <%= form.number_field :quantity,
                          value: item[:quantity],
                          min: 0,
                          step: 0.1,
                          class: "form-control text-center quantity-input",
                          style: "max-width: 80px;" %>
                      <button class="btn btn-outline-secondary quantity-btn" type="button" data-action="increase">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                  <% end %>
                </div>

                <!-- Price and Remove -->
                <div class="col-2 text-end">
                  <div class="fw-bold text-success mb-2">
                    ₹<span class="item-total"><%= item[:total].to_i %></span>
                  </div>
                  <%= link_to affiliate_cart_remove_path(product_id: item[:product].id),
                      method: :delete,
                      class: "btn btn-sm btn-outline-danger",
                      data: {
                        remote: true,
                        confirm: "Remove #{item[:product].name} from cart?"
                      } do %>
                    <i class="fas fa-trash"></i>
                  <% end %>
                </div>

                <!-- Mobile Responsive Actions -->
                <div class="col-1 d-block d-md-none">
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                            data-bs-toggle="dropdown">
                      <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li>
                        <%= link_to affiliate_product_path(item[:product]), class: "dropdown-item" do %>
                          <i class="fas fa-eye me-2"></i>View Product
                        <% end %>
                      </li>
                      <li>
                        <%= link_to affiliate_cart_remove_path(product_id: item[:product].id),
                            method: :delete,
                            class: "dropdown-item text-danger",
                            data: { confirm: "Remove from cart?" } do %>
                          <i class="fas fa-trash me-2"></i>Remove
                        <% end %>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Cart Summary -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 sticky-top" style="top: 100px;">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-calculator me-2"></i>
            Order Summary
          </h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal (<%= @cart_count %> items):</span>
            <span class="fw-bold">₹<span id="cart-subtotal"><%= @cart_total.to_i %></span></span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Delivery Charges:</span>
            <span class="text-success">Free</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between mb-3">
            <span class="h5">Total Amount:</span>
            <span class="h5 text-success fw-bold">₹<span id="cart-total"><%= @cart_total.to_i %></span></span>
          </div>

          <div class="d-grid mb-3">
            <%= link_to affiliate_cart_checkout_path, class: "btn btn-success btn-lg" do %>
              <i class="fas fa-credit-card me-2"></i>
              Proceed to Checkout
            <% end %>
          </div>

          <div class="text-center">
            <small class="text-muted">
              <i class="fas fa-shield-alt me-1"></i>
              Your order is secured
            </small>
          </div>
        </div>
      </div>

      <!-- Suggested Products -->
      <div class="card shadow-sm border-0 mt-3">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="fas fa-lightbulb me-2"></i>
            You might also like
          </h6>
        </div>
        <div class="card-body p-2">
          <!-- Add suggested products logic here if needed -->
          <div class="text-center py-3">
            <%= link_to affiliate_products_path, class: "btn btn-outline-primary btn-sm" do %>
              <i class="fas fa-search me-1"></i>
              Browse More Products
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
<% else %>
  <!-- Empty Cart -->
  <div class="text-center py-5">
    <div class="mb-4">
      <i class="fas fa-shopping-cart fa-5x text-muted mb-3"></i>
      <h3 class="text-muted">Your cart is empty</h3>
      <p class="text-muted">Add some products to get started with your order.</p>
    </div>

    <div class="d-grid gap-2 d-md-block">
      <%= link_to affiliate_products_path, class: "btn btn-primary btn-lg" do %>
        <i class="fas fa-shopping-basket me-2"></i>
        Start Shopping
      <% end %>
      <%= link_to affiliate_dashboard_path, class: "btn btn-outline-secondary btn-lg" do %>
        <i class="fas fa-home me-2"></i>
        Go to Dashboard
      <% end %>
    </div>
  </div>
<% end %>

<!-- Toast for cart updates -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="cartUpdateToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Cart updated successfully!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<style>
.cart-item:hover {
  background-color: #f8f9fa;
}

.sticky-top {
  position: -webkit-sticky;
  position: sticky;
}

@media (max-width: 768px) {
  .sticky-top {
    position: static;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle quantity button clicks
  document.querySelectorAll('.quantity-btn').forEach(button => {
    button.addEventListener('click', function() {
      const action = this.dataset.action;
      const form = this.closest('.quantity-form');
      const input = form.querySelector('.quantity-input');
      let currentValue = parseFloat(input.value) || 0;

      if (action === 'increase') {
        input.value = currentValue + 1;
      } else if (action === 'decrease' && currentValue > 0) {
        input.value = Math.max(0, currentValue - 1);
      }

      // Auto-submit form after short delay
      setTimeout(() => {
        form.requestSubmit();
      }, 300);
    });
  });

  // Handle quantity input changes
  document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('change', function() {
      const form = this.closest('.quantity-form');
      form.requestSubmit();
    });
  });

  // Handle AJAX responses
  document.querySelectorAll('form[data-remote="true"]').forEach(form => {
    form.addEventListener('ajax:success', function(event) {
      const response = event.detail[0];

      if (response.success) {
        // Update cart totals
        updateCartTotals(response.cart_total, response.cart_count);

        // Show toast
        showToast('Cart updated successfully!');

        // Remove item if quantity is 0
        const productId = form.querySelector('input[name="product_id"]').value;
        const quantityInput = form.querySelector('.quantity-input');
        if (parseFloat(quantityInput.value) === 0) {
          const cartItem = form.closest('.cart-item');
          cartItem.style.transition = 'all 0.3s ease';
          cartItem.style.opacity = '0';
          cartItem.style.height = '0';
          setTimeout(() => {
            location.reload(); // Refresh to update the cart display
          }, 300);
        }
      }
    });

    form.addEventListener('ajax:error', function(event) {
      showToast('Error updating cart. Please try again.', 'danger');
    });
  });

  // Handle remove item AJAX
  document.querySelectorAll('a[data-remote="true"]').forEach(link => {
    link.addEventListener('ajax:success', function(event) {
      location.reload(); // Refresh to update the cart display
    });
  });

  function updateCartTotals(cartTotal, cartCount) {
    // Update subtotal and total
    const subtotalElement = document.getElementById('cart-subtotal');
    const totalElement = document.getElementById('cart-total');

    if (subtotalElement) subtotalElement.textContent = cartTotal.toLocaleString();
    if (totalElement) totalElement.textContent = cartTotal.toLocaleString();

    // Update cart count in sidebar
    updateSidebarCartCount(cartCount);
  }

  function updateSidebarCartCount(count) {
    const sidebarBadge = document.querySelector('.sidebar .badge');
    if (sidebarBadge) {
      sidebarBadge.textContent = count;
    }
  }

  function showToast(message, type = 'success') {
    const toastElement = document.getElementById('cartUpdateToast');
    const toast = new bootstrap.Toast(toastElement);

    // Update toast message and style
    const toastBody = toastElement.querySelector('.toast-body');
    toastBody.textContent = message;

    // Update toast color based on type
    toastElement.className = `toast align-items-center text-white bg-${type} border-0`;

    toast.show();
  }
});
</script>
<% content_for :title, "Procurement Dashboard" %>

<div class="container-fluid">
  <!-- Header Section -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="h2 mb-0 text-gray-800">
        <i class="fas fa-chart-pie text-primary me-3"></i>
        Procurement Dashboard
      </h1>
      <p class="text-muted mb-0 fs-5">Monitor your milk procurement performance and metrics</p>
    </div>
    
    <div class="d-flex gap-2">
      <%= link_to milk_analytics_path, class: "btn btn-outline-info" do %>
        <i class="fas fa-chart-line me-1"></i>
        Analytics
      <% end %>
      
      <%= link_to new_procurement_schedule_path, class: "btn btn-success" do %>
        <i class="fas fa-plus me-1"></i>
        New Schedule
      <% end %>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="card shadow-sm mb-4">
    <div class="card-body py-3">
      <%= form_with url: procurement_schedules_path, method: :get, local: true, class: "row g-3 align-items-center" do |form| %>
        <!-- Product Filter -->
        <div class="col-xl-4 col-lg-6">
          <label class="form-label fw-bold text-primary mb-1">
            <i class="fas fa-box me-1"></i>Product Filter
          </label>
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
            <%= form.select :product_id,
                options_for_select([['All Products', '']] + 
                  Product.all.map { |p| ["#{p.name} (#{p.unit_type})", p.id] }, 
                  params[:product_id]),
                {},
                { 
                  class: "form-select",
                  id: "product-filter",
                  onchange: "this.form.submit()"
                } %>
          </div>
        </div>
        
        <!-- Date Range Filter -->
        <div class="col-xl-3 col-lg-6">
          <label class="form-label fw-bold text-primary mb-1">
            <i class="fas fa-calendar me-1"></i>Date Range
          </label>
          <%= form.select :date_range,
              options_for_select([
                ['Today', 'today'],
                ['Weekly', 'weekly'],
                ['Monthly', 'monthly'],
                ['Custom Range', 'custom']
              ], params[:date_range] || 'monthly'),
              {},
              { 
                class: "form-select",
                id: "date-range-select",
                onchange: "toggleCustomDates(); this.form.submit()"
              } %>
        </div>
        
        <!-- Custom Date Fields -->
        <div class="col-xl-5 col-lg-12 custom-dates" style="<%= params[:date_range] == 'custom' ? '' : 'display: none;' %>">
          <label class="form-label fw-bold text-primary mb-1">Custom Date Range</label>
          <div class="row g-2">
            <div class="col">
              <%= form.date_field :from_date, 
                  value: params[:from_date],
                  class: "form-control",
                  placeholder: "From Date" %>
            </div>
            <div class="col">
              <%= form.date_field :to_date, 
                  value: params[:to_date],
                  class: "form-control",
                  placeholder: "To Date" %>
            </div>
            <div class="col-auto">
              <%= form.submit "Apply", class: "btn btn-primary" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Dashboard Cards - 8 Cards Layout -->
  <div class="row mb-4">
    <!-- Card 1: Active Vendors -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-primary text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Active Vendors</div>
              <div class="h3 mb-0 fw-bold"><%= @dashboard_stats[:active_vendors] || 0 %></div>
            </div>
            <div class="ms-3">
              <i class="fas fa-users fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 2: Liters Purchased -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-info text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Liters Purchased</div>
              <div class="h4 mb-0 fw-bold"><%= number_with_delimiter((@dashboard_stats[:liters_purchased] || 0).round(2)) %>L</div>
            </div>
            <div class="ms-3">
              <i class="fas fa-tint fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 3: Purchase Amount -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-warning text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Purchase Amount</div>
              <div class="h4 mb-0 fw-bold">₹<%= number_with_delimiter((@dashboard_stats[:purchase_amount] || 0).round(1)) %></div>
            </div>
            <div class="ms-3">
              <i class="fas fa-rupee-sign fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 4: Liters Delivered -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-success text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Liters Delivered</div>
              <div class="h4 mb-0 fw-bold"><%= number_with_delimiter((@dashboard_stats[:liters_delivered] || 0).round(1)) %>L</div>
            </div>
            <div class="ms-3">
              <i class="fas fa-truck fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 5: Pending Quantity -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-secondary text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Pending</div>
              <div class="h4 mb-0 fw-bold"><%= number_with_delimiter((@dashboard_stats[:pending_quantity] || 0).round(2)) %>L</div>
              <div class="text-white-75 small"><%= (@dashboard_stats[:pending_percentage] || 0).round(1) %>% of procurement</div>
            </div>
            <div class="ms-3">
              <i class="fas fa-clock fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 6: Revenue -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-teal text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Revenue</div>
              <div class="h4 mb-0 fw-bold">₹<%= number_with_delimiter((@dashboard_stats[:revenue] || 0).round(0)) %></div>
            </div>
            <div class="ms-3">
              <i class="fas fa-chart-line fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 7: Loss/Profit -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-<%= (@dashboard_stats[:profit_loss] || 0) >= 0 ? 'success' : 'danger' %> text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">
                <%= (@dashboard_stats[:profit_loss] || 0) >= 0 ? 'Profit' : 'Loss' %>
              </div>
              <div class="h4 mb-0 fw-bold">₹<%= number_with_delimiter(((@dashboard_stats[:profit_loss] || 0).abs).round(1)) %></div>
              <div class="text-white-75 small">Margin: <%= (@dashboard_stats[:profit_margin] || 0).round(1) %>%</div>
            </div>
            <div class="ms-3">
              <i class="fas fa-<%= (@dashboard_stats[:profit_loss] || 0) >= 0 ? 'arrow-up' : 'arrow-down' %> fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 8: Utilization Rate -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-purple text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Utilization Rate</div>
              <div class="h4 mb-0 fw-bold"><%= (@dashboard_stats[:utilization_rate] || 0).round(1) %>%</div>
              <div class="text-white-75 small">Delivered ÷ Procured × 100</div>
            </div>
            <div class="ms-3">
              <i class="fas fa-percentage fa-2x text-white opacity-75"></i>
            </div>
          </div>
          <!-- Progress bar -->
          <div class="progress mt-3" style="height: 4px;">
            <div class="progress-bar bg-white" role="progressbar" 
                 style="width: <%= [(@dashboard_stats[:utilization_rate] || 0), 100].min %>%" 
                 aria-valuenow="<%= (@dashboard_stats[:utilization_rate] || 0) %>" 
                 aria-valuemin="0" aria-valuemax="100">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0 text-primary fw-bold">
                <i class="fas fa-tachometer-alt me-2"></i>
                Dashboard Overview
              </h6>
              <small class="text-muted">
                Showing data for: 
                <span class="fw-bold">
                  <%= case params[:date_range] || 'monthly'
                      when 'today' then 'Today'
                      when 'weekly' then 'This Week' 
                      when 'monthly' then 'This Month'
                      when 'custom' then "#{params[:from_date]} to #{params[:to_date]}"
                      else 'This Month'
                      end %>
                </span>
                <% if params[:product_id].present? %>
                  | Product: <span class="fw-bold"><%= Product.find(params[:product_id]).name rescue 'Unknown' %></span>
                <% end %>
              </small>
            </div>
            <div class="d-flex gap-2">
              <%= link_to procurement_schedules_path, class: "btn btn-outline-secondary btn-sm" do %>
                <i class="fas fa-refresh me-1"></i>Reset Filters
              <% end %>
              <%= link_to milk_analytics_path, class: "btn btn-primary btn-sm" do %>
                <i class="fas fa-chart-bar me-1"></i>Detailed Analytics
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Custom date toggle functionality
  function toggleCustomDates() {
    const dateRangeSelect = document.getElementById('date-range-select');
    const customDatesDiv = document.querySelector('.custom-dates');
    
    if (dateRangeSelect && customDatesDiv) {
      if (dateRangeSelect.value === 'custom') {
        customDatesDiv.style.display = 'block';
      } else {
        customDatesDiv.style.display = 'none';
      }
    }
  }
  
  // Make toggle function globally available
  window.toggleCustomDates = toggleCustomDates;
  
  // Initialize on page load
  toggleCustomDates();
});
</script>

<style>
.avatar {
  width: 2.5rem;
  height: 2.5rem;
}

.avatar-title {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  font-weight: 600;
}

.table th {
  border-top: none;
  font-weight: 600;
  color: #5a5c69;
  background-color: #f8f9fc;
}

.table td {
  vertical-align: middle;
}

.progress {
  background-color: #e9ecef;
}

.badge {
  font-size: 0.75em;
  padding: 0.375em 0.75em;
}

.badge-success {
  background-color: #1cc88a;
}

.badge-secondary {
  background-color: #858796;
}

.badge-primary {
  background-color: #4e73df;
}

.badge-danger {
  background-color: #e74a3b;
}

.badge-light {
  background-color: #f8f9fc;
  color: #5a5c69;
}

.border-left-primary {
  border-left: 0.25rem solid #4e73df!important;
}

.border-left-success {
  border-left: 0.25rem solid #1cc88a!important;
}

.border-left-info {
  border-left: 0.25rem solid #36b9cc!important;
}

.border-left-warning {
  border-left: 0.25rem solid #f6c23e!important;
}

.card {
  border: none;
  box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

.dropdown-menu {
  border: none;
  box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}
</style>
<% content_for :title, "Milk Procurement Schedules" %>

<div class="container-fluid">
  <!-- Header Section -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="h3 mb-0 text-gray-800">
        <i class="fas fa-calendar-alt text-primary me-2"></i>
        Milk Procurement Schedules
      </h1>
      <p class="text-muted mb-0">Manage your milk procurement schedules from farms</p>
    </div>
    
    <div class="d-flex gap-2">
      <%= link_to milk_analytics_path, class: "btn btn-outline-info" do %>
        <i class="fas fa-chart-line me-1"></i>
        Analytics
      <% end %>
      
      <%= link_to new_procurement_schedule_path, class: "btn btn-primary" do %>
        <i class="fas fa-plus me-1"></i>
        New Schedule
      <% end %>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-primary shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                Total Schedules
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                <%= @total_schedules %>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-calendar fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-success shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                Active Schedules
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                <%= @active_schedules %>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-check-circle fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-info shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                Total Planned Cost
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                ₹<%= number_with_delimiter(@total_planned_cost.round(2)) %>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-rupee-sign fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-warning shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                Expected Revenue
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                ₹<%= number_with_delimiter(@total_planned_revenue.round(2)) %>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-chart-line fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">
        <i class="fas fa-filter me-2"></i>
        Filters
      </h6>
    </div>
    <div class="card-body">
      <%= form_with url: procurement_schedules_path, method: :get, local: true, class: "row g-3" do |form| %>
        <div class="col-md-3">
          <%= form.select :vendor, 
              options_for_select([['All Vendors', '']] + @vendors.map { |v| [v, v] }, params[:vendor]),
              {},
              { class: "form-select", placeholder: "Select Vendor" } %>
        </div>
        
        <div class="col-md-3">
          <%= form.select :status, 
              options_for_select([
                ['All Status', ''],
                ['Active', 'active'],
                ['Inactive', 'inactive'],
                ['Completed', 'completed'],
                ['Cancelled', 'cancelled']
              ], params[:status]),
              {},
              { class: "form-select" } %>
        </div>
        
        <div class="col-md-2">
          <%= form.date_field :date_from, 
              value: params[:date_from],
              class: "form-control",
              placeholder: "From Date" %>
        </div>
        
        <div class="col-md-2">
          <%= form.date_field :date_to, 
              value: params[:date_to],
              class: "form-control",
              placeholder: "To Date" %>
        </div>
        
        <div class="col-md-2">
          <div class="d-flex gap-2">
            <%= form.submit "Filter", class: "btn btn-primary btn-sm" %>
            <%= link_to procurement_schedules_path, class: "btn btn-outline-secondary btn-sm" do %>
              Clear
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Schedules Table -->
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">
        <i class="fas fa-table me-2"></i>
        Procurement Schedules
      </h6>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="schedulesTable">
          <thead class="table-light">
            <tr>
              <th>Vendor</th>
              <th>Period</th>
              <th>Daily Quantity</th>
              <th>Buying Price</th>
              <th>Selling Price</th>
              <th>Status</th>
              <th>Total Cost</th>
              <th>Expected Profit</th>
              <th>Completion</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if @procurement_schedules.any? %>
              <% @procurement_schedules.each do |schedule| %>
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="avatar avatar-sm me-3">
                        <div class="avatar-title bg-primary text-white rounded-circle">
                          <%= schedule.vendor_name.first.upcase %>
                        </div>
                      </div>
                      <div>
                        <div class="font-weight-bold"><%= schedule.vendor_name %></div>
                        <small class="text-muted"><%= schedule.unit.capitalize %></small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="text-sm">
                      <div><%= schedule.from_date.strftime('%b %d, %Y') %></div>
                      <div class="text-muted">to <%= schedule.to_date.strftime('%b %d, %Y') %></div>
                      <small class="badge badge-light"><%= schedule.duration_in_days %> days</small>
                    </div>
                  </td>
                  <td>
                    <span class="font-weight-bold"><%= number_with_delimiter(schedule.quantity) %></span>
                    <small class="text-muted">/<%= schedule.unit %></small>
                  </td>
                  <td>
                    <span class="text-danger">₹<%= number_with_delimiter(schedule.buying_price) %></span>
                  </td>
                  <td>
                    <span class="text-success">₹<%= number_with_delimiter(schedule.selling_price) %></span>
                  </td>
                  <td>
                    <% case schedule.status %>
                    <% when 'active' %>
                      <span class="badge badge-success">Active</span>
                    <% when 'inactive' %>
                      <span class="badge badge-secondary">Inactive</span>
                    <% when 'completed' %>
                      <span class="badge badge-primary">Completed</span>
                    <% when 'cancelled' %>
                      <span class="badge badge-danger">Cancelled</span>
                    <% end %>
                  </td>
                  <td>
                    <span class="text-warning">₹<%= number_with_delimiter(schedule.total_planned_cost.round(2)) %></span>
                  </td>
                  <td>
                    <span class="<%= schedule.planned_profit >= 0 ? 'text-success' : 'text-danger' %>">
                      ₹<%= number_with_delimiter(schedule.planned_profit.round(2)) %>
                    </span>
                    <br>
                    <small class="text-muted">
                      <%= schedule.profit_margin_percentage %>% margin
                    </small>
                  </td>
                  <td>
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar bg-info" role="progressbar" 
                           style="width: <%= schedule.completion_percentage %>%" 
                           aria-valuenow="<%= schedule.completion_percentage %>" 
                           aria-valuemin="0" aria-valuemax="100">
                        <%= schedule.completion_percentage %>%
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="dropdown">
                      <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        Actions
                      </button>
                      <ul class="dropdown-menu">
                        <li>
                          <%= link_to procurement_schedule_path(schedule), class: "dropdown-item" do %>
                            <i class="fas fa-eye me-2"></i>View Details
                          <% end %>
                        </li>
                        <% if schedule.can_be_edited? %>
                          <li>
                            <%= link_to edit_procurement_schedule_path(schedule), class: "dropdown-item" do %>
                              <i class="fas fa-edit me-2"></i>Edit
                            <% end %>
                          </li>
                        <% end %>
                        <li>
                          <%= link_to procurement_assignments_path(procurement_schedule_id: schedule.id), class: "dropdown-item" do %>
                            <i class="fas fa-tasks me-2"></i>View Assignments
                          <% end %>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <%= link_to procurement_schedule_path(schedule), 
                              method: :delete,
                              class: "dropdown-item text-danger",
                              confirm: "Are you sure you want to delete this schedule? This will also delete all associated assignments." do %>
                            <i class="fas fa-trash me-2"></i>Delete
                          <% end %>
                        </li>
                      </ul>
                    </div>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="10" class="text-center py-4">
                  <div class="text-muted">
                    <i class="fas fa-calendar-times fa-3x mb-3"></i>
                    <h5>No procurement schedules found</h5>
                    <p>Create your first procurement schedule to start tracking milk purchases.</p>
                    <%= link_to new_procurement_schedule_path, class: "btn btn-primary" do %>
                      <i class="fas fa-plus me-1"></i>
                      Create Schedule
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <% if @procurement_schedules.respond_to?(:current_page) %>
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="text-muted">
            Showing <%= @procurement_schedules.offset_value + 1 %> to 
            <%= [@procurement_schedules.offset_value + @procurement_schedules.limit_value, @procurement_schedules.total_count].min %> 
            of <%= @procurement_schedules.total_count %> entries
          </div>
          
          <%= paginate @procurement_schedules, theme: 'twitter-bootstrap-4' if @procurement_schedules.total_pages > 1 %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize DataTable if needed
  const table = document.getElementById('schedulesTable');
  if (table && typeof DataTable !== 'undefined') {
    new DataTable(table, {
      pageLength: 10,
      responsive: true,
      order: [[1, 'desc']], // Sort by period (newest first)
      columnDefs: [
        { orderable: false, targets: [8, 9] } // Disable sorting for progress and actions
      ]
    });
  }
  
  // Auto-submit form on filter change
  const filterSelects = document.querySelectorAll('select[name="vendor"], select[name="status"]');
  filterSelects.forEach(select => {
    select.addEventListener('change', function() {
      this.form.submit();
    });
  });
});
</script>

<style>
.avatar {
  width: 2.5rem;
  height: 2.5rem;
}

.avatar-title {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  font-weight: 600;
}

.table th {
  border-top: none;
  font-weight: 600;
  color: #5a5c69;
  background-color: #f8f9fc;
}

.table td {
  vertical-align: middle;
}

.progress {
  background-color: #e9ecef;
}

.badge {
  font-size: 0.75em;
  padding: 0.375em 0.75em;
}

.badge-success {
  background-color: #1cc88a;
}

.badge-secondary {
  background-color: #858796;
}

.badge-primary {
  background-color: #4e73df;
}

.badge-danger {
  background-color: #e74a3b;
}

.badge-light {
  background-color: #f8f9fc;
  color: #5a5c69;
}

.border-left-primary {
  border-left: 0.25rem solid #4e73df!important;
}

.border-left-success {
  border-left: 0.25rem solid #1cc88a!important;
}

.border-left-info {
  border-left: 0.25rem solid #36b9cc!important;
}

.border-left-warning {
  border-left: 0.25rem solid #f6c23e!important;
}

.card {
  border: none;
  box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

.dropdown-menu {
  border: none;
  box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}
</style>
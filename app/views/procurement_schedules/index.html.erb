<% content_for :title, "Procurement Dashboard" %>

<div class="container-fluid">
  <!-- Header Section -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="h2 mb-0 text-gray-800">
        <i class="fas fa-chart-pie text-primary me-3"></i>
        Procurement Dashboard
      </h1>
      <p class="text-muted mb-0 fs-5">Monitor your milk procurement performance and metrics</p>
    </div>
    
    <div class="d-flex gap-2">
      <%= link_to milk_analytics_path, class: "btn btn-outline-info" do %>
        <i class="fas fa-chart-line me-1"></i>
        Analytics
      <% end %>
      
      <%= link_to new_procurement_schedule_path, class: "btn btn-success" do %>
        <i class="fas fa-plus me-1"></i>
        New Schedule
      <% end %>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="card shadow-sm mb-4">
    <div class="card-body py-3">
      <%= form_with url: procurement_schedules_path, method: :get, local: true, class: "row g-3 align-items-center" do |form| %>
        <!-- Product Filter -->
        <div class="col-xl-4 col-lg-6">
          <label class="form-label fw-bold text-primary mb-1">
            <i class="fas fa-box me-1"></i>Product Filter
          </label>
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
            <%= form.select :product_id,
                options_for_select([['All Products', '']] + 
                  Product.all.map { |p| ["#{p.name} (#{p.unit_type})", p.id] }, 
                  params[:product_id]),
                {},
                { 
                  class: "form-select",
                  id: "product-filter",
                  onchange: "this.form.submit()"
                } %>
          </div>
        </div>
        
        <!-- Date Range Filter -->
        <div class="col-xl-3 col-lg-6">
          <label class="form-label fw-bold text-primary mb-1">
            <i class="fas fa-calendar me-1"></i>Date Range
          </label>
          <%= form.select :date_range,
              options_for_select([
                ['Today', 'today'],
                ['Weekly', 'weekly'],
                ['Monthly', 'monthly'],
                ['Custom Range', 'custom']
              ], params[:date_range] || 'monthly'),
              {},
              { 
                class: "form-select",
                id: "date-range-select",
                onchange: "toggleCustomDates(); this.form.submit()"
              } %>
        </div>
        
        <!-- Custom Date Fields -->
        <div class="col-xl-5 col-lg-12 custom-dates" style="<%= params[:date_range] == 'custom' ? '' : 'display: none;' %>">
          <label class="form-label fw-bold text-primary mb-1">Custom Date Range</label>
          <div class="row g-2">
            <div class="col">
              <%= form.date_field :from_date, 
                  value: params[:from_date],
                  class: "form-control",
                  placeholder: "From Date" %>
            </div>
            <div class="col">
              <%= form.date_field :to_date, 
                  value: params[:to_date],
                  class: "form-control",
                  placeholder: "To Date" %>
            </div>
            <div class="col-auto">
              <%= form.submit "Apply", class: "btn btn-primary" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Procurement Dashboard - 8 Cards Layout -->
  <div class="row mb-4">
    <!-- Card 1: Active Vendors -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-primary text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Active Vendors</div>
              <div class="h3 mb-0 fw-bold"><%= @dashboard_stats[:active_vendors] || 0 %></div>
            </div>
            <div class="ms-3">
              <i class="fas fa-users fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 2: Liters Purchased -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-info text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Liters Purchased</div>
              <div class="h3 mb-0 fw-bold"><%= number_with_delimiter((@dashboard_stats[:liters_purchased] || 0).round(2)) %>L</div>
            </div>
            <div class="ms-3">
              <i class="fas fa-tint fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 3: Purchase Amount -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-warning text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Purchase Amount</div>
              <div class="h3 mb-0 fw-bold">₹<%= number_with_delimiter((@dashboard_stats[:purchase_amount] || 0).round(1)) %></div>
            </div>
            <div class="ms-3">
              <i class="fas fa-rupee-sign fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 4: Liters Delivered -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-success text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Liters Delivered</div>
              <div class="h3 mb-0 fw-bold"><%= number_with_delimiter((@dashboard_stats[:liters_delivered] || 0).round(1)) %>L</div>
            </div>
            <div class="ms-3">
              <i class="fas fa-truck fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 5: Pending -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-secondary text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Pending</div>
              <div class="h3 mb-0 fw-bold"><%= number_with_delimiter((@dashboard_stats[:pending_quantity] || 0).round(2)) %>L</div>
              <div class="text-white-75 small"><%= (@dashboard_stats[:pending_percentage] || 0).round(1) %>% of procurement</div>
            </div>
            <div class="ms-3">
              <i class="fas fa-clock fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 6: Revenue -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-teal text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Revenue</div>
              <div class="h3 mb-0 fw-bold">₹<%= number_with_delimiter((@dashboard_stats[:revenue] || 0).round(1)) %></div>
            </div>
            <div class="ms-3">
              <i class="fas fa-chart-line fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 7: Loss -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-<%= (@dashboard_stats[:profit_loss] || 0) >= 0 ? 'success' : 'danger' %> text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">
                <%= (@dashboard_stats[:profit_loss] || 0) >= 0 ? 'Profit' : 'Loss' %>
              </div>
              <div class="h3 mb-0 fw-bold">₹<%= number_with_delimiter(((@dashboard_stats[:profit_loss] || 0).abs).round(1)) %></div>
              <div class="text-white-75 small">Profit Margin <%= (@dashboard_stats[:profit_margin] || 0).round(1) %>%</div>
            </div>
            <div class="ms-3">
              <i class="fas fa-<%= (@dashboard_stats[:profit_loss] || 0) >= 0 ? 'arrow-up' : 'arrow-down' %> fa-2x text-white opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 8: Utilization Rate & Wastage Cost -->
    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
      <div class="card gradient-purple text-white shadow-lg h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <div class="text-white-75 text-uppercase mb-1 fw-bold small">Utilization Rate</div>
              <div class="h3 mb-0 fw-bold"><%= (@dashboard_stats[:utilization_rate] || 0).round(1) %>%</div>
              <div class="text-white-75 small">Delivered ÷ Procured × 100</div>
            </div>
            <div class="ms-3">
              <i class="fas fa-percentage fa-2x text-white opacity-75"></i>
            </div>
          </div>
          <div class="mt-3">
            <div class="text-white-75 small fw-bold">Wastage Cost</div>
            <div class="h5 mb-0 fw-bold text-white">₹<%= number_with_delimiter((@dashboard_stats[:wastage_cost] || 0).round(0)) %></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0 text-primary fw-bold">
                <i class="fas fa-tachometer-alt me-2"></i>
                Dashboard Overview
              </h6>
              <small class="text-muted">
                Showing data for: 
                <span class="fw-bold">
                  <%= case params[:date_range] || 'monthly'
                      when 'today' then 'Today'
                      when 'weekly' then 'This Week' 
                      when 'monthly' then 'This Month'
                      when 'custom' then "#{params[:from_date]} to #{params[:to_date]}"
                      else 'This Month'
                      end %>
                </span>
                <% if params[:product_id].present? %>
                  | Product: <span class="fw-bold"><%= Product.find(params[:product_id]).name rescue 'Unknown' %></span>
                <% end %>
              </small>
            </div>
            <div class="d-flex gap-2">
              <%= link_to procurement_schedules_path, class: "btn btn-outline-secondary btn-sm" do %>
                <i class="fas fa-refresh me-1"></i>Reset Filters
              <% end %>
              <%= link_to milk_analytics_path, class: "btn btn-primary btn-sm" do %>
                <i class="fas fa-chart-bar me-1"></i>Detailed Analytics
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Custom date toggle functionality
  function toggleCustomDates() {
    const dateRangeSelect = document.getElementById('date-range-select');
    const customDatesDiv = document.querySelector('.custom-dates');
    
    if (dateRangeSelect && customDatesDiv) {
      if (dateRangeSelect.value === 'custom') {
        customDatesDiv.style.display = 'block';
      } else {
        customDatesDiv.style.display = 'none';
      }
    }
  }
  
  // Make toggle function globally available
  window.toggleCustomDates = toggleCustomDates;
  
  // Initialize on page load
  toggleCustomDates();
});
</script>

<style>
/* Dashboard Card Gradients */
.gradient-primary {
  background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
}

.gradient-info {
  background: linear-gradient(135deg, #36b9cc 0%, #258391 100%);
}

.gradient-warning {
  background: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
}

.gradient-success {
  background: linear-gradient(135deg, #1cc88a 0%, #17a673 100%);
}

.gradient-secondary {
  background: linear-gradient(135deg, #858796 0%, #60616f 100%);
}

.gradient-teal {
  background: linear-gradient(135deg, #20c997 0%, #1aa179 100%);
}

.gradient-danger {
  background: linear-gradient(135deg, #e74a3b 0%, #c02d1d 100%);
}

.gradient-purple {
  background: linear-gradient(135deg, #6f42c1 0%, #59359a 100%);
}

/* Card Styling */
.card {
  border: none;
  box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
  border-radius: 0.75rem;
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

/* Text Colors */
.text-white-75 {
  color: rgba(255, 255, 255, 0.8) !important;
}

.opacity-75 {
  opacity: 0.75 !important;
}

/* Progress bars */
.progress {
  background-color: rgba(255, 255, 255, 0.2);
  border-radius: 10px;
}

.progress-bar {
  border-radius: 10px;
}

/* Filter Section */
.form-select:focus,
.form-control:focus {
  border-color: #4e73df;
  box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

.input-group-text {
  background-color: #f8f9fc;
  border-color: #d1d3e2;
}

/* Custom Date Fields */
.custom-dates {
  transition: all 0.3s ease;
}

/* Button Styling */
.btn-primary {
  background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
  border: none;
}

.btn-primary:hover {
  background: linear-gradient(135deg, #224abe 0%, #1e3a8a 100%);
}

.btn-success {
  background: linear-gradient(135deg, #1cc88a 0%, #17a673 100%);
  border: none;
}

.btn-success:hover {
  background: linear-gradient(135deg, #17a673 0%, #138f5e 100%);
}
</style>
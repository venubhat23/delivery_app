<% content_for :title, "New Milk Purchase Schedule" %>

<div class="container-fluid">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-md-8">
      <h1 class="h3 mb-2">
        <i class="fas fa-plus-circle text-success me-2"></i>
        New Milk Purchase Schedule
      </h1>
      <p class="text-muted">Create a new milk procurement schedule from farms</p>
    </div>
    <div class="col-md-4 text-end">
      <%= link_to analytics_procurement_schedules_path, class: "btn btn-outline-secondary me-2" do %>
        <i class="fas fa-arrow-left me-2"></i>
        Back to Dashboard
      <% end %>
      <%= link_to procurement_schedules_path, class: "btn btn-outline-primary" do %>
        <i class="fas fa-list me-2"></i>
        All Schedules
      <% end %>
    </div>
  </div>

  <!-- Form Section -->
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="fas fa-farm me-2"></i>
            Procurement Schedule Details
          </h5>
        </div>
        <div class="card-body">
          <%= form_with model: @procurement_schedule, local: true, class: "needs-validation", novalidate: true do |form| %>
            
            <!-- Error Messages -->
            <% if @procurement_schedule.errors.any? %>
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <h6 class="alert-heading">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  Please fix the following errors:
                </h6>
                <ul class="mb-0">
                  <% @procurement_schedule.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            <% end %>

            <!-- Vendor Information -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="text-primary mb-3">
                  <i class="fas fa-building me-2"></i>
                  Vendor Information
                </h6>
              </div>
              
              <div class="col-md-6">
                <%= form.label :vendor_name, "Farm/Vendor Name *", class: "form-label fw-bold" %>
                <%= form.text_field :vendor_name, 
                    class: "form-control #{'is-invalid' if @procurement_schedule.errors[:vendor_name].any?}",
                    placeholder: "e.g., Green Valley Farm",
                    required: true,
                    autocomplete: "off",
                    data: { 
                      bs_toggle: "tooltip",
                      bs_placement: "top",
                      bs_title: "Enter the name of the farm or vendor you're purchasing milk from"
                    } %>
                <% if @procurement_schedule.errors[:vendor_name].any? %>
                  <div class="invalid-feedback">
                    <%= @procurement_schedule.errors[:vendor_name].first %>
                  </div>
                <% end %>
              </div>

              <div class="col-md-6">
                <%= form.label :status, "Status", class: "form-label fw-bold" %>
                <%= form.select :status, 
                    options_for_select([
                      ['Active', 'active'],
                      ['Inactive', 'inactive']
                    ], @procurement_schedule.status),
                    {},
                    class: "form-select #{'is-invalid' if @procurement_schedule.errors[:status].any?}" %>
                <% if @procurement_schedule.errors[:status].any? %>
                  <div class="invalid-feedback">
                    <%= @procurement_schedule.errors[:status].first %>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Schedule Period -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="text-primary mb-3">
                  <i class="fas fa-calendar-alt me-2"></i>
                  Schedule Period
                </h6>
              </div>
              
              <div class="col-md-6">
                <%= form.label :from_date, "From Date *", class: "form-label fw-bold" %>
                <%= form.date_field :from_date, 
                    class: "form-control #{'is-invalid' if @procurement_schedule.errors[:from_date].any?}",
                    required: true,
                    min: Date.current,
                    data: { 
                      bs_toggle: "tooltip",
                      bs_placement: "top",
                      bs_title: "Start date of the procurement schedule"
                    } %>
                <% if @procurement_schedule.errors[:from_date].any? %>
                  <div class="invalid-feedback">
                    <%= @procurement_schedule.errors[:from_date].first %>
                  </div>
                <% end %>
              </div>

              <div class="col-md-6">
                <%= form.label :to_date, "To Date *", class: "form-label fw-bold" %>
                <%= form.date_field :to_date, 
                    class: "form-control #{'is-invalid' if @procurement_schedule.errors[:to_date].any?}",
                    required: true,
                    data: { 
                      bs_toggle: "tooltip",
                      bs_placement: "top",
                      bs_title: "End date of the procurement schedule"
                    } %>
                <% if @procurement_schedule.errors[:to_date].any? %>
                  <div class="invalid-feedback">
                    <%= @procurement_schedule.errors[:to_date].first %>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Quantity and Unit -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="text-primary mb-3">
                  <i class="fas fa-weight me-2"></i>
                  Daily Quantity & Unit
                </h6>
              </div>
              
              <div class="col-md-6">
                <%= form.label :quantity, "Daily Quantity *", class: "form-label fw-bold" %>
                <div class="input-group">
                  <%= form.number_field :quantity, 
                      class: "form-control #{'is-invalid' if @procurement_schedule.errors[:quantity].any?}",
                      placeholder: "100",
                      required: true,
                      min: 0.01,
                      step: 0.01,
                      data: { 
                        bs_toggle: "tooltip",
                        bs_placement: "top",
                        bs_title: "Daily quantity of milk to be purchased"
                      } %>
                  <%= form.select :unit, 
                      options_for_select([
                        ['Liters', 'liters'],
                        ['Gallons', 'gallons']
                      ], @procurement_schedule.unit),
                      {},
                      class: "form-select" %>
                </div>
                <% if @procurement_schedule.errors[:quantity].any? %>
                  <div class="invalid-feedback">
                    <%= @procurement_schedule.errors[:quantity].first %>
                  </div>
                <% end %>
                <small class="form-text text-muted">This quantity will be scheduled for each day in the period</small>
              </div>

              <div class="col-md-6">
                <div class="alert alert-info">
                  <h6 class="alert-heading">
                    <i class="fas fa-info-circle me-2"></i>
                    Auto-Generation
                  </h6>
                  <p class="mb-0 small">
                    Daily procurement assignments will be automatically created for each day in your selected period.
                    You can later update actual quantities received each day.
                  </p>
                </div>
              </div>
            </div>

            <!-- Pricing Information -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="text-primary mb-3">
                  <i class="fas fa-rupee-sign me-2"></i>
                  Pricing Information
                </h6>
              </div>
              
              <div class="col-md-6">
                <%= form.label :buying_price, "Buying Price (per unit) *", class: "form-label fw-bold" %>
                <div class="input-group">
                  <span class="input-group-text">₹</span>
                  <%= form.number_field :buying_price, 
                      class: "form-control #{'is-invalid' if @procurement_schedule.errors[:buying_price].any?}",
                      placeholder: "45.00",
                      required: true,
                      min: 0.01,
                      step: 0.01,
                      data: { 
                        bs_toggle: "tooltip",
                        bs_placement: "top",
                        bs_title: "Price you pay to the vendor per unit"
                      } %>
                </div>
                <% if @procurement_schedule.errors[:buying_price].any? %>
                  <div class="invalid-feedback">
                    <%= @procurement_schedule.errors[:buying_price].first %>
                  </div>
                <% end %>
              </div>

              <div class="col-md-6">
                <%= form.label :selling_price, "Selling Price (per unit) *", class: "form-label fw-bold" %>
                <div class="input-group">
                  <span class="input-group-text">₹</span>
                  <%= form.number_field :selling_price, 
                      class: "form-control #{'is-invalid' if @procurement_schedule.errors[:selling_price].any?}",
                      placeholder: "55.00",
                      required: true,
                      min: 0.01,
                      step: 0.01,
                      data: { 
                        bs_toggle: "tooltip",
                        bs_placement: "top",
                        bs_title: "Price you sell to customers per unit"
                      } %>
                </div>
                <% if @procurement_schedule.errors[:selling_price].any? %>
                  <div class="invalid-feedback">
                    <%= @procurement_schedule.errors[:selling_price].first %>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Profit Calculation Preview -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card bg-light">
                  <div class="card-body">
                    <h6 class="card-title">
                      <i class="fas fa-calculator me-2"></i>
                      Profit Calculation Preview
                    </h6>
                    <div class="row" id="profitPreview">
                      <div class="col-md-3">
                        <small class="text-muted">Daily Profit:</small>
                        <div class="fw-bold" id="dailyProfit">₹0.00</div>
                      </div>
                      <div class="col-md-3">
                        <small class="text-muted">Total Days:</small>
                        <div class="fw-bold" id="totalDays">0</div>
                      </div>
                      <div class="col-md-3">
                        <small class="text-muted">Total Quantity:</small>
                        <div class="fw-bold" id="totalQuantity">0 L</div>
                      </div>
                      <div class="col-md-3">
                        <small class="text-muted">Expected Profit:</small>
                        <div class="fw-bold text-success" id="totalProfit">₹0.00</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Notes -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="text-primary mb-3">
                  <i class="fas fa-sticky-note me-2"></i>
                  Additional Notes
                </h6>
                <%= form.label :notes, "Notes (Optional)", class: "form-label fw-bold" %>
                <%= form.text_area :notes, 
                    class: "form-control #{'is-invalid' if @procurement_schedule.errors[:notes].any?}",
                    rows: 3,
                    placeholder: "Any additional information about this procurement schedule...",
                    data: { 
                      bs_toggle: "tooltip",
                      bs_placement: "top",
                      bs_title: "Optional notes about the procurement schedule"
                    } %>
                <% if @procurement_schedule.errors[:notes].any? %>
                  <div class="invalid-feedback">
                    <%= @procurement_schedule.errors[:notes].first %>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="row">
              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <%= link_to analytics_procurement_schedules_path, class: "btn btn-outline-secondary" do %>
                      <i class="fas fa-times me-2"></i>
                      Cancel
                    <% end %>
                  </div>
                  <div>
                    <%= form.submit "Create Schedule & Generate Daily Assignments", 
                        class: "btn btn-success btn-lg",
                        data: { 
                          bs_toggle: "tooltip",
                          bs_placement: "top",
                          bs_title: "This will create the schedule and automatically generate daily procurement assignments"
                        } %>
                  </div>
                </div>
              </div>
            </div>

          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for form enhancements -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Form validation
    const form = document.querySelector('.needs-validation');
    if (form) {
      form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      });
    }

    // Real-time profit calculation
    function updateProfitPreview() {
      const quantity = parseFloat(document.getElementById('procurement_schedule_quantity').value) || 0;
      const buyingPrice = parseFloat(document.getElementById('procurement_schedule_buying_price').value) || 0;
      const sellingPrice = parseFloat(document.getElementById('procurement_schedule_selling_price').value) || 0;
      const fromDate = document.getElementById('procurement_schedule_from_date').value;
      const toDate = document.getElementById('procurement_schedule_to_date').value;
      const unit = document.getElementById('procurement_schedule_unit').value;

      let totalDays = 0;
      if (fromDate && toDate) {
        const start = new Date(fromDate);
        const end = new Date(toDate);
        totalDays = Math.max(0, Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1);
      }

      const dailyProfit = (sellingPrice - buyingPrice) * quantity;
      const totalQuantity = quantity * totalDays;
      const totalProfit = dailyProfit * totalDays;

      document.getElementById('dailyProfit').textContent = `₹${dailyProfit.toFixed(2)}`;
      document.getElementById('totalDays').textContent = totalDays;
      document.getElementById('totalQuantity').textContent = `${totalQuantity.toFixed(2)} ${unit === 'liters' ? 'L' : 'Gal'}`;
      document.getElementById('totalProfit').textContent = `₹${totalProfit.toFixed(2)}`;
      
      // Update profit color
      const profitElement = document.getElementById('totalProfit');
      if (totalProfit > 0) {
        profitElement.className = 'fw-bold text-success';
      } else if (totalProfit < 0) {
        profitElement.className = 'fw-bold text-danger';
      } else {
        profitElement.className = 'fw-bold text-muted';
      }
    }

    // Attach event listeners for real-time calculation
    ['procurement_schedule_quantity', 'procurement_schedule_buying_price', 'procurement_schedule_selling_price', 
     'procurement_schedule_from_date', 'procurement_schedule_to_date', 'procurement_schedule_unit'].forEach(function(id) {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('input', updateProfitPreview);
        element.addEventListener('change', updateProfitPreview);
      }
    });

    // Initial calculation
    updateProfitPreview();

    // Vendor name autocomplete (if you want to implement this later)
    const vendorInput = document.getElementById('procurement_schedule_vendor_name');
    if (vendorInput) {
      // You can implement autocomplete functionality here
      // using the vendor_suggestions endpoint from the controller
    }

    // Date validation
    const fromDateInput = document.getElementById('procurement_schedule_from_date');
    const toDateInput = document.getElementById('procurement_schedule_to_date');
    
    if (fromDateInput && toDateInput) {
      fromDateInput.addEventListener('change', function() {
        toDateInput.min = this.value;
        if (toDateInput.value && toDateInput.value < this.value) {
          toDateInput.value = this.value;
        }
        updateProfitPreview();
      });
      
      toDateInput.addEventListener('change', function() {
        if (fromDateInput.value && this.value < fromDateInput.value) {
          this.value = fromDateInput.value;
        }
        updateProfitPreview();
      });
    }
  });
</script>
<% content_for :title, "Milk Supply & Analytics Dashboard" %>

<div class="container-fluid">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-md-8">
      <h1 class="h3 mb-2">
        <i class="fas fa-tint text-primary me-2"></i>
        Milk Supply & Analytics Dashboard
      </h1>
      <p class="text-muted">Track milk procurement, compare with deliveries, and analyze profits</p>
    </div>
    <div class="col-md-4 text-end">
      <%= link_to new_procurement_schedule_path, class: "btn btn-primary btn-lg" do %>
        <i class="fas fa-plus me-2"></i>
        New Milk Purchase Schedule
      <% end %>
    </div>
  </div>

  <!-- Date Filter Section -->
  <div class="card mb-4">
    <div class="card-body">
      <%= form_with url: analytics_procurement_schedules_path, method: :get, local: true, class: "row g-3 align-items-end" do |form| %>
        <div class="col-md-3">
          <%= form.label :start_date, "From Date", class: "form-label fw-bold" %>
          <%= form.date_field :start_date, value: @start_date, class: "form-control" %>
        </div>
        <div class="col-md-3">
          <%= form.label :end_date, "To Date", class: "form-label fw-bold" %>
          <%= form.date_field :end_date, value: @end_date, class: "form-control" %>
        </div>
        <div class="col-md-3">
          <%= form.submit "Filter Data", class: "btn btn-outline-primary" %>
          <%= link_to "Reset", analytics_procurement_schedules_path, class: "btn btn-outline-secondary ms-2" %>
        </div>
        <div class="col-md-3 text-end">
          <small class="text-muted">
            Showing data for: <strong><%= @start_date.strftime("%b %d") %> - <%= @end_date.strftime("%b %d, %Y") %></strong>
          </small>
        </div>
      <% end %>
    </div>
  </div>

  <!-- KPI Cards Section -->
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card bg-gradient-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-0">Total Milk Purchased</h6>
              <h3 class="mb-0"><%= number_with_delimiter(@kpis[:total_actual_quantity] || 0) %> L</h3>
              <small>Planned: <%= number_with_delimiter(@kpis[:total_planned_quantity] || 0) %> L</small>
            </div>
            <i class="fas fa-tint fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card bg-gradient-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-0">Total Cost</h6>
              <h3 class="mb-0">₹<%= number_with_delimiter(@kpis[:total_actual_cost] || 0) %></h3>
              <small>Planned: ₹<%= number_with_delimiter(@kpis[:total_planned_cost] || 0) %></small>
            </div>
            <i class="fas fa-rupee-sign fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card bg-gradient-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-0">Total Revenue</h6>
              <h3 class="mb-0">₹<%= number_with_delimiter(@kpis[:total_actual_revenue] || 0) %></h3>
              <small>Profit: ₹<%= number_with_delimiter((@kpis[:total_actual_revenue] || 0) - (@kpis[:total_actual_cost] || 0)) %></small>
            </div>
            <i class="fas fa-chart-line fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card bg-gradient-warning text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-0">Completion Rate</h6>
              <h3 class="mb-0"><%= @kpis[:completion_rate] || 0 %>%</h3>
              <small><%= @kpis[:active_vendors] || 0 %> Active Vendors</small>
            </div>
            <i class="fas fa-percentage fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts and Analytics Section -->
  <div class="row mb-4">
    <!-- Milk Purchased vs Delivered Comparison -->
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-balance-scale me-2"></i>
            Milk Purchased vs Delivered
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-4">
              <div class="border-end">
                <h4 class="text-primary"><%= number_with_delimiter(@delivery_comparison[:purchased]) %> L</h4>
                <small class="text-muted">Purchased</small>
              </div>
            </div>
            <div class="col-4">
              <div class="border-end">
                <h4 class="text-success"><%= number_with_delimiter(@delivery_comparison[:delivered]) %> L</h4>
                <small class="text-muted">Delivered</small>
              </div>
            </div>
            <div class="col-4">
              <h4 class="text-<%= @delivery_comparison[:remaining] >= 0 ? 'info' : 'danger' %>">
                <%= number_with_delimiter(@delivery_comparison[:remaining]) %> L
              </h4>
              <small class="text-muted">Remaining</small>
            </div>
          </div>
          
          <div class="progress mt-3" style="height: 25px;">
            <div class="progress-bar bg-success" role="progressbar" style="width: <%= @delivery_comparison[:delivery_percentage] %>%">
              <%= @delivery_comparison[:delivery_percentage] %>% Delivered
            </div>
          </div>
          
          <div class="mt-3">
            <% if @delivery_comparison[:remaining] > 0 %>
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                You have <strong><%= number_with_delimiter(@delivery_comparison[:remaining]) %> liters</strong> of milk remaining in inventory.
              </div>
            <% elsif @delivery_comparison[:remaining] < 0 %>
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                You've delivered <strong><%= number_with_delimiter(@delivery_comparison[:remaining].abs) %> liters</strong> more than purchased. Check your inventory.
              </div>
            <% else %>
              <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                Perfect balance! All purchased milk has been delivered.
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Vendor Comparison Chart -->
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-chart-pie me-2"></i>
            Vendor Comparison
          </h5>
        </div>
        <div class="card-body">
          <% if @vendor_comparison_data.any? %>
            <canvas id="vendorChart" height="200"></canvas>
          <% else %>
            <div class="text-center py-4">
              <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
              <p class="text-muted">No vendor data available for the selected period.</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Profit Analysis and Daily Trends -->
  <div class="row mb-4">
    <!-- Daily Procurement Trends -->
    <div class="col-md-8 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-chart-line me-2"></i>
            Daily Procurement Trends
          </h5>
        </div>
        <div class="card-body">
          <% if @daily_procurement_data.any? %>
            <canvas id="dailyChart" height="100"></canvas>
          <% else %>
            <div class="text-center py-4">
              <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
              <p class="text-muted">No daily procurement data available for the selected period.</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Profit Analysis -->
    <div class="col-md-4 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-calculator me-2"></i>
            Profit Analysis
          </h5>
        </div>
        <div class="card-body">
          <% total_profit = (@kpis[:total_actual_revenue] || 0) - (@kpis[:total_actual_cost] || 0) %>
          <% profit_margin = @kpis[:total_actual_cost] > 0 ? ((total_profit / @kpis[:total_actual_cost]) * 100).round(2) : 0 %>
          
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span>Total Cost:</span>
              <strong>₹<%= number_with_delimiter(@kpis[:total_actual_cost] || 0) %></strong>
            </div>
          </div>
          
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span>Total Revenue:</span>
              <strong>₹<%= number_with_delimiter(@kpis[:total_actual_revenue] || 0) %></strong>
            </div>
          </div>
          
          <hr>
          
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span>Net Profit:</span>
              <strong class="text-<%= total_profit >= 0 ? 'success' : 'danger' %>">
                ₹<%= number_with_delimiter(total_profit) %>
              </strong>
            </div>
          </div>
          
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span>Profit Margin:</span>
              <strong class="text-<%= profit_margin >= 0 ? 'success' : 'danger' %>">
                <%= profit_margin %>%
              </strong>
            </div>
          </div>
          
          <% if @profit_analysis_data[:by_vendor].any? %>
            <hr>
            <h6>By Vendor:</h6>
            <% @profit_analysis_data[:by_vendor].each do |vendor_data| %>
              <div class="d-flex justify-content-between small mb-1">
                <span><%= vendor_data[:vendor] %>:</span>
                <span class="text-<%= vendor_data[:profit] >= 0 ? 'success' : 'danger' %>">
                  ₹<%= number_with_delimiter(vendor_data[:profit]) %>
                </span>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activities and Overdue Items -->
  <div class="row mb-4">
    <!-- Recent Activities -->
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-clock me-2"></i>
            Recent Activities
          </h5>
          <%= link_to "View All", procurement_assignments_path, class: "btn btn-sm btn-outline-primary" %>
        </div>
        <div class="card-body">
          <% if @recent_assignments.any? %>
            <% @recent_assignments.each do |assignment| %>
              <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div>
                  <strong><%= assignment.vendor_name %></strong>
                  <br>
                  <small class="text-muted">
                    <%= assignment.date.strftime("%b %d, %Y") %> - 
                    <%= assignment.actual_quantity || assignment.planned_quantity %> L
                  </small>
                </div>
                <div class="text-end">
                  <span class="badge bg-<%= assignment.status == 'completed' ? 'success' : assignment.status == 'pending' ? 'warning' : 'secondary' %>">
                    <%= assignment.status.titleize %>
                  </span>
                  <br>
                  <small class="text-muted">₹<%= number_with_delimiter(assignment.actual_cost) %></small>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="text-center py-4">
              <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
              <p class="text-muted">No recent activities found.</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Overdue Assignments -->
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
            Overdue Assignments
          </h5>
          <%= link_to "View All", overdue_procurement_assignments_path, class: "btn btn-sm btn-outline-danger" %>
        </div>
        <div class="card-body">
          <% if @overdue_assignments.any? %>
            <% @overdue_assignments.limit(5).each do |assignment| %>
              <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div>
                  <strong class="text-danger"><%= assignment.vendor_name %></strong>
                  <br>
                  <small class="text-muted">
                    Due: <%= assignment.date.strftime("%b %d, %Y") %>
                    (<%= time_ago_in_words(assignment.date) %> ago)
                  </small>
                </div>
                <div class="text-end">
                  <strong><%= assignment.planned_quantity %> L</strong>
                  <br>
                  <small class="text-muted">₹<%= number_with_delimiter(assignment.planned_cost) %></small>
                </div>
              </div>
            <% end %>
            
            <% if @overdue_assignments.count > 5 %>
              <div class="text-center mt-3">
                <small class="text-muted">
                  And <%= @overdue_assignments.count - 5 %> more overdue assignments...
                </small>
              </div>
            <% end %>
          <% else %>
            <div class="text-center py-4">
              <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
              <p class="text-success">Great! No overdue assignments.</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-bolt me-2"></i>
            Quick Actions
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-2">
              <%= link_to new_procurement_schedule_path, class: "btn btn-primary w-100" do %>
                <i class="fas fa-plus me-2"></i>
                New Schedule
              <% end %>
            </div>
            <div class="col-md-3 mb-2">
              <%= link_to today_procurement_assignments_path, class: "btn btn-success w-100" do %>
                <i class="fas fa-calendar-day me-2"></i>
                Today's Tasks
              <% end %>
            </div>
            <div class="col-md-3 mb-2">
              <%= link_to calendar_procurement_assignments_path, class: "btn btn-info w-100" do %>
                <i class="fas fa-calendar me-2"></i>
                Calendar View
              <% end %>
            </div>
            <div class="col-md-3 mb-2">
              <%= link_to procurement_schedules_path, class: "btn btn-outline-primary w-100" do %>
                <i class="fas fa-list me-2"></i>
                All Schedules
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js for Analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Vendor Comparison Chart
    <% if @vendor_comparison_data.any? %>
      const vendorCtx = document.getElementById('vendorChart');
      if (vendorCtx) {
        new Chart(vendorCtx, {
          type: 'doughnut',
          data: {
            labels: <%= @vendor_comparison_data.keys.to_json.html_safe %>,
            datasets: [{
              data: <%= @vendor_comparison_data.values.to_json.html_safe %>,
              backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
    <% end %>

    // Daily Procurement Chart
    <% if @daily_procurement_data.any? %>
      const dailyCtx = document.getElementById('dailyChart');
      if (dailyCtx) {
        // Process daily data for chart
        const dailyData = <%= @daily_procurement_data.to_json.html_safe %>;
        const dates = [...new Set(Object.keys(dailyData).map(key => key.split(' - ')[0]))].sort();
        const vendors = [...new Set(Object.keys(dailyData).map(key => key.split(' - ')[1]))];
        
        const datasets = vendors.map((vendor, index) => ({
          label: vendor,
          data: dates.map(date => dailyData[`${date} - ${vendor}`] || 0),
          borderColor: `hsl(${index * 360 / vendors.length}, 70%, 50%)`,
          backgroundColor: `hsla(${index * 360 / vendors.length}, 70%, 50%, 0.1)`,
          tension: 0.1
        }));

        new Chart(dailyCtx, {
          type: 'line',
          data: {
            labels: dates,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Quantity (Liters)'
                }
              }
            },
            plugins: {
              legend: {
                position: 'top'
              }
            }
          }
        });
      }
    <% end %>
  });
</script>
<!-- Revenue Breakdown Modal Content -->
<div class="p-4">
  <div class="row mb-4 g-3">
    <!-- Summary Cards -->
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm bg-success text-white h-100" style="border-radius: 15px;">
        <div class="card-body text-center p-3">
          <i class="fas fa-rupee-sign fa-2x mb-2"></i>
          <h6 class="card-title mb-1" style="font-size: 12px;">Total Revenue</h6>
          <h5 class="mb-0" style="font-size: 16px;">₹<%= number_with_delimiter(@summary_stats[:total_revenue].round(2)) %></h5>
        </div>
      </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm bg-primary text-white h-100" style="border-radius: 15px;">
        <div class="card-body text-center p-3">
          <i class="fas fa-users fa-2x mb-2"></i>
          <h6 class="card-title mb-1" style="font-size: 12px;">Customers</h6>
          <h5 class="mb-0" style="font-size: 16px;"><%= @summary_stats[:total_customers] %></h5>
        </div>
      </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm bg-info text-white h-100" style="border-radius: 15px;">
        <div class="card-body text-center p-3">
          <i class="fas fa-user-tie fa-2x mb-2"></i>
          <h6 class="card-title mb-1" style="font-size: 12px;">Delivery Staff</h6>
          <h5 class="mb-0" style="font-size: 16px;"><%= @summary_stats[:total_delivery_people] %></h5>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6">
      <div class="card border-0 shadow-sm bg-warning text-dark h-100" style="border-radius: 15px;">
        <div class="card-body text-center p-3">
          <i class="fas fa-tasks fa-2x mb-2"></i>
          <h6 class="card-title mb-1" style="font-size: 12px;">Total Assignments</h6>
          <h5 class="mb-0" style="font-size: 16px;"><%= number_with_delimiter(@summary_stats[:total_assignments]) %></h5>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6">
      <div class="card border-0 shadow-sm bg-secondary text-white h-100" style="border-radius: 15px;">
        <div class="card-body text-center p-3">
          <i class="fas fa-glass-milk fa-2x mb-2"></i>
          <h6 class="card-title mb-1" style="font-size: 12px;">Total Quantity</h6>
          <h5 class="mb-0" style="font-size: 16px;"><%= number_with_precision(@summary_stats[:total_quantity], precision: 1) %> L</h5>
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed Breakdown Table -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm" style="border-radius: 15px;">
        <div class="card-header bg-light d-flex justify-content-between align-items-center" style="border-radius: 15px 15px 0 0;">
          <h6 class="mb-0">
            <i class="fas fa-table me-2"></i>
            Detailed Revenue Breakdown (All <%= @summary_stats[:total_records] %> Records)
          </h6>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary btn-sm" onclick="exportRevenueData()" title="Export to CSV">
              <i class="fas fa-download me-1"></i>Export
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="printRevenueData()" title="Print Report">
              <i class="fas fa-print me-1"></i>Print
            </button>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
            <table class="table table-hover mb-0" style="font-size: 14px;">
              <thead class="table-dark sticky-top">
                <tr>
                  <th class="text-nowrap" style="min-width: 150px;">
                    <i class="fas fa-user me-1"></i>Customer
                  </th>
                  <th class="text-nowrap d-none d-lg-table-cell" style="min-width: 120px;">
                    <i class="fas fa-user-tie me-1"></i>Delivery Person
                  </th>
                  <th class="text-nowrap" style="min-width: 100px;">
                    <i class="fas fa-cube me-1"></i>Product
                  </th>
                  <th class="text-nowrap text-center" style="min-width: 80px;">
                    <i class="fas fa-list-ol me-1"></i>Assignments
                  </th>
                  <th class="text-nowrap text-center d-none d-md-table-cell" style="min-width: 80px;">
                    <i class="fas fa-weight me-1"></i>Quantity
                  </th>
                  <th class="text-nowrap text-end" style="min-width: 100px;">
                    <i class="fas fa-rupee-sign me-1"></i>Total
                  </th>
                  <th class="text-nowrap text-end d-none d-xl-table-cell" style="min-width: 80px;">
                    <i class="fas fa-calculator me-1"></i>Avg
                  </th>
                  <th class="text-nowrap text-center d-none d-lg-table-cell" style="min-width: 80px;">
                    <i class="fas fa-calendar me-1"></i>Period
                  </th>
                  <th class="text-nowrap text-center" style="min-width: 100px;">
                    <i class="fas fa-cogs me-1"></i>Actions
                  </th>
                </tr>
              </thead>
              <tbody>
                <% @revenue_breakdown.each_with_index do |row, index| %>
                  <tr class="<%= 'table-light' if index.even? %>">
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px; font-size: 11px;">
                          <%= row['customer_name'].first.upcase %>
                        </div>
                        <div>
                          <div class="fw-bold text-dark" style="font-size: 13px;"><%= truncate(row['customer_name'], length: 20) %></div>
                          <small class="text-muted d-block d-md-none">ID: <%= row['customer_id'] %></small>
                        </div>
                      </div>
                    </td>
                    <td class="d-none d-lg-table-cell">
                      <div class="d-flex align-items-center">
                        <div class="avatar-sm bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 25px; height: 25px; font-size: 9px;">
                          <%= row['delivery_person_name'].split.map(&:first).join.upcase %>
                        </div>
                        <span class="text-muted small"><%= truncate(row['delivery_person_name'], length: 15) %></span>
                      </div>
                    </td>
                    <td>
                      <div class="d-flex align-items-center">
                        <i class="fas fa-cube text-primary me-1" style="font-size: 12px;"></i>
                        <div>
                          <div class="fw-semibold" style="font-size: 12px;"><%= truncate(row['product_name'], length: 15) %></div>
                          <small class="text-muted d-none d-md-block"><%= row['unit_type'] %></small>
                        </div>
                      </div>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-light text-dark border" style="font-size: 11px;">
                        <strong><%= row['total_assignments'] %></strong>
                      </span>
                    </td>
                    <td class="text-center d-none d-md-table-cell">
                      <div class="fw-bold text-primary" style="font-size: 13px;">
                        <%= number_with_precision(row['total_quantity'], precision: 1) %>
                        <%= row['unit_type'] == 'liters' ? 'L' : row['unit_type'] %>
                      </div>
                    </td>
                    <td class="text-end">
                      <div class="fw-bold text-success" style="font-size: 14px;">
                        ₹<%= number_with_precision(row['total_amount'], precision: 0) %>
                      </div>
                    </td>
                    <td class="text-end d-none d-xl-table-cell">
                      <div class="text-muted" style="font-size: 12px;">
                        ₹<%= number_with_precision(row['avg_amount'], precision: 0) %>
                      </div>
                    </td>
                    <td class="text-center d-none d-lg-table-cell">
                      <div class="text-muted small" style="font-size: 10px;">
                        <div><%= row['first_delivery'].is_a?(Date) ? row['first_delivery'].strftime('%d %b') : Date.parse(row['first_delivery']).strftime('%d %b') %></div>
                        <div>to</div>
                        <div><%= row['last_delivery'].is_a?(Date) ? row['last_delivery'].strftime('%d %b') : Date.parse(row['last_delivery']).strftime('%d %b') %></div>
                      </div>
                    </td>
                    <td class="text-center">
                      <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary btn-sm" onclick="viewCustomerDetails(<%= row['customer_id'] %>)" title="View Customer">
                          <i class="fas fa-eye" style="font-size: 10px;"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="viewDeliveries(<%= row['customer_id'] %>)" title="View Deliveries">
                          <i class="fas fa-truck" style="font-size: 10px;"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                <% end %>
                <% if @revenue_breakdown.empty? %>
                  <tr>
                    <td colspan="9" class="text-center py-4">
                      <i class="fas fa-inbox text-muted fa-3x mb-3"></i>
                      <h5 class="text-muted">No Revenue Data</h5>
                      <p class="text-muted">No delivery assignments found for the selected period and filters.</p>
                    </td>
                  </tr>
                <% end %>
              </tbody>
              <% unless @revenue_breakdown.empty? %>
                <tfoot class="table-light sticky-bottom">
                  <tr>
                    <th colspan="5" class="text-end" style="font-size: 13px;">
                      <strong>Grand Total (<%= @summary_stats[:total_records] %> breakdown records from <%= @summary_stats[:total_assignments] %> assignments):</strong>
                    </th>
                    <th class="text-end">
                      <strong class="text-success" style="font-size: 15px;">₹<%= number_with_precision(@summary_stats[:total_revenue], precision: 0) %></strong>
                    </th>
                    <th colspan="3"></th>
                  </tr>
                </tfoot>
              <% end %>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Manual Calculation & Summary -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card border-0 bg-light">
      <div class="card-body">
        <h6 class="card-title">
          <i class="fas fa-calculator me-2"></i>
          Manual Calculation & Data Verification
        </h6>
        <div class="row">
          <div class="col-md-6">
            <p class="mb-2"><strong>Database Query Results:</strong></p>
            <div class="bg-white p-3 rounded border">
              <div class="row g-2">
                <div class="col-6">
                  <small class="text-muted">Total Assignments:</small>
                  <div class="fw-bold text-primary"><%= number_with_delimiter(@summary_stats[:total_assignments]) %></div>
                </div>
                <div class="col-6">
                  <small class="text-muted">Unique Customers:</small>
                  <div class="fw-bold text-info"><%= @summary_stats[:total_customers] %></div>
                </div>
                <div class="col-6">
                  <small class="text-muted">Delivery Staff:</small>
                  <div class="fw-bold text-warning"><%= @summary_stats[:total_delivery_people] %></div>
                </div>
                <div class="col-6">
                  <small class="text-muted">Total Quantity:</small>
                  <div class="fw-bold text-secondary"><%= number_with_precision(@summary_stats[:total_quantity], precision: 1) %> L</div>
                </div>
                <div class="col-12 mt-2 pt-2 border-top">
                  <small class="text-muted">Final Revenue Total:</small>
                  <div class="fw-bold text-success h5">₹<%= number_with_precision(@summary_stats[:total_revenue], precision: 0) %></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <p class="mb-2"><strong>Calculation Formula:</strong></p>
            <code class="bg-white p-2 rounded d-block small">
              SELECT SUM(final_amount_after_discount)
              FROM delivery_assignments
              WHERE scheduled_date BETWEEN '<%= Date.new(@current_year, @current_month, 1).beginning_of_month.strftime('%Y-%m-%d') %>'
              AND '<%= Date.new(@current_year, @current_month, 1).end_of_month.strftime('%Y-%m-%d') %>'
            </code>
            <p class="mt-2 text-muted small">
              <strong>Data Verification:</strong><br>
              • Table shows <%= @summary_stats[:total_records] %> breakdown records (grouped by customer + product combinations)<br>
              • Based on <%= number_with_delimiter(@summary_stats[:total_assignments]) %> individual delivery assignments<br>
              • Period: <%= @month_name %><br>
              • All amounts include applied discounts
            </p>
          </div>
        </div>

        <!-- Paperwork Details -->
        <div class="row mt-3 pt-3 border-top">
          <div class="col-12">
            <h6 class="text-muted mb-2">
              <i class="fas fa-file-alt me-2"></i>
              Paperwork & Record Details
            </h6>
            <div class="row g-3">
              <div class="col-md-4">
                <div class="bg-white p-2 rounded border-start border-primary border-3">
                  <small class="text-muted">Breakdown Records</small>
                  <div class="fw-bold"><%= @summary_stats[:total_records] %> entries</div>
                  <small class="text-muted">Customer-Product combinations</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="bg-white p-2 rounded border-start border-success border-3">
                  <small class="text-muted">Assignment Records</small>
                  <div class="fw-bold"><%= number_with_delimiter(@summary_stats[:total_assignments]) %> assignments</div>
                  <small class="text-muted">Individual delivery entries</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="bg-white p-2 rounded border-start border-info border-3">
                  <small class="text-muted">Date Range</small>
                  <div class="fw-bold"><%= @month_name %></div>
                  <small class="text-muted"><%= Date.new(@current_year, @current_month, 1).beginning_of_month.strftime('%d %b') %> to <%= Date.new(@current_year, @current_month, 1).end_of_month.strftime('%d %b %Y') %></small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
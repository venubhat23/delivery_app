<!-- Modal content loads here - no header needed as it's in main modal -->

<script>
// Functions are now defined at page level - just verify they exist
console.log('üîß Verifying assignment functions in modal context...');

// Verify functions are available (they're defined at page level now)
if (typeof window.completeTillToday === 'function') {
  console.log('‚úÖ completeTillToday available');
} else {
  console.error('‚ùå completeTillToday not available');
}

if (typeof window.completeAssignment === 'function') {
  console.log('‚úÖ completeAssignment available');
} else {
  console.error('‚ùå completeAssignment not available');
}

if (typeof window.deleteAssignment === 'function') {
  console.log('‚úÖ deleteAssignment available');
} else {
  console.error('‚ùå deleteAssignment not available');
}

if (typeof window.editAssignment === 'function') {
  console.log('‚úÖ editAssignment available');
} else {
  console.error('‚ùå editAssignment not available');
}

// editAssignment function is now defined at page level - no need to redefine here

console.log('‚úÖ Assignment functions loaded:', {
  completeTillToday: typeof window.completeTillToday,
  completeAssignment: typeof window.completeAssignment,
  deleteAssignment: typeof window.deleteAssignment,
  editAssignment: typeof window.editAssignment
});
</script>

<% if @delivery_assignments.any? %>
  <!-- Action Buttons at Top -->
  <% pending_till_today = @delivery_assignments.where(status: 'pending').where('scheduled_date <= ?', Date.current) %>
  <% all_pending = @delivery_assignments.where(status: 'pending') %>
  <% if pending_till_today.any? || all_pending.any? %>
    <div class="mb-4">
      <div class="alert alert-warning d-flex align-items-center">
        <i class="fas fa-exclamation-triangle me-3 fa-2x text-warning"></i>
        <div class="flex-grow-1">
          <strong>‚ö†Ô∏è Pending Assignments Alert</strong><br>
          <small>There are <strong><%= pending_till_today.count %></strong> pending assignments till today and <strong><%= all_pending.count %></strong> total pending assignments.</small>
        </div>
        <div class="btn-group">
          <% if pending_till_today.any? %>
            <button class="btn btn-dark btn-lg shadow" onclick="window.completeTillToday(<%= @customer.id %>, <%= @month %>, <%= @year %>)">
              <i class="fas fa-check-circle me-2"></i>
              Complete Till Today (<%= pending_till_today.count %>)
            </button>
          <% end %>
          <% if all_pending.any? %>
            <button class="btn btn-success btn-lg shadow" onclick="window.completeAll(<%= @customer.id %>, <%= @month %>, <%= @year %>)">
              <i class="fas fa-check-double me-2"></i>
              Complete All (<%= all_pending.count %>)
            </button>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

    <!-- Attractive Table -->
    <div class="card">
      <div class="card-header bg-light">
        <h6 class="mb-0">
          <i class="fas fa-list me-2"></i>
          Assignment Details (<%= @delivery_assignments.count %> items)
        </h6>
      </div>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-dark">
            <tr>
              <th><i class="fas fa-calendar me-1"></i>Date</th>
              <th><i class="fas fa-cube me-1"></i>Product</th>
              <th><i class="fas fa-weight me-1"></i>Quantity</th>
              <th><i class="fas fa-user me-1"></i>Person</th>
              <th><i class="fas fa-info-circle me-1"></i>Status</th>
              <th><i class="fas fa-rupee-sign me-1"></i>Amount</th>
              <th><i class="fas fa-cogs me-1"></i>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @delivery_assignments.each_with_index do |assignment, index| %>
              <tr class="<%= 'table-light' if index.even? %>">
                <td>
                  <div class="d-flex align-items-center">
                    <div class="date-circle bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px; font-size: 12px; font-weight: bold;">
                      <%= assignment.scheduled_date.strftime("%d") %>
                    </div>
                    <div>
                      <div class="fw-semibold"><%= assignment.scheduled_date.strftime("%b %Y") %></div>
                      <small class="text-muted"><%= assignment.scheduled_date.strftime("%A") %></small>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-cube text-primary me-2"></i>
                    <div>
                      <div class="fw-semibold"><%= assignment.product.name %></div>
                      <small class="text-muted"><%= assignment.product.unit_type %></small>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="badge bg-light text-dark border">
                    <strong><%= assignment.quantity %></strong> <%= assignment.unit %>
                  </span>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px; font-size: 12px;">
                      <%= assignment.user.name.first.upcase %>
                    </div>
                    <span class="text-muted small"><%= assignment.user.name %></span>
                  </div>
                </td>
                <td>
                  <% case assignment.status %>
                  <% when 'completed' %>
                    <span class="badge bg-success rounded-pill">
                      <i class="fas fa-check me-1"></i>Completed
                    </span>
                  <% when 'pending' %>
                    <span class="badge bg-warning rounded-pill">
                      <i class="fas fa-clock me-1"></i>Pending
                    </span>
                  <% when 'in_progress' %>
                    <span class="badge bg-info rounded-pill">
                      <i class="fas fa-truck me-1"></i>In Progress
                    </span>
                  <% else %>
                    <span class="badge bg-danger rounded-pill">
                      <i class="fas fa-times me-1"></i>Cancelled
                    </span>
                  <% end %>
                </td>
                <td>
                  <div class="text-success fw-bold">
                    ‚Çπ<%= number_with_precision(assignment.final_amount, precision: 2) %>
                  </div>
                  <% if assignment.has_discount? %>
                    <small class="text-muted">
                      <del>‚Çπ<%= number_with_precision(assignment.total_amount, precision: 2) %></del>
                    </small>
                  <% end %>
                </td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary btn-sm" onclick="window.editAssignment(<%= assignment.id %>)" title="Edit">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="window.completeAssignment(<%= assignment.id %>)" title="Complete" <%= 'disabled' if assignment.status == 'completed' %>>
                      <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="window.deleteAssignment(<%= assignment.id %>)" title="Delete">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot class="table-light">
            <tr>
              <th colspan="5" class="text-end">Total:</th>
              <th>
                <div class="text-success fw-bold">
                  ‚Çπ<%= number_with_precision(@delivery_assignments.sum(&:final_amount), precision: 2) %>
                </div>
              </th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>


<% else %>
  <!-- Attractive Empty State -->
  <div class="text-center py-5">
    <div class="empty-state-icon mb-4">
      <i class="fas fa-calendar-times fa-4x text-muted"></i>
    </div>
    <h4 class="text-muted mb-3">No Assignments Found</h4>
    <p class="text-muted mb-4">
      No delivery assignments were found for <strong><%= @customer.name %></strong> in <strong><%= @month_name %></strong>.
    </p>
    <a href="<%= new_delivery_assignment_path(customer_id: @customer.id) %>" class="btn btn-primary" target="_blank">
      <i class="fas fa-plus me-1"></i>Create New Assignment
    </a>
  </div>
<% end %>
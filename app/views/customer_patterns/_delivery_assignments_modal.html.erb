<div class="modal-header">
  <div>
    <h5 class="modal-title">
      üìã Delivery Assignments - <%= @customer.name %>
      <small class="text-muted">(<%= @month_name %>)</small>
    </h5>
  </div>
  <div class="d-flex gap-2">
    <% pending_till_today = @delivery_assignments.where(status: 'pending').where('scheduled_date <= ?', Date.current) %>
    <% if pending_till_today.any? %>
      <button type="button" class="btn btn-success btn-sm complete-till-today-btn"
              data-customer-id="<%= @customer.id %>"
              data-month="<%= @month.presence || Date.current.month %>"
              data-year="<%= @year.presence || Date.current.year %>">
        ‚úÖ Complete Till Today (<%= pending_till_today.count %>)
      </button>
    <% end %>
    <% if @delivery_assignments.any? %>
      <button type="button" class="btn btn-danger btn-sm remove-all-assignments-btn"
              data-customer-id="<%= @customer.id %>"
              data-customer-name="<%= @customer.name %>"
              data-month="<%= @month.presence || Date.current.month %>"
              data-year="<%= @year.presence || Date.current.year %>"
              data-total-count="<%= @delivery_assignments.count %>">
        üóëÔ∏è Remove All (<%= @delivery_assignments.count %>)
      </button>
    <% end %>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
</div>

<div class="modal-body">
  <% if @delivery_assignments.any? %>
    <div class="mb-3">
      <span class="badge bg-primary me-2">Total: <%= @delivery_assignments.count %> assignments</span>
      <span class="badge bg-success me-2">Completed: <%= @delivery_assignments.completed.count %></span>
      <span class="badge bg-warning text-dark me-2">Pending: <%= @delivery_assignments.pending.count %></span>
      <span class="badge bg-info me-2">In Progress: <%= @delivery_assignments.in_progress.count %></span>
      <span class="badge bg-danger">Cancelled: <%= @delivery_assignments.cancelled.count %></span>
    </div>

    <div class="table-responsive">
      <table class="table table-sm table-hover">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Delivery Person</th>
            <th>Status</th>
            <th>Amount</th>
            <th>Discount</th>
            <th>Final Amount</th>
            <th width="120">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @delivery_assignments.each do |assignment| %>
            <tr>
              <td>
                <div class="fw-semibold"><%= assignment.scheduled_date.strftime("%d %b") %></div>
                <small class="text-muted"><%= assignment.scheduled_date.strftime("%a") %></small>
              </td>
              <td>
                <div class="fw-semibold"><%= assignment.product.name %></div>
                <small class="text-muted"><%= assignment.product.unit_type %></small>
              </td>
              <td>
                <span class="fw-semibold"><%= assignment.quantity %></span>
                <small class="text-muted"><%= assignment.unit %></small>
              </td>
              <td>
                <span class="badge bg-info">
                  <%= assignment.user.name %>
                </span>
              </td>
              <td>
                <span class="<%= assignment.status_badge_class %>">
                  <%= assignment.status.humanize %>
                </span>
              </td>
              <td>
                ‚Çπ<%= number_with_precision(assignment.total_amount, precision: 2) %>
              </td>
              <td>
                <% if assignment.has_discount? %>
                  <span class="text-danger">
                    -‚Çπ<%= number_with_precision(assignment.discount_amount, precision: 2) %>
                  </span>
                  <small class="text-muted d-block">
                    (<%= assignment.discount_percentage %>%)
                  </small>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td class="fw-semibold">
                ‚Çπ<%= number_with_precision(assignment.final_amount, precision: 2) %>
              </td>
              <td>
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-outline-primary btn-sm edit-assignment-btn"
                          data-assignment-id="<%= assignment.id %>"
                          data-bs-toggle="tooltip" title="Edit Assignment">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button type="button" class="btn btn-outline-danger btn-sm delete-assignment-btn"
                          data-assignment-id="<%= assignment.id %>"
                          data-customer-name="<%= @customer.name %>"
                          data-scheduled-date="<%= assignment.scheduled_date.strftime('%d %b %Y') %>"
                          data-bs-toggle="tooltip" title="Delete Assignment">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
        <tfoot class="table-light">
          <tr>
            <th colspan="5">Total</th>
            <th>‚Çπ<%= number_with_precision(@delivery_assignments.sum(&:total_amount), precision: 2) %></th>
            <th>
              <% total_discount = @delivery_assignments.sum { |a| a.discount_amount.to_f } %>
              <% if total_discount > 0 %>
                <span class="text-danger">-‚Çπ<%= number_with_precision(total_discount, precision: 2) %></span>
              <% else %>
                <span class="text-muted">-</span>
              <% end %>
            </th>
            <th class="fw-bold">
              ‚Çπ<%= number_with_precision(@delivery_assignments.sum(&:final_amount), precision: 2) %>
            </th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>
  <% else %>
    <div class="text-center py-4">
      <i class="fas fa-calendar-times fs-1 text-muted mb-3"></i>
      <h5 class="text-muted">No delivery assignments found</h5>
      <p class="text-muted">No delivery assignments were found for <%= @customer.name %> in <%= @month_name %>.</p>
    </div>
  <% end %>
</div>

<div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
  <% if @delivery_assignments.any? %>
    <%= link_to delivery_assignments_path(customer_id: @customer.id),
        class: "btn btn-primary", target: "_blank" do %>
      <i class="fas fa-external-link-alt me-2"></i>View Full Details
    <% end %>
  <% end %>
</div>
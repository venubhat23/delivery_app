<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Atma Nirbhar Farm - Desi Cow Milk Provider</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "sidebar_fallback", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "layout_fix", "data-turbo-track": "reload" %>

    <!-- Force cache refresh -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Enhanced Bootstrap & Fonts -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Select2 for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <!-- CRITICAL LAYOUT FIX - Override all sidebar issues -->
    <style>
      /* Force sidebar width to 260px with highest priority */
      .sidebar,
      #sidebar,
      nav.sidebar {
        width: 260px !important;
        min-width: 260px !important;
        max-width: 260px !important;
        position: fixed !important;
        top: 70px !important;
        left: 0 !important;
        height: calc(100vh - 70px) !important;
        z-index: 1040 !important;
      }

      /* Force main content margin */
      .main-content,
      main.main-content,
      div.main-content,
      .content-wrapper,
      #main-content {
        position: fixed !important;
        top: 70px !important;
        left: 260px !important;
        right: 0 !important;
        bottom: 0 !important;
        width: auto !important;
        height: auto !important;
        max-width: none !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
        padding: 0 !important;
        margin: 0 !important;
      }

      /* Ensure proper container behavior */
      .main-content .container-fluid {
        width: 100% !important;
        max-width: none !important;
        overflow-x: hidden !important;
        padding: 2rem !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        height: 100% !important;
      }

      /* Mobile responsive */
      @media (max-width: 768px) {
        .main-content,
        main.main-content,
        div.main-content,
        .content-wrapper,
        #main-content {
          left: 0 !important;
          right: 0 !important;
        }

        .main-content .container-fluid {
          width: 100% !important;
          max-width: none !important;
          padding: 1rem !important;
        }
      }

      /* Ensure tables and content fit properly */
      .main-content .table-responsive {
        width: 100% !important;
        overflow-x: auto !important;
        margin: 0 !important;
      }

      .main-content table {
        width: 100% !important;
        max-width: 100% !important;
        table-layout: fixed !important;
      }

      .main-content .row {
        margin-left: 0 !important;
        margin-right: 0 !important;
      }

      .main-content .col,
      .main-content [class*="col-"] {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
        box-sizing: border-box !important;
      }

      /* Ensure stats cards and content fit within boundaries */
      .main-content .stats-card,
      .main-content .card,
      .main-content .page-header {
        max-width: 100% !important;
        box-sizing: border-box !important;
      }

      /* Force strict width on all content rows */
      .main-content .row {
        width: 100% !important;
        max-width: 100% !important;
      }
    </style>

    <!-- Premium Professional Styles -->
    <style>
      /* Global Enhancements */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        font-size: 16px;
        scroll-behavior: smooth;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-secondary);
        color: var(--text-primary);
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
      }

      /* Professional Layout Structure */
      .app-layout {
        display: flex;
        min-height: 100vh;
        position: relative;
        width: 100%;
        overflow-x: hidden;
      }

      /* Modern E-commerce Sidebar Design */
      .sidebar {
        width: 240px !important;
        min-width: 240px !important;
        max-width: 240px !important;
        background: linear-gradient(180deg, #ffffff 0%, #f7fafc 100%);
        border-right: 1px solid #e2e8f0;
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: var(--z-fixed);
        transition: var(--transition-normal);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        overflow-y: auto;
        overflow-x: hidden;
      }

      .sidebar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--primary-gradient);
      }

      /* Sidebar Header */
      .sidebar-header {
        padding: 2rem 1.5rem;
        border-bottom: 1px solid var(--border-light);
        background: rgba(99, 102, 241, 0.03);
      }

      .sidebar-brand {
        display: flex;
        align-items: center;
        gap: 1rem;
        text-decoration: none;
        color: var(--text-primary);
        font-weight: 700;
        font-size: 1.25rem;
        transition: var(--transition-fast);
      }

      .sidebar-brand:hover {
        color: var(--primary-500);
        transform: translateX(2px);
      }

      .sidebar-brand-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-lg);
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        box-shadow: var(--shadow-colored);
      }

      /* Sidebar Navigation */
      .sidebar-nav {
        padding: 1.5rem 1rem;
      }

      .nav-section {
        margin-bottom: 2rem;
      }

      .nav-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-quaternary);
        margin-bottom: 1rem;
        padding: 0 0.75rem;
      }

      .nav-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 0.75rem;
        border-radius: 12px;
        color: #4a5568;
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 0.5rem;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        border: 1px solid transparent;
      }

      .nav-link::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 3px;
        height: 100%;
        background: var(--primary-gradient);
        transform: translateX(-3px);
        transition: var(--transition-fast);
      }

      .nav-link:hover,
      .nav-link.active {
        color: #667eea;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        transform: translateX(8px);
        border-color: rgba(102, 126, 234, 0.2);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      }

      .nav-link:hover::before,
      .nav-link.active::before {
        transform: translateX(0);
      }

      .nav-link-icon {
        width: 1.25rem;
        height: 1.25rem;
        opacity: 0.7;
      }

      .nav-link:hover .nav-link-icon,
      .nav-link.active .nav-link-icon {
        opacity: 1;
      }

      /* Main Content Area */
      .main-wrapper {
        flex: 1;
        margin-left: 240px !important;
        background: var(--bg-secondary);
        min-height: 100vh;
        position: relative;
        width: calc(100% - 240px) !important;
        max-width: calc(100% - 240px) !important;
        padding: 0 !important;
        margin-right: 0 !important;
      }

      /* Modern E-commerce Header */
      .main-header {
        height: 75px;
        background: rgba(255, 255, 255, 0.95);
        border-bottom: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 2rem;
        position: fixed;
        top: 0;
        left: 240px;
        right: 0;
        width: calc(100% - 240px);
        z-index: var(--z-sticky);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .header-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .header-subtitle {
        font-size: 0.875rem;
        color: var(--text-tertiary);
        margin: 0;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .header-user {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 25px;
        background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        border: 1px solid #e2e8f0;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .header-user:hover {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        border-color: rgba(102, 126, 234, 0.3);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      }

      .header-avatar {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-full);
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
      }

      /* Main Content */
      .main-content {
        padding: 1.5rem !important;
        padding-top: 100px !important;
        max-width: 100%;
        width: 100%;
        animation: fadeInUp 0.5s ease-out;
        box-sizing: border-box;
        margin: 0 !important;
        padding-left: 1.5rem !important;
        padding-right: 1.5rem !important;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Enhanced Select2 Styling */
      .select2-container--bootstrap-5 .select2-selection {
        border-radius: var(--radius-md) !important;
        border: 2px solid var(--border-medium) !important;
        transition: var(--transition-fast) !important;
        min-height: 48px !important;
        background: var(--bg-primary) !important;
      }

      .select2-container--bootstrap-5 .select2-selection:hover {
        border-color: var(--primary-300) !important;
        box-shadow: var(--shadow-sm) !important;
      }

      .select2-container--bootstrap-5.select2-container--focus .select2-selection {
        border-color: var(--primary-500) !important;
        box-shadow: var(--shadow-colored) !important;
      }

      .select2-dropdown {
        border-radius: var(--radius-md) !important;
        border: 2px solid var(--border-medium) !important;
        box-shadow: var(--shadow-xl) !important;
        overflow: hidden !important;
        background: var(--bg-primary) !important;
        backdrop-filter: blur(10px) !important;
      }

      .select2-search--dropdown .select2-search__field {
        border-radius: var(--radius-sm) !important;
        border: 1px solid var(--border-medium) !important;
        padding: 12px 16px !important;
        font-size: 14px !important;
        margin: 12px !important;
        width: calc(100% - 24px) !important;
        background: var(--bg-secondary) !important;
      }

      .select2-search--dropdown .select2-search__field:focus {
        border-color: var(--primary-500) !important;
        box-shadow: var(--shadow-colored) !important;
        outline: none !important;
      }

      .select2-results__option {
        padding: 12px 16px !important;
        font-size: 14px !important;
        line-height: 1.4 !important;
        transition: var(--transition-fast) !important;
        color: var(--text-primary) !important;
      }

      .select2-results__option:hover,
      .select2-results__option--highlighted {
        background: var(--primary-50) !important;
        color: var(--primary-700) !important;
      }

      .select2-results__option[aria-selected="true"] {
        background: var(--primary-gradient) !important;
        color: white !important;
      }

      .select2-results__option mark {
        background: var(--warning-100) !important;
        color: var(--warning-800) !important;
        padding: 2px 6px !important;
        border-radius: var(--radius-xs) !important;
        font-weight: 600 !important;
      }

      .select2-results__option[aria-selected="true"] mark {
        background: rgba(255, 255, 255, 0.3) !important;
        color: white !important;
      }

      .select2-results__option--no-results {
        color: var(--text-tertiary) !important;
        font-style: italic !important;
        text-align: center !important;
        padding: 16px !important;
      }

      /* Layout Container Fixes */
      .container-fluid,
      .container {
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 0;
      }

      /* Ensure full width utilization */
      .row {
        margin: 0;
        width: 100%;
      }

      .col,
      [class*="col-"] {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }

      /* Table container adjustments */
      .table-responsive {
        width: 100%;
        max-width: 100%;
        overflow-x: auto;
      }

      /* Page specific adjustments */
      .page-header,
      .card {
        width: 100%;
        max-width: 100%;
      }

      /* Additional layout fixes for content area */
      .main-wrapper {
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
      }

      .main-header {
        flex-shrink: 0;
        width: 100%;
      }

      .main-content {
        flex: 1;
        overflow-x: hidden;
      }

      /* Ensure tables and content don't overflow */
      .table-container,
      .procurement-schedules-content {
        width: 100%;
        overflow-x: auto;
      }

      /* Fix for specific milk analytics page */
      .milk-analytics-content,
      .schedules-content {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }
      
      /* Loading message */
      .select2-results__option--loading-results {
        color: #6c757d !important;
        text-align: center !important;
        padding: 16px !important;
      }
      
      /* Selection styling */
      .select2-container--bootstrap-5 .select2-selection__rendered {
        color: #212529 !important;
        padding-left: 12px !important;
        padding-right: 12px !important;
        line-height: 1.5 !important;
      }
      
      .select2-container--bootstrap-5 .select2-selection__placeholder {
        color: #6c757d !important;
        font-style: italic !important;
      }
      
      /* Arrow styling */
      .select2-container--bootstrap-5 .select2-selection__arrow {
        height: 100% !important;
        right: 12px !important;
      }
      
      .select2-container--bootstrap-5 .select2-selection__arrow b {
        border-color: #6c757d transparent transparent transparent !important;
        border-width: 5px 4px 0 4px !important;
      }
      
      .select2-container--bootstrap-5.select2-container--open .select2-selection__arrow b {
        border-color: transparent transparent #6c757d transparent !important;
        border-width: 0 4px 5px 4px !important;
      }
      
      /* Clear button styling */
      .select2-container--bootstrap-5 .select2-selection__clear {
        color: #dc3545 !important;
        font-size: 16px !important;
        font-weight: bold !important;
        margin-right: 8px !important;
        transition: color 0.15s ease-in-out !important;
      }
      
      .select2-container--bootstrap-5 .select2-selection__clear:hover {
        color: #b02a37 !important;
      }
      
      /* Responsive adjustments */
      @media (max-width: 768px) {
        .select2-dropdown {
          font-size: 16px !important; /* Prevents zoom on iOS */
        }
        
        .select2-search--dropdown .select2-search__field {
          font-size: 16px !important; /* Prevents zoom on iOS */
        }
      }
      
      /* Animation for dropdown opening */
      .select2-dropdown {
        animation: select2FadeIn 0.2s ease-in-out !important;
      }
      
      @keyframes select2FadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* Custom scrollbar for dropdown */
      .select2-results__options {
        scrollbar-width: thin;
        scrollbar-color: #dee2e6 transparent;
      }
      
      .select2-results__options::-webkit-scrollbar {
        width: 6px;
      }
      
      .select2-results__options::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .select2-results__options::-webkit-scrollbar-thumb {
        background-color: #dee2e6;
        border-radius: 3px;
      }
      
      .select2-results__options::-webkit-scrollbar-thumb:hover {
        background-color: #adb5bd;
      }
    </style>
    
    <!-- Flatpickr for enhanced date pickers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <!-- Global Date Input Default Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Set today's date as default for empty date inputs
        function setDefaultDates() {
          const today = new Date().toISOString().split('T')[0]; // Get YYYY-MM-DD format
          
          // Find all date inputs that don't have a value
          const emptyDateInputs = document.querySelectorAll('input[type="date"]:not([value]), input[type="date"][value=""]');
          
          emptyDateInputs.forEach(function(input) {
            // Skip inputs that explicitly shouldn't have defaults
            if (!input.hasAttribute('data-no-default')) {
              input.value = today;
            }
          });
        }
        
        // Set defaults on page load
        setDefaultDates();
        
        // Also set defaults when new content is dynamically added
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length > 0) {
              setDefaultDates();
            }
          });
        });
        
        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
      });
    </script>
    <%= javascript_include_tag "sidebar", "data-turbo-track": "reload" %>
    
    <script>
    // Inline date helpers for DD.MM.YYYY format
    window.DateHelpers = {
      formatDate: function(date) {
        if (!date) return '';
        if (typeof date === 'string') date = new Date(date);
        if (!(date instanceof Date) || isNaN(date.getTime())) return '';
        
        var day = date.getDate().toString().padStart(2, '0');
        var month = (date.getMonth() + 1).toString().padStart(2, '0');
        var year = date.getFullYear();
        return day + '.' + month + '.' + year;
      },
      
      parseDate: function(dateString) {
        if (!dateString) return null;
        var parts = dateString.split('.');
        if (parts.length !== 3) return null;
        var day = parseInt(parts[0], 10);
        var month = parseInt(parts[1], 10) - 1;
        var year = parseInt(parts[2], 10);
        return new Date(year, month, day);
      },
      
      toInputFormat: function(dateString) {
        if (!dateString) return '';
        var parts = dateString.split('.');
        if (parts.length !== 3) return '';
        var day = parts[0].padStart(2, '0');
        var month = parts[1].padStart(2, '0');
        var year = parts[2];
        return year + '-' + month + '-' + day;
      },
      
      fromInputFormat: function(inputDate) {
        if (!inputDate) return '';
        var date = new Date(inputDate);
        return this.formatDate(date);
      },
      
      formatDateTime: function(date) {
        if (!date) return '';
        if (typeof date === 'string') date = new Date(date);
        if (!(date instanceof Date) || isNaN(date.getTime())) return '';
        
        var dateStr = this.formatDate(date);
        var hours = date.getHours().toString().padStart(2, '0');
        var minutes = date.getMinutes().toString().padStart(2, '0');
        return dateStr + ' ' + hours + ':' + minutes;
      }
    };
    
    // Legacy support for existing code
    window.formatDate = window.DateHelpers.formatDate;
    window.parseDate = window.DateHelpers.parseDate;
    
    // Configure Flatpickr date picker for DD.MM.YYYY format
    window.flatpickrConfig = {
      dateFormat: "d.m.Y",
      altInput: true,
      altFormat: "d.m.Y",
      allowInput: true,
      locale: {
        firstDayOfWeek: 1 // Monday
      }
    };
    
    // Auto-initialize date pickers when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize all date inputs with DD.MM.YYYY format
      var dateInputs = document.querySelectorAll('input[type="date"]');
      dateInputs.forEach(function(input) {
        if (!input.classList.contains('flatpickr-initialized')) {
          flatpickr(input, window.flatpickrConfig);
          input.classList.add('flatpickr-initialized');
        }
      });
      
      // Initialize inputs with date class
      var dateClasses = document.querySelectorAll('.date-picker, .date-input');
      dateClasses.forEach(function(input) {
        if (!input.classList.contains('flatpickr-initialized')) {
          flatpickr(input, window.flatpickrConfig);
          input.classList.add('flatpickr-initialized');
        }
      });
    });
    </script>
    
    <!-- Enhanced Production-Ready Sidebar Styles -->
    <style>
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        
        --sidebar-width: 260px;
        --sidebar-collapsed-width: 70px;
        --header-height: 70px;
        --border-radius: 12px;
        --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --box-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
        --text-primary: #2d3748;
        --text-secondary: #718096;
        --bg-light: #f7fafc;
        --bg-white: #ffffff;
        --border-color: #e2e8f0;
        --sidebar-bg: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        --accent-color: #667eea;
        --hover-bg: rgba(102, 126, 234, 0.08);
        --active-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-light);
        color: var(--text-primary);
        line-height: 1.6;
        font-size: 14px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      .main-wrapper {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
      }
      
      /* Enhanced Header */
      .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: var(--header-height);
        background: var(--bg-white);
        border-bottom: 1px solid var(--border-color);
        z-index: 1050;
        box-shadow: var(--box-shadow);
        backdrop-filter: blur(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      /* Production-Ready Sidebar */
      .sidebar {
        position: fixed;
        top: var(--header-height);
        left: 0;
        width: var(--sidebar-width);
        height: calc(100vh - var(--header-height));
        background: var(--sidebar-bg);
        border-right: 1px solid var(--border-color);
        z-index: 1040;
        overflow-y: auto;
        overflow-x: hidden;
        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: var(--box-shadow);
        will-change: transform;
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
      }
      
      /* Milk Analytics Sidebar Icon Adjustment - Move icon to the left */
      .nav-link .fa-glass-milk {
        margin-left: -8px !important;
      }
      
      .sidebar::-webkit-scrollbar {
        width: 6px;
      }
      
      .sidebar::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .sidebar::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.2);
        border-radius: 3px;
      }
      
      .sidebar::-webkit-scrollbar-thumb:hover {
        background: rgba(102, 126, 234, 0.4);
      }
      
      /* Sidebar Content */
      .sidebar-content {
        padding: 1.5rem 1rem;
        height: 100%;
      }

      /* Sidebar Button Styling */
      .sidebar .nav-item button.nav-link {
        color: var(--nav-link-color);
        text-decoration: none;
        display: flex;
        align-items: center;
        padding: 0.875rem 1rem;
        margin: 0;
        border-radius: 10px;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        border: none !important;
        background: none !important;
        width: 100%;
      }
      

      .sidebar .nav-item button.nav-link::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 3px;
        height: 0;
        background: var(--accent-color);
        border-radius: 0 2px 2px 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .sidebar .nav-item button.nav-link:hover {
        background: var(--hover-bg);
        color: var(--accent-color);
        transform: translateX(4px);
        border-color: rgba(102, 126, 234, 0.1);
      }

      .sidebar .nav-item button.nav-link:hover::before {
        height: 20px;
      }
      
      .sidebar-brand {
        padding: 1rem;
        margin-bottom: 1rem;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
      }
      
      .sidebar-brand h4 {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
        font-size: 1.1rem;
        margin: 0;
      }
      
      /* Enhanced Navigation */
      .sidebar .nav {
        gap: 0.25rem;
      }
      
      .sidebar .nav-item {
        margin-bottom: 0.25rem;
      }
      
      .sidebar .nav-link {
        position: relative;
        display: flex;
        align-items: center;
        padding: 0.875rem 1rem;
        margin: 0;
        border-radius: 10px;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.9rem;
        text-decoration: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        border: 2px solid transparent;
        background: transparent;
      }
      
      .sidebar .nav-link::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 3px;
        height: 0;
        background: var(--accent-color);
        border-radius: 0 2px 2px 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .sidebar .nav-link:hover {
        background: var(--hover-bg);
        color: var(--accent-color);
        transform: translateX(4px);
        border-color: rgba(102, 126, 234, 0.1);
      }
      
      .sidebar .nav-link:hover::before {
        height: 20px;
      }
      
      .sidebar .nav-link.active {
        background: var(--active-bg);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        border-color: transparent;
        transform: translateX(0);
      }
      
      .sidebar .nav-link.active::before {
        display: none;
      }
      
      .sidebar .nav-link.active .nav-icon {
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }
      
      .nav-icon {
        width: 20px;
        height: 20px;
        margin-right: 0.75rem;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.3s ease;
      }
      
      .nav-text {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      /* Main Content */
      .main-content {
        margin-left: var(--sidebar-width);
        margin-top: var(--header-height);
        padding: 2rem;
        min-height: calc(100vh - var(--header-height));
        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        background: var(--bg-light);
      }
      
      /* Mobile Sidebar Overlay */
      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1030;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(2px);
      }
      
      .sidebar-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      
      /* Mobile Toggle Button */
      .mobile-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 1.25rem;
        color: var(--text-primary);
        padding: 0.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
      }
      
      .mobile-toggle:hover {
        background: var(--hover-bg);
        color: var(--accent-color);
      }
      
      /* Responsive Design */
      @media (max-width: 1024px) {
        .sidebar {
          width: var(--sidebar-width);
        }
        
        .main-content {
          margin-left: var(--sidebar-width);
        }
      }
      
      @media (max-width: 768px) {
        .mobile-toggle {
          display: block;
        }
        
        .sidebar {
          transform: translateX(-100%);
          box-shadow: none;
        }
        
        .sidebar.show {
          transform: translateX(0);
          box-shadow: var(--box-shadow-hover);
        }
        
        .main-content {
          margin-left: 0;
          padding: 1.5rem;
        }
      }
      
      @media (max-width: 480px) {
        .sidebar {
          width: 100%;
        }
        
        .main-content {
          padding: 1rem;
        }
      }
      
      /* Enhanced Modal Styles */
      .modal-content {
        border-radius: var(--border-radius);
        border: none;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
      }
      
      .modal-header {
        padding: 1.5rem 1.5rem 0;
        border-bottom: none;
      }
      
      .modal-body {
        padding: 1rem 1.5rem;
      }
      
      .modal-footer {
        padding: 0 1.5rem 1.5rem;
        border-top: none;
      }
      
      .btn-danger {
        background: var(--danger-gradient);
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      
      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(248, 113, 113, 0.3);
      }
      
      .btn-secondary {
        background: #6c757d;
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      
      .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
      }
      
      /* Brand Styling */
      .brand-icon {
        width: 40px;
        height: 40px;
        background: var(--primary-gradient);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        transition: all 0.3s ease;
      }
      
      .brand-icon:hover {
        transform: scale(1.05);
      }
      
      .brand-text {
        font-size: 1.5rem;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 16px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        transition: all 0.3s ease;
      }
      
      .user-avatar:hover {
        transform: scale(1.05);
      }
      
      .user-name {
        font-weight: 600;
        color: var(--text-primary);
      }
      
      /* Loading States */
      .loading {
        opacity: 0.6;
        pointer-events: none;
        position: relative;
      }
      
      .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        border: 2px solid var(--accent-color);
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        transform: translate(-50%, -50%);
      }
      
      @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
      }
      
      /* Accessibility */
      @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }
      
      /* High contrast mode */
      @media (prefers-contrast: high) {
        :root {
          --border-color: #000000;
          --text-secondary: #000000;
        }
      }
      
      /* Print styles */
      @media print {
        .sidebar, .header, .sidebar-overlay {
          display: none !important;
        }
        
        .main-content {
          margin: 0 !important;
          padding: 0 !important;
        }
      }
    </style>
  </head>

  <body data-controller="<%= controller_name %>" data-action="<%= action_name %>">
    <% if logged_in? %>
      <div class="main-wrapper">
        <!-- Modern Header -->
        <header class="header">
          <div class="container-fluid h-100">
            <div class="row h-100 align-items-center">
              <div class="col-6">
                <div class="d-flex align-items-center">
                  <button class="mobile-toggle me-3" id="sidebarToggle" aria-label="Toggle Sidebar">
                    <i class="fas fa-bars"></i>
                  </button>
                  <% unless current_page?(root_path) %>
                    <%= link_to root_path, class: "btn btn-outline-secondary me-3" do %>
                      <i class="fas fa-arrow-left me-1"></i>Back
                    <% end %>
                  <% end %>
                  <%= link_to root_path, class: "navbar-brand d-flex align-items-center text-decoration-none" do %>
                    <div class="brand-icon me-2">
                      <i class="fas fa-cow"></i>
                    </div>
                    <span class="brand-text">Atma Nirbhar Farm</span>
                  <% end %>
                </div>
              </div>
              <div class="col-6 text-end">
                <div class="d-flex align-items-center justify-content-end">
                  <div class="user-menu dropdown">
                    <a href="#" class="dropdown-toggle text-decoration-none" id="userDropdown" data-bs-toggle="dropdown">
                      <div class="user-avatar">
                        <%= current_user.name.first.upcase %>
                      </div>
                      <span class="user-name ms-2 d-none d-md-inline">
                        <%= current_user.name %>
                      </span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li><h6 class="dropdown-header">Welcome, <%= current_user.name %></h6></li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#logoutModal">
                          <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </header>
        
        <!-- Production-Ready Enhanced Sidebar -->
        <nav class="sidebar" id="sidebar" role="navigation" aria-label="Main Navigation">
          <div class="sidebar-content">
            <!-- Sidebar Brand -->
            <!-- Navigation Menu -->
            <ul class="nav flex-column" role="menubar">
              <li class="nav-item" role="none">
                <%= link_to root_path,
                    class: "nav-link #{'active' if current_page?(root_path)}",
                    role: "menuitem",
                    "aria-current": current_page?(root_path) ? "page" : nil do %>
                  <i class="fas fa-chart-line nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Dashboard</span>
                <% end %>
              </li>

              <li class="nav-item" role="none">
                <%= link_to orders_path,
                    class: "nav-link #{'active' if current_page?(orders_path) || controller_name == 'orders'}",
                    role: "menuitem",
                    "aria-current": (current_page?(orders_path) || controller_name == 'orders') ? "page" : nil do %>
                  <i class="fas fa-shopping-cart nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Orders</span>
                <% end %>
              </li>

              <li class="nav-item" role="none">
                <%= link_to products_path,
                    class: "nav-link #{'active' if current_page?(products_path) || controller_name == 'products'}",
                    role: "menuitem",
                    "aria-current": (current_page?(products_path) || controller_name == 'products') ? "page" : nil do %>
                  <i class="fas fa-cube nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Products</span>
                <% end %>
              </li>
              
              <li class="nav-item" role="none">
                <%= link_to categories_path,
                    class: "nav-link #{'active' if current_page?(categories_path) || controller_name == 'categories'}",
                    role: "menuitem",
                    "aria-current": (current_page?(categories_path) || controller_name == 'categories') ? "page" : nil do %>
                  <i class="fas fa-tags nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Categories</span>
                <% end %>
              </li>

              <li class="nav-item" role="none">
                <%= link_to coupons_path,
                    class: "nav-link #{'active' if current_page?(coupons_path) || controller_name == 'coupons'}",
                    role: "menuitem",
                    "aria-current": (current_page?(coupons_path) || controller_name == 'coupons') ? "page" : nil do %>
                  <i class="fas fa-ticket-alt nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Coupons</span>
                <% end %>
              </li>
              
              <li class="nav-item" role="none">
                <%= link_to customers_path,
                    class: "nav-link #{'active' if current_page?(customers_path) || controller_name == 'customers'}",
                    role: "menuitem",
                    "aria-current": (current_page?(customers_path) || controller_name == 'customers') ? "page" : nil do %>
                  <i class="fas fa-users nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Customers</span>
                <% end %>
              </li>

              <li class="nav-item" role="none">
                <%= link_to customer_patterns_path,
                    class: "nav-link #{'active' if current_page?(customer_patterns_path) || controller_name == 'customer_patterns'}",
                    role: "menuitem",
                    "aria-current": (current_page?(customer_patterns_path) || controller_name == 'customer_patterns') ? "page" : nil do %>
                  <i class="fas fa-chart-bar nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">📊 Customer Patterns</span>
                <% end %>
              </li>

              <li class="nav-item" role="none">
                <%= link_to customer_points_path,
                    class: "nav-link #{'active' if current_page?(customer_points_path) || controller_name == 'customer_points'}",
                    role: "menuitem",
                    "aria-current": (current_page?(customer_points_path) || controller_name == 'customer_points') ? "page" : nil do %>
                  <i class="fas fa-star nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Customer Points</span>
                <% end %>
              </li>

              <li class="nav-item" role="none">
                <%= link_to customer_wallets_path,
                    class: "nav-link #{'active' if current_page?(customer_wallets_path) || controller_name == 'customer_wallets'}",
                    role: "menuitem",
                    "aria-current": (current_page?(customer_wallets_path) || controller_name == 'customer_wallets') ? "page" : nil do %>
                  <i class="fas fa-wallet nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Customer Wallets</span>
                <% end %>
              </li>

              <li class="nav-item" role="none">
                <%= link_to ai_insights_path,
                    class: "nav-link #{'active' if current_page?(ai_insights_path) || controller_name == 'ai_insights'}",
                    role: "menuitem",
                    "aria-current": (current_page?(ai_insights_path) || controller_name == 'ai_insights') ? "page" : nil do %>
                  <i class="fas fa-brain nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">🤖 AI-Insights</span>
                <% end %>
              </li>

              <li class="nav-item" role="none">
                <%= link_to customer_details_path,
                    class: "nav-link #{'active' if current_page?(customer_details_path) || controller_name == 'customer_details'}",
                    role: "menuitem",
                    "aria-current": (current_page?(customer_details_path) || controller_name == 'customer_details') ? "page" : nil do %>
                  <i class="fas fa-user-tag nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Customer Detail</span>
                <% end %>
              </li>

              <li class="nav-item" role="none">
                <%= link_to advertisements_path,
                    class: "nav-link #{'active' if current_page?(advertisements_path) || controller_name == 'advertisements'}",
                    role: "menuitem",
                    "aria-current": (current_page?(advertisements_path) || controller_name == 'advertisements') ? "page" : nil do %>
                  <i class="fas fa-bullhorn nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Ads</span>
                <% end %>
              </li>
              
              <li class="nav-item" role="none">
                <%= link_to delivery_people_path, 
                    class: "nav-link #{'active' if current_page?(delivery_people_path) || current_page?(new_delivery_person_path) || controller_name == 'delivery_people'}", 
                    role: "menuitem",
                    "aria-current": (current_page?(delivery_people_path) || current_page?(new_delivery_person_path) || controller_name == 'delivery_people') ? "page" : nil do %>
                  <i class="fas fa-user-tie nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Delivery Team</span>
                <% end %>
              </li>
              
              <li class="nav-item" role="none">
                <%= link_to delivery_assignments_path, 
                    class: "nav-link #{'active' if current_page?(delivery_assignments_path) || current_page?(new_delivery_assignment_path) || controller_name == 'delivery_assignments'}", 
                    role: "menuitem",
                    "aria-current": (current_page?(delivery_assignments_path) || current_page?(new_delivery_assignment_path) || controller_name == 'delivery_assignments') ? "page" : nil do %>
                  <i class="fas fa-route nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Assignments</span>
                <% end %>
              </li>
              
              <!-- Milk Analytics Module -->
              <li class="nav-item" role="none">
                <%= link_to milk_analytics_path, 
                    class: "nav-link #{'active' if controller_name.in?(%w[milk_analytics procurement_schedules procurement_assignments])}", 
                    role: "menuitem",
                    "aria-current": controller_name.in?(%w[milk_analytics procurement_schedules procurement_assignments]) ? "page" : nil do %>
                  <i class="fas fa-glass-milk nav-icon" aria-hidden="true" style="margin-left: -8px;"></i>
                  <span class="nav-text">📊 Milk Analytics</span>
                <% end %>
              </li>
              
              <li class="nav-item" role="none">
                <%= link_to schedules_path, 
                    class: "nav-link #{'active' if current_page?(schedules_path) || controller_name == 'schedules'}", 
                    role: "menuitem",
                    "aria-current": (current_page?(schedules_path) || controller_name == 'schedules') ? "page" : nil do %>
                  <i class="fas fa-calendar-alt nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Reschedule</span>
                <% end %>
              </li>
              
              <li class="nav-item" role="none">
                <button type="button" 
                    class="nav-link btn btn-link text-start w-100 border-0 #{'active' if current_page?(schedules_path) || controller_name == 'schedules'}" 
                    role="menuitem"
                    data-bs-toggle="modal" 
                    data-bs-target="#importLastMonthModal">
                  <i class="fas fa-download nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Import Last Month Deliveries</span>
                </button>
              </li>
              
              <li class="nav-item" role="none">
                <button type="button" 
                    class="nav-link btn btn-link text-start w-100 border-0" 
                    role="menuitem"
                    data-bs-toggle="modal" 
                    data-bs-target="#unassignModal">
                  <i class="fas fa-user-times nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Unassign</span>
                </button>
              </li>
              
              <li class="nav-item" role="none">
                <%= link_to invoices_path, 
                    class: "nav-link #{'active' if current_page?(invoices_path) || controller_name == 'invoices'}", 
                    role: "menuitem",
                    "aria-current": (current_page?(invoices_path) || controller_name == 'invoices') ? "page" : nil do %>
                  <i class="fas fa-receipt nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Invoices</span>
                <% end %>
              </li>

              <li class="nav-item" role="none">
                <%= link_to pending_payments_path,
                    class: "nav-link #{'active' if current_page?(pending_payments_path) || controller_name == 'pending_payments'}",
                    role: "menuitem",
                    "aria-current": (current_page?(pending_payments_path) || controller_name == 'pending_payments') ? "page" : nil do %>
                  <i class="fas fa-hourglass-half nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">💰 Pending Payments</span>
                <% end %>
              </li>

              <li class="nav-item" role="none">
                <%= link_to '/delivery-review', 
                    class: "nav-link #{'active' if controller_name == 'delivery_review'}", 
                    role: "menuitem",
                    "aria-current": controller_name == 'delivery_review' ? "page" : nil do %>
                  <i class="fas fa-truck nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">🚚 Delivery Review</span>
                <% end %>
              </li>
              
              <li class="nav-item" role="none">
                <%= link_to purchase_invoices_path, 
                    class: "nav-link #{'active' if current_page?(purchase_invoices_path) || controller_name == 'purchase_invoices'}", 
                    role: "menuitem",
                    "aria-current": (current_page?(purchase_invoices_path) || controller_name == 'purchase_invoices') ? "page" : nil do %>
                  <i class="fas fa-shopping-cart nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Purchases</span>
                <% end %>
              </li>
              
              <li class="nav-item" role="none">
                <%= link_to sales_invoices_path, 
                    class: "nav-link #{'active' if current_page?(sales_invoices_path) || controller_name == 'sales_invoices'}", 
                    role: "menuitem",
                    "aria-current": (current_page?(sales_invoices_path) || controller_name == 'sales_invoices') ? "page" : nil do %>
                  <i class="fas fa-chart-bar nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Sales</span>
                <% end %>
              </li>
              
              <li class="nav-item" role="none">
                <%= link_to reports_path,
                    class: "nav-link #{'active' if controller_name == 'reports'}",
                    role: "menuitem",
                    "aria-current": controller_name == 'reports' ? "page" : nil do %>
                  <i class="fas fa-chart-bar nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Reports</span>
                <% end %>
              </li>

              <li class="nav-item" role="none">
                <%= link_to whatsapp_messages_path,
                    class: "nav-link #{'active' if controller_name == 'whatsapp_messages'}",
                    role: "menuitem",
                    "aria-current": controller_name == 'whatsapp_messages' ? "page" : nil do %>
                  <i class="fab fa-whatsapp nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">WhatsApp Message</span>
                <% end %>
              </li>

              <li class="nav-item" role="none">
                <%= link_to admin_settings_path, 
                    class: "nav-link #{'active' if controller_name == 'admin_settings'}", 
                    role: "menuitem",
                    "aria-current": controller_name == 'admin_settings' ? "page" : nil do %>
                  <i class="fas fa-cog nav-icon" aria-hidden="true"></i>
                  <span class="nav-text">Settings</span>
                <% end %>
              </li>
            </ul>
          </div>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
          <% flash.each do |type, message| %>
            <div class="alert alert-<%= type == 'notice' ? 'success' : type == 'alert' ? 'danger' : type %> alert-dismissible fade show modern-alert" role="alert">
              <i class="fas fa-<%= type == 'notice' ? 'check-circle' : 'exclamation-triangle' %> me-2"></i>
              <%= message %>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% end %>
          
          <%= yield %>
        </main>
      </div>
      
      <!-- Mobile Sidebar Overlay -->
      <div class="sidebar-overlay d-md-none" id="sidebarOverlay"></div>
      
      <!-- Import Last Month Deliveries Modal -->
      <div class="modal fade" id="importLastMonthModal" tabindex="-1" aria-labelledby="importLastMonthModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-success text-white">
              <h5 class="modal-title" id="importLastMonthModalLabel">
                <i class="fas fa-download me-2"></i>
                Import Last Month Deliveries
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
              <form id="importLastMonthForm">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="importLastMonthMonth" class="form-label fw-bold">
                      <i class="fas fa-calendar-day me-1"></i>
                      Select Month
                    </label>
                    <select class="form-select" id="importLastMonthMonth" name="importLastMonthMonth" required>
                      <option value="">Choose Month...</option>
                      <option value="1">January</option>
                      <option value="2">February</option>
                      <option value="3">March</option>
                      <option value="4">April</option>
                      <option value="5">May</option>
                      <option value="6">June</option>
                      <option value="7">July</option>
                      <option value="8">August</option>
                      <option value="9">September</option>
                      <option value="10">October</option>
                      <option value="11">November</option>
                      <option value="12">December</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="importLastMonthYear" class="form-label fw-bold">
                      <i class="fas fa-calendar-year me-1"></i>
                      Select Year
                    </label>
                    <select class="form-select" id="importLastMonthYear" name="importLastMonthYear" required>
                      <option value="">Choose Year...</option>
                      <% (2020..2030).each do |year| %>
                        <option value="<%= year %>" <%= 'selected' if year == Date.current.year %>>
                          <%= year %>
                        </option>
                      <% end %>
                    </select>
                  </div>
                </div>
                
                <div class="alert alert-info border-0 shadow-sm">
                  <h6 class="alert-heading mb-2">
                    <i class="fas fa-info-circle me-2"></i>
                    How it works
                  </h6>
                  <ul class="mb-0 small">
                    <li>All delivery assignments from the selected month will be copied to <strong><%= Date.current.strftime("%B %Y") %></strong></li>
                    <li>Same products and delivery persons will be assigned</li>
                    <li>All imported assignments will be in <strong>"Pending"</strong> state</li>
                    <li>If the target month has fewer days, extra dates will be skipped</li>
                    <li>If the target month has more days, the last day's assignment will be used</li>
                  </ul>
                </div>

                <!-- Loading State -->
                <div id="importLastMonthLoadingState" class="text-center py-3" style="display: none;">
                  <div class="spinner-border text-success mb-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="text-muted mb-0">Importing deliveries...</p>
                </div>

                <!-- Success/Error Messages -->
                <div id="importLastMonthSuccess" class="alert alert-success" style="display: none;">
                  <h6 class="alert-heading">
                    <i class="fas fa-check-circle me-2"></i>
                    Import Successful
                  </h6>
                  <p id="importLastMonthSuccessMessage" class="mb-0"></p>
                </div>

                <div id="importLastMonthError" class="alert alert-danger" style="display: none;">
                  <h6 class="alert-heading">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Import Failed
                  </h6>
                  <p id="importLastMonthErrorMessage" class="mb-0"></p>
                </div>
              </form>
            </div>
            <div class="modal-footer border-0">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-2"></i>
                Cancel
              </button>
              <button type="button" class="btn btn-success" id="importLastMonthBtn">
                <i class="fas fa-download me-2"></i>
                Import
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Unassign Modal -->
      <div class="modal fade" id="unassignModal" tabindex="-1" aria-labelledby="unassignModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-danger text-white">
              <h5 class="modal-title" id="unassignModalLabel">
                <i class="fas fa-user-times me-2"></i>
                Unassign Customer
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
              <form id="unassignForm">
                <div class="row mb-3">
                  <div class="col-12">
                    <label for="unassignCustomerSearch" class="form-label fw-bold">
                      <i class="fas fa-user me-1"></i>
                      Select Customer
                    </label>
                    <div class="unassign-customer-search-container position-relative">
                      <input type="text" 
                             class="form-control modern-input unassign-customer-search-input" 
                             id="unassignCustomerSearch"
                             placeholder="Search customers by name..."
                             autocomplete="off"
                             required>
                      <div class="search-icon">
                        <i class="fas fa-search"></i>
                      </div>
                      <input type="hidden" id="unassignCustomerId" name="customer_id">
                      <div class="unassign-customer-suggestions" id="unassignCustomerSuggestions" style="display: none;">
                        <!-- Customer suggestions will be populated here -->
                      </div>
                      <div class="unassign-customer-loading" id="unassignCustomerLoading" style="display: none;">
                        <i class="fas fa-spinner fa-spin me-2"></i>Searching customers...
                      </div>
                      <div class="unassign-selected-customer" id="unassignSelectedCustomer" style="display: none;">
                        <div class="selected-customer-info">
                          <div class="selected-customer-name"></div>
                          <div class="selected-customer-phone"></div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary unassign-clear-customer">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="unassignMonth" class="form-label fw-bold">
                      <i class="fas fa-calendar-day me-1"></i>
                      Select Month
                    </label>
                    <select class="form-select" id="unassignMonth" name="month" required>
                      <option value="">Choose Month...</option>
                      <option value="1">January</option>
                      <option value="2">February</option>
                      <option value="3">March</option>
                      <option value="4">April</option>
                      <option value="5">May</option>
                      <option value="6">June</option>
                      <option value="7">July</option>
                      <option value="8">August</option>
                      <option value="9">September</option>
                      <option value="10">October</option>
                      <option value="11">November</option>
                      <option value="12">December</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="unassignYear" class="form-label fw-bold">
                      <i class="fas fa-calendar-year me-1"></i>
                      Select Year
                    </label>
                    <select class="form-select" id="unassignYear" name="year" required>
                      <option value="">Choose Year...</option>
                      <% (2020..2030).each do |year| %>
                        <option value="<%= year %>" <%= 'selected' if year == Date.current.year %>>
                          <%= year %>
                        </option>
                      <% end %>
                    </select>
                  </div>
                </div>
                
                <div class="alert alert-warning border-0 shadow-sm">
                  <h6 class="alert-heading mb-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Warning
                  </h6>
                  <ul class="mb-0 small">
                    <li><strong>All delivery assignments</strong> for the selected customer and time period will be <strong>permanently deleted</strong></li>
                    <li><strong>All delivery schedules</strong> for the selected customer and time period will be <strong>permanently deleted</strong></li>
                    <li><strong>This action cannot be undone</strong></li>
                    <li>Make sure you have backed up any important data before proceeding</li>
                  </ul>
                </div>

                <!-- Loading State -->
                <div id="unassignLoadingState" class="text-center py-3" style="display: none;">
                  <div class="spinner-border text-danger mb-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="text-muted mb-0">Unassigning customer...</p>
                </div>

                <!-- Success/Error Messages -->
                <div id="unassignSuccess" class="alert alert-success" style="display: none;">
                  <h6 class="alert-heading">
                    <i class="fas fa-check-circle me-2"></i>
                    Unassign Successful
                  </h6>
                  <p id="unassignSuccessMessage" class="mb-0"></p>
                </div>

                <div id="unassignError" class="alert alert-danger" style="display: none;">
                  <h6 class="alert-heading">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Unassign Failed
                  </h6>
                  <p id="unassignErrorMessage" class="mb-0"></p>
                </div>
              </form>
            </div>
            <div class="modal-footer border-0">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-2"></i>
                Cancel
              </button>
              <button type="button" class="btn btn-danger" id="unassignBtn">
                <i class="fas fa-user-times me-2"></i>
                Unassign Customer
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Logout Confirmation Modal -->
      <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header border-0">
              <h5 class="modal-title" id="logoutModalLabel">
                <i class="fas fa-sign-out-alt me-2 text-warning"></i>
                Confirm Logout
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
              <div class="logout-icon mb-3">
                <i class="fas fa-user-times fa-3x text-muted"></i>
              </div>
              <h6 class="mb-3">Are you sure you want to logout?</h6>
              <p class="text-muted mb-0">You will be redirected to the login page.</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-2"></i>Cancel
              </button>
              <%= form_with url: logout_path, method: :delete, local: true, class: "d-inline" do |form| %>
                <%= form.submit "Logout", class: "btn btn-danger ms-2", data: { confirm: false } %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Enhanced Production-Ready JavaScript -->
      <script>
        (function() {
          'use strict';
          
          // DOM elements
          const sidebarToggle = document.getElementById('sidebarToggle');
          const sidebar = document.getElementById('sidebar');
          const sidebarOverlay = document.getElementById('sidebarOverlay');
          const body = document.body;
          
          // State management
          let sidebarOpen = false;
          
          // Toggle sidebar function
          function toggleSidebar() {
            sidebarOpen = !sidebarOpen;
            
            if (sidebarOpen) {
              sidebar?.classList.add('show');
              sidebarOverlay?.classList.add('show');
              body.style.overflow = 'hidden'; // Prevent body scroll on mobile
              sidebarToggle?.setAttribute('aria-expanded', 'true');
            } else {
              sidebar?.classList.remove('show');
              sidebarOverlay?.classList.remove('show');
              body.style.overflow = '';
              sidebarToggle?.setAttribute('aria-expanded', 'false');
            }
          }
          
          // Close sidebar function
          function closeSidebar() {
            if (sidebarOpen) {
              sidebarOpen = false;
              sidebar?.classList.remove('show');
              sidebarOverlay?.classList.remove('show');
              body.style.overflow = '';
              sidebarToggle?.setAttribute('aria-expanded', 'false');
            }
          }
          
          // Event listeners
          sidebarToggle?.addEventListener('click', function(e) {
            e.preventDefault();
            toggleSidebar();
          });
          
          sidebarOverlay?.addEventListener('click', function() {
            closeSidebar();
          });
          
          // Close sidebar on escape key
          document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && sidebarOpen) {
              closeSidebar();
            }
          });
          
          // Handle window resize
          let resizeTimer;
          window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
              // Close sidebar on desktop breakpoint
              if (window.innerWidth >= 768 && sidebarOpen) {
                closeSidebar();
              }
            }, 250);
          });
          
          // Prevent sidebar content from scrolling when overlay is active
          sidebar?.addEventListener('touchmove', function(e) {
            if (sidebarOpen && window.innerWidth < 768) {
              e.stopPropagation();
            }
          });
          
          // Initialize ARIA attributes
          if (sidebarToggle) {
            sidebarToggle.setAttribute('aria-expanded', 'false');
            sidebarToggle.setAttribute('aria-controls', 'sidebar');
          }
          
          // Add focus management for accessibility
          const navLinks = sidebar?.querySelectorAll('.nav-link');
          navLinks?.forEach(function(link) {
            link.addEventListener('focus', function() {
              // Ensure sidebar is visible when navigating with keyboard
              if (window.innerWidth < 768 && !sidebarOpen) {
                toggleSidebar();
              }
            });
          });
          
          // Smooth scrolling for anchor links
          document.querySelectorAll('a[href^="#"]').forEach(function(anchor) {
            anchor.addEventListener('click', function(e) {
              e.preventDefault();
              const target = document.querySelector(this.getAttribute('href'));
              if (target) {
                target.scrollIntoView({
                  behavior: 'smooth',
                  block: 'start'
                });
                // Close sidebar on mobile after navigation
                if (window.innerWidth < 768) {
                  closeSidebar();
                }
              }
            });
          });
          
          // Add loading states for navigation links
          navLinks?.forEach(function(link) {
            link.addEventListener('click', function() {
              // Add loading state
              this.classList.add('loading');
              
              // Remove loading state after navigation (fallback)
              setTimeout(() => {
                this.classList.remove('loading');
              }, 3000);
            });
          });
          
          // Handle page visibility changes
          document.addEventListener('visibilitychange', function() {
            if (document.hidden && sidebarOpen && window.innerWidth < 768) {
              closeSidebar();
            }
          });
          
          // Performance optimization: Passive event listeners where possible
          if (sidebar) {
            sidebar.addEventListener('scroll', function() {
              // Add scroll shadow effect
              if (this.scrollTop > 10) {
                this.style.boxShadow = 'inset 0 10px 10px -10px rgba(0,0,0,0.1)';
              } else {
                this.style.boxShadow = '';
              }
            }, { passive: true });
          }
          
          // Initialize
          console.log('Sidebar initialized successfully');
          
        })();

        // Import Last Month Deliveries functionality
        (function() {
          'use strict';
          
          document.addEventListener('DOMContentLoaded', function() {
            const importLastMonthBtn = document.getElementById('importLastMonthBtn');
            const importLastMonthModal = document.getElementById('importLastMonthModal');
            const importLastMonthLoadingState = document.getElementById('importLastMonthLoadingState');
            const importLastMonthSuccess = document.getElementById('importLastMonthSuccess');
            const importLastMonthError = document.getElementById('importLastMonthError');
            const importLastMonthSuccessMessage = document.getElementById('importLastMonthSuccessMessage');
            const importLastMonthErrorMessage = document.getElementById('importLastMonthErrorMessage');

            if (importLastMonthBtn) {
              importLastMonthBtn.addEventListener('click', function() {
                const month = document.getElementById('importLastMonthMonth').value;
                const year = document.getElementById('importLastMonthYear').value;

                // Validate input
                if (!month || !year) {
                  alert('Please select both month and year');
                  return;
                }

                // Hide previous messages
                importLastMonthSuccess.style.display = 'none';
                importLastMonthError.style.display = 'none';

                // Show loading state
                importLastMonthLoadingState.style.display = 'block';
                importLastMonthBtn.disabled = true;

                // Make API call
                fetch('<%= import_selected_month_schedules_path %>', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                  },
                  body: JSON.stringify({
                    month: month,
                    year: year
                  })
                })
                .then(response => response.json())
                .then(data => {
                  // Hide loading state
                  importLastMonthLoadingState.style.display = 'none';
                  importLastMonthBtn.disabled = false;

                  if (data.success) {
                    // Show success message
                    const summary = data.summary;
                    importLastMonthSuccessMessage.innerHTML = `
                      <strong>Import completed successfully!</strong><br>
                      • ${summary.assignments_created} delivery assignments created<br>
                      • ${summary.customers_affected} customers affected<br>
                      • Source: ${summary.source_month} → Target: ${summary.target_month}
                    `;
                    importLastMonthSuccess.style.display = 'block';

                    // Auto-close modal after 3 seconds
                    setTimeout(() => {
                      const modal = bootstrap.Modal.getInstance(importLastMonthModal);
                      if (modal) {
                        modal.hide();
                      }
                    }, 3000);

                  } else {
                    // Show error message
                    importLastMonthErrorMessage.textContent = data.error || 'An error occurred while importing deliveries';
                    importLastMonthError.style.display = 'block';
                  }
                })
                .catch(error => {
                  // Hide loading state
                  importLastMonthLoadingState.style.display = 'none';
                  importLastMonthBtn.disabled = false;

                  // Show error message
                  importLastMonthErrorMessage.textContent = 'Network error: ' + error.message;
                  importLastMonthError.style.display = 'block';
                });
              });
            }

            // Reset modal state when it's closed
            if (importLastMonthModal) {
              importLastMonthModal.addEventListener('hidden.bs.modal', function() {
                // Reset form
                document.getElementById('importLastMonthForm').reset();
                
                // Hide all messages
                importLastMonthLoadingState.style.display = 'none';
                importLastMonthSuccess.style.display = 'none';
                importLastMonthError.style.display = 'none';
                
                // Re-enable button
                importLastMonthBtn.disabled = false;
              });
            }
          });
          
          console.log('Import Last Month Deliveries functionality initialized');
        })();

        // Unassign Customer functionality
        (function() {
          'use strict';
          
          document.addEventListener('DOMContentLoaded', function() {
            const unassignBtn = document.getElementById('unassignBtn');
            const unassignModal = document.getElementById('unassignModal');
            const unassignLoadingState = document.getElementById('unassignLoadingState');
            const unassignSuccess = document.getElementById('unassignSuccess');
            const unassignError = document.getElementById('unassignError');
            const unassignSuccessMessage = document.getElementById('unassignSuccessMessage');
            const unassignErrorMessage = document.getElementById('unassignErrorMessage');
            
            // Advanced Search Elements
            const unassignCustomerSearchInput = document.getElementById('unassignCustomerSearch');
            const unassignCustomerSuggestions = document.getElementById('unassignCustomerSuggestions');
            const unassignCustomerLoading = document.getElementById('unassignCustomerLoading');
            const unassignSelectedCustomer = document.getElementById('unassignSelectedCustomer');
            const unassignCustomerId = document.getElementById('unassignCustomerId');
            
            let unassignSearchTimeout;
            let currentUnassignSearchTerm = '';
            let currentUnassignPage = 1;
            let isLoadingUnassignMore = false;
            let hasUnassignMoreData = true;

            // Customer Search Functionality
            if (unassignCustomerSearchInput) {
              // Trigger customer search as you type
              unassignCustomerSearchInput.addEventListener('input', function(e) {
                clearTimeout(unassignSearchTimeout);
                const query = this.value.trim();
                currentUnassignSearchTerm = query;
                
                // Reset pagination on new search
                currentUnassignPage = 1;
                hasUnassignMoreData = true;
                
                if (query.length === 0) {
                  // Show all customers when input is empty
                  unassignSearchTimeout = setTimeout(() => {
                    showUnassignCustomerLoading();
                    fetchUnassignCustomerSuggestions('', true);
                  }, 100);
                  return;
                }
                
                // Add debouncing - wait 300ms after user stops typing
                unassignSearchTimeout = setTimeout(() => {
                  showUnassignCustomerLoading();
                  fetchUnassignCustomerSuggestions(query, true);
                }, 300);
              });
              
              // Handle focus - show dropdown with all customers
              unassignCustomerSearchInput.addEventListener('focus', function() {
                if (!unassignCustomerId.value) {
                  const query = this.value.trim();
                  currentUnassignPage = 1;
                  hasUnassignMoreData = true;
                  showUnassignCustomerLoading();
                  fetchUnassignCustomerSuggestions(query, true);
                }
              });
              
              // Handle blur (with delay to allow clicking suggestions)
              unassignCustomerSearchInput.addEventListener('blur', function() {
                setTimeout(() => {
                  hideUnassignCustomerSuggestions();
                }, 200);
              });
            }
            
            // Clear customer button
            document.addEventListener('click', function(e) {
              if (e.target.closest('.unassign-clear-customer')) {
                clearUnassignSelectedCustomer();
              }
            });
            
            function fetchUnassignCustomerSuggestions(query, resetList = false) {
              if (resetList) {
                currentUnassignPage = 1;
                hasUnassignMoreData = true;
              }
              
              fetch(`/assign_deliveries/search_suggestions?q=${encodeURIComponent(query)}&page=${currentUnassignPage}`)
                .then(response => response.json())
                .then(data => {
                  hideUnassignCustomerLoading();
                  // Filter only customer suggestions
                  const customerSuggestionsList = data.suggestions.filter(s => s.type === 'customer');
                  hasUnassignMoreData = data.has_more;
                  
                  if (resetList || currentUnassignPage === 1) {
                    displayUnassignCustomerSuggestions(customerSuggestionsList);
                  } else {
                    appendUnassignCustomerSuggestions(customerSuggestionsList);
                  }
                  
                  isLoadingUnassignMore = false;
                })
                .catch(error => {
                  console.error('Customer search error:', error);
                  hideUnassignCustomerLoading();
                  isLoadingUnassignMore = false;
                });
            }
            
            function displayUnassignCustomerSuggestions(suggestions) {
              if (suggestions.length === 0) {
                unassignCustomerSuggestions.innerHTML = '<div class="unassign-customer-suggestion-item">No customers found</div>';
                unassignCustomerSuggestions.style.display = 'block';
                return;
              }
              
              const html = suggestions.map(suggestion => {
                const highlightedName = highlightUnassignSearchTerm(suggestion.label, currentUnassignSearchTerm);
                const phone = suggestion.phone || '';
                
                return `
                  <div class="unassign-customer-suggestion-item" data-customer-id="${suggestion.id}" data-customer-name="${suggestion.label}" data-customer-phone="${phone}">
                    <div class="unassign-customer-suggestion-name">${highlightedName}</div>
                    ${phone ? `<div class="unassign-customer-suggestion-phone"><i class="fas fa-phone me-1"></i>${phone}</div>` : ''}
                  </div>
                `;
              }).join('');
              
              unassignCustomerSuggestions.innerHTML = html;
              if (hasUnassignMoreData) {
                unassignCustomerSuggestions.innerHTML += '<div class="unassign-load-more-indicator" style="padding: 0.5rem; text-align: center; color: #666; font-size: 0.85rem;">Scroll for more...</div>';
              }
              unassignCustomerSuggestions.style.display = 'block';
              
              attachUnassignSuggestionEventListeners();
              attachUnassignScrollListener();
            }
            
            function appendUnassignCustomerSuggestions(suggestions) {
              if (suggestions.length === 0) return;
              
              // Remove the load more indicator if it exists
              const loadMoreIndicator = unassignCustomerSuggestions.querySelector('.unassign-load-more-indicator');
              if (loadMoreIndicator) {
                loadMoreIndicator.remove();
              }
              
              const html = suggestions.map(suggestion => {
                const highlightedName = highlightUnassignSearchTerm(suggestion.label, currentUnassignSearchTerm);
                const phone = suggestion.phone || '';
                
                return `
                  <div class="unassign-customer-suggestion-item" data-customer-id="${suggestion.id}" data-customer-name="${suggestion.label}" data-customer-phone="${phone}">
                    <div class="unassign-customer-suggestion-name">${highlightedName}</div>
                    ${phone ? `<div class="unassign-customer-suggestion-phone"><i class="fas fa-phone me-1"></i>${phone}</div>` : ''}
                  </div>
                `;
              }).join('');
              
              unassignCustomerSuggestions.insertAdjacentHTML('beforeend', html);
              
              if (hasUnassignMoreData) {
                unassignCustomerSuggestions.insertAdjacentHTML('beforeend', '<div class="unassign-load-more-indicator" style="padding: 0.5rem; text-align: center; color: #666; font-size: 0.85rem;">Scroll for more...</div>');
              }
              
              attachUnassignSuggestionEventListeners();
            }
            
            function attachUnassignSuggestionEventListeners() {
              // Add click handlers to new items only
              document.querySelectorAll('.unassign-customer-suggestion-item:not([data-listeners-attached])').forEach(item => {
                if (item.dataset.customerId) {
                  item.addEventListener('click', function() {
                    selectUnassignCustomer(
                      this.dataset.customerId,
                      this.dataset.customerName,
                      this.dataset.customerPhone
                    );
                  });
                  
                  item.addEventListener('mouseenter', function() {
                    document.querySelectorAll('.unassign-customer-suggestion-item.active').forEach(active => {
                      active.classList.remove('active');
                    });
                    this.classList.add('active');
                  });
                  
                  item.setAttribute('data-listeners-attached', 'true');
                }
              });
            }
            
            function attachUnassignScrollListener() {
              unassignCustomerSuggestions.removeEventListener('scroll', handleUnassignScroll);
              unassignCustomerSuggestions.addEventListener('scroll', handleUnassignScroll);
            }
            
            function handleUnassignScroll() {
              if (!hasUnassignMoreData || isLoadingUnassignMore) return;
              
              const scrollTop = unassignCustomerSuggestions.scrollTop;
              const scrollHeight = unassignCustomerSuggestions.scrollHeight;
              const clientHeight = unassignCustomerSuggestions.clientHeight;
              
              // Load more when user scrolls to within 50px of the bottom
              if (scrollTop + clientHeight >= scrollHeight - 50) {
                isLoadingUnassignMore = true;
                currentUnassignPage++;
                
                // Show loading indicator
                const loadMoreIndicator = unassignCustomerSuggestions.querySelector('.unassign-load-more-indicator');
                if (loadMoreIndicator) {
                  loadMoreIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading more...';
                }
                
                fetchUnassignCustomerSuggestions(currentUnassignSearchTerm, false);
              }
            }
            
            function selectUnassignCustomer(id, name, phone) {
              unassignCustomerId.value = id;
              showUnassignSelectedCustomer(id, name, phone);
              hideUnassignCustomerSuggestions();
            }
            
            function showUnassignSelectedCustomer(id, name, phone) {
              unassignCustomerSearchInput.style.display = 'none';
              unassignSelectedCustomer.style.display = 'flex';
              
              unassignSelectedCustomer.querySelector('.selected-customer-name').textContent = name;
              unassignSelectedCustomer.querySelector('.selected-customer-phone').textContent = phone ? phone : 'No phone number';
            }
            
            function clearUnassignSelectedCustomer() {
              unassignCustomerId.value = '';
              unassignCustomerSearchInput.value = '';
              unassignCustomerSearchInput.style.display = 'block';
              unassignSelectedCustomer.style.display = 'none';
              hideUnassignCustomerSuggestions();
            }
            
            function highlightUnassignSearchTerm(text, term) {
              if (!term) return text;
              
              const regex = new RegExp(`(${term})`, 'gi');
              return text.replace(regex, '<span class="search-highlight">$1</span>');
            }
            
            function showUnassignCustomerLoading() {
              unassignCustomerLoading.style.display = 'block';
              unassignCustomerSuggestions.style.display = 'none';
            }
            
            function hideUnassignCustomerLoading() {
              unassignCustomerLoading.style.display = 'none';
            }
            
            function hideUnassignCustomerSuggestions() {
              unassignCustomerSuggestions.style.display = 'none';
              unassignCustomerLoading.style.display = 'none';
            }

            if (unassignBtn) {
              unassignBtn.addEventListener('click', function() {
                const customerId = unassignCustomerId.value;
                const month = document.getElementById('unassignMonth').value;
                const year = document.getElementById('unassignYear').value;

                // Validate input
                if (!customerId || !month || !year) {
                  alert('Please select customer, month and year');
                  return;
                }

                // Get customer name for confirmation
                const customerName = unassignSelectedCustomer.querySelector('.selected-customer-name').textContent ||
                                   unassignCustomerSearchInput.value || 'Selected Customer';
                
                const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                                  'July', 'August', 'September', 'October', 'November', 'December'];
                const confirmMessage = `Are you sure you want to unassign ${customerName} for ${monthNames[month]} ${year}?\n\nThis will permanently delete ALL delivery assignments and schedules for this customer and time period.\n\nThis action cannot be undone!`;
                
                if (!confirm(confirmMessage)) {
                  return;
                }

                // Hide previous messages
                unassignSuccess.style.display = 'none';
                unassignError.style.display = 'none';

                // Show loading state
                unassignLoadingState.style.display = 'block';
                unassignBtn.disabled = true;

                // Make API call
                fetch('/assign_deliveries/unassign_customer', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                  },
                  body: JSON.stringify({
                    customer_id: customerId,
                    month: month,
                    year: year
                  })
                })
                .then(response => response.json())
                .then(data => {
                  // Hide loading state
                  unassignLoadingState.style.display = 'none';
                  unassignBtn.disabled = false;

                  if (data.success) {
                    // Show success message
                    unassignSuccessMessage.innerHTML = `
                      <strong>Unassign completed successfully!</strong><br>
                      • ${data.assignments_deleted} delivery assignments deleted<br>
                      • ${data.schedules_deleted} delivery schedules deleted<br>
                      • Customer: ${customerName}<br>
                      • Period: ${monthNames[month]} ${year}
                    `;
                    unassignSuccess.style.display = 'block';

                    // Auto-close modal after 3 seconds
                    setTimeout(() => {
                      const modal = bootstrap.Modal.getInstance(unassignModal);
                      if (modal) {
                        modal.hide();
                      }
                    }, 3000);

                  } else {
                    // Show error message
                    unassignErrorMessage.textContent = data.error || 'An error occurred while unassigning customer';
                    unassignError.style.display = 'block';
                  }
                })
                .catch(error => {
                  // Hide loading state
                  unassignLoadingState.style.display = 'none';
                  unassignBtn.disabled = false;

                  // Show error message
                  unassignErrorMessage.textContent = 'Network error: ' + error.message;
                  unassignError.style.display = 'block';
                });
              });
            }

            // Reset modal state when it's closed
            if (unassignModal) {
              unassignModal.addEventListener('hidden.bs.modal', function() {
                // Reset form
                document.getElementById('unassignForm').reset();
                
                // Hide all messages
                unassignLoadingState.style.display = 'none';
                unassignSuccess.style.display = 'none';
                unassignError.style.display = 'none';
                
                // Re-enable button
                unassignBtn.disabled = false;

                // Reset customer search
                clearUnassignSelectedCustomer();
              });
            }
          });
          
          console.log('Unassign Customer functionality initialized');
        })();
      </script>
    <% else %>
      <!-- Login/Auth Layout -->
      <div class="auth-wrapper">
        <% flash.each do |type, message| %>
          <div class="alert alert-<%= type == 'notice' ? 'success' : type == 'alert' ? 'danger' : type %> alert-dismissible fade show modern-alert" role="alert">
            <i class="fas fa-<%= type == 'notice' ? 'check-circle' : 'exclamation-triangle' %> me-2"></i>
            <%= message %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% end %>
        
        <%= yield %>
      </div>
    <% end %>

    <!-- Image Zoom Modal Component -->
    <div class="modal fade" id="imageZoomModal" tabindex="-1" aria-labelledby="imageZoomModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
          <div class="modal-header border-0 position-absolute top-0 end-0 z-3">
            <button type="button" class="btn btn-light btn-sm rounded-circle" data-bs-dismiss="modal" aria-label="Close" style="width: 40px; height: 40px;">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body p-0 d-flex align-items-center justify-content-center" style="min-height: 70vh;">
            <img id="zoomedImage" src="" alt="" class="img-fluid rounded shadow-lg" style="max-height: 80vh; max-width: 100%; object-fit: contain;">
          </div>
        </div>
      </div>
    </div>

    <!-- Image Zoom JavaScript -->
    <script>
      (function() {
        'use strict';
        
        // Function to open image zoom modal
        window.openImageZoom = function(imageSrc, imageAlt) {
          const modal = document.getElementById('imageZoomModal');
          const zoomedImage = document.getElementById('zoomedImage');
          
          if (modal && zoomedImage && imageSrc) {
            zoomedImage.src = imageSrc;
            zoomedImage.alt = imageAlt || 'Zoomed Image';
            
            // Show the modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Add loading state
            zoomedImage.style.opacity = '0.5';
            
            // Handle image load
            zoomedImage.onload = function() {
              this.style.opacity = '1';
            };
            
            // Handle image error
            zoomedImage.onerror = function() {
              this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OTk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBmb3VuZDwvdGV4dD4KICA8L3N2Zz4K';
              this.alt = 'Image not found';
              this.style.opacity = '1';
            };
          }
        };
        
        // Function to make images clickable for zoom
        window.makeImagesZoomable = function() {
          // Find all product and customer thumbnail images
          const thumbnailImages = document.querySelectorAll('.product-image-thumbnail, .customer-image-thumbnail');
          
          thumbnailImages.forEach(function(img) {
            // Add zoom cursor style
            img.style.cursor = 'zoom-in';
            img.title = 'Click to zoom';
            
            // Remove existing click listeners to prevent duplicates
            const newImg = img.cloneNode(true);
            img.parentNode.replaceChild(newImg, img);
            
            // Add click event listener
            newImg.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              
              const imageSrc = this.src;
              const imageAlt = this.alt;
              
              if (imageSrc && imageSrc !== '') {
                openImageZoom(imageSrc, imageAlt);
              }
            });
          });
        };
        
        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
          makeImagesZoomable();
        });
        
        // Re-initialize after Turbo navigation (for Rails with Turbo)
        document.addEventListener('turbo:load', function() {
          makeImagesZoomable();
        });
        
        // Handle modal keyboard navigation
        document.addEventListener('keydown', function(e) {
          const modal = document.getElementById('imageZoomModal');
          if (modal && modal.classList.contains('show')) {
            if (e.key === 'Escape') {
              const bsModal = bootstrap.Modal.getInstance(modal);
              if (bsModal) {
                bsModal.hide();
              }
            }
          }
        });
        
      })();
    </script>

    <!-- Enhanced Modal Styles for Image Zoom -->
    <style>
      #imageZoomModal .modal-content {
        background: rgba(0, 0, 0, 0.95) !important;
        backdrop-filter: blur(10px);
        border: none !important;
        box-shadow: none !important;
      }
      
      #imageZoomModal .modal-header {
        background: transparent;
        border: none;
        padding: 1rem;
      }
      
      #imageZoomModal .modal-header .btn {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }
      
      #imageZoomModal .modal-header .btn:hover {
        background: rgba(255, 255, 255, 1);
        transform: scale(1.1);
      }
      
      #imageZoomModal .modal-body {
        padding: 2rem;
      }
      
      #zoomedImage {
        transition: all 0.3s ease;
        border-radius: 15px !important;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5) !important;
      }
      
      #imageZoomModal .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.9);
      }
      
      /* Loading animation for zoomed image */
      #zoomedImage[style*="opacity: 0.5"] {
        position: relative;
      }
      
      #zoomedImage[style*="opacity: 0.5"]::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        transform: translate(-50%, -50%);
      }
      
      @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
      }
      
      /* Responsive adjustments */
      @media (max-width: 768px) {
        #imageZoomModal .modal-body {
          padding: 1rem;
        }
        
        #zoomedImage {
          max-height: 70vh !important;
        }
      }
      
      /* Unassign Customer Search Styles */
      .unassign-customer-search-container {
        position: relative;
      }

      .unassign-customer-search-input {
        padding-right: 2.5rem !important;
        border-radius: 12px !important;
        border: 2px solid rgba(102, 126, 234, 0.2) !important;
        transition: all 0.3s ease;
        background: white;
      }

      .unassign-customer-search-input:focus {
        border-color: #667eea !important;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
      }

      .unassign-customer-search-container .search-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #667eea;
        pointer-events: none;
        z-index: 10;
      }

      .unassign-customer-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 400px;
        width: max-content;
        max-width: 500px;
        background: white;
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 0.5rem;
      }

      .unassign-customer-suggestion-item {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid rgba(102, 126, 234, 0.05);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .unassign-customer-suggestion-item:hover {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
      }

      .unassign-customer-suggestion-item:last-child {
        border-bottom: none;
        border-radius: 0 0 12px 12px;
      }

      .unassign-customer-suggestion-item:first-child {
        border-radius: 12px 12px 0 0;
      }

      .unassign-customer-suggestion-name {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 0.25rem;
      }

      .unassign-customer-suggestion-phone {
        font-size: 0.875rem;
        color: #718096;
      }

      .unassign-customer-loading {
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 400px;
        width: max-content;
        max-width: 500px;
        background: white;
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        padding: 1rem 1.5rem;
        margin-top: 0.5rem;
        text-align: center;
        color: #718096;
        font-size: 0.875rem;
      }

      .unassign-selected-customer {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        border: 2px solid #667eea;
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .unassign-selected-customer .selected-customer-info {
        flex: 1;
      }

      .unassign-selected-customer .selected-customer-name {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 0.25rem;
      }

      .unassign-selected-customer .selected-customer-phone {
        font-size: 0.875rem;
        color: #718096;
      }

      .unassign-clear-customer {
        border-radius: 8px !important;
        padding: 0.25rem 0.5rem !important;
      }
    </style>
  </body>
</html>
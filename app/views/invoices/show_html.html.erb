<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">
    <div class="d-flex align-items-center">
      <div class="avatar-circle-large me-3">
        <i class="fas fa-file-invoice"></i>
      </div>
      <div>
        Invoice #<%= @invoice.formatted_number %>
        <small class="text-muted d-block">
          <span class="badge bg-<%= @invoice.status == 'paid' ? 'success' : @invoice.status == 'overdue' ? 'danger' : 'warning' %>">
            <%= @invoice.status.capitalize %>
          </span>
          â€¢ <%= @customer.name %>
        </small>
      </div>
    </div>
  </h1>
  <div class="btn-group" role="group">
    <!-- Share via WhatsApp Button -->
    <button type="button" 
            class="btn btn-success" 
            data-bs-toggle="modal" 
            data-bs-target="#whatsappShareModal"
            data-invoice-id="<%= @invoice.id %>"
            data-invoice-number="<%= @invoice.formatted_number %>"
            data-invoice-amount="<%= number_with_delimiter(@invoice.total_amount) %>"
            data-customer-phone="<%= @customer.phone_number %>">
      <i class="fab fa-whatsapp me-2"></i>Share via WhatsApp
    </button>
    
    <!-- PDF Download Button -->
    <%= link_to download_pdf_invoice_path(@invoice), 
          class: "btn btn-primary" do %>
      <i class="fas fa-file-pdf me-2"></i>Download PDF
    <% end %>
    
    <!-- Edit Button -->
    <%= link_to edit_invoice_path(@invoice), class: "btn btn-warning" do %>
      <i class="fas fa-edit me-2"></i>Edit
    <% end %>
    
    <!-- Mark as Paid Button (if not paid) -->
    <% unless @invoice.status == 'paid' %>
      <%= link_to invoice_path(@invoice, method: :patch, params: { invoice: { status: 'paid' } }), 
            method: :patch,
            class: "btn btn-outline-success",
            data: { 
              confirm: "Mark this invoice as paid?",
              turbo_method: :patch
            } do %>
        <i class="fas fa-check me-2"></i>Mark as Paid
      <% end %>
    <% end %>
    
    <!-- Back Button -->
    <%= link_to invoices_path, class: "btn btn-outline-secondary" do %>
      <i class="fas fa-arrow-left me-2"></i>Back to Invoices
    <% end %>
  </div>
</div>

<!-- Invoice Content in Card -->
<div class="card shadow">
  <div class="card-body p-0">
    <!-- Embed the existing invoice template -->
    <div style="transform: scale(0.9); transform-origin: top left; width: 111.11%;">
      <%= render partial: 'invoice_content' %>
    </div>
  </div>
</div>

<!-- WhatsApp Share Modal -->
<div class="modal fade" id="whatsappShareModal" tabindex="-1" aria-labelledby="whatsappShareModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="whatsappShareModalLabel">
          <i class="fab fa-whatsapp text-success me-2"></i>
          Share Invoice via WhatsApp
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="whatsappShareForm">
          <div class="mb-3">
            <label for="phoneNumber" class="form-label">Customer Phone Number</label>
            <input type="tel" 
                   class="form-control" 
                   id="phoneNumber" 
                   name="phone_number"
                   value="<%= @customer.phone_number %>"
                   placeholder="+91XXXXXXXXXX" 
                   required>
            <div class="form-text">Enter the phone number with country code (e.g., +919876543210)</div>
          </div>
          
          <div class="mb-3">
            <label for="messagePreview" class="form-label">Message Preview</label>
            <textarea class="form-control" 
                      id="messagePreview" 
                      rows="8" 
                      readonly 
                      style="background-color: #f8f9fa;"></textarea>
          </div>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>How it works:</strong> We'll generate a secure link to your invoice and create a WhatsApp message. 
            When you click "Send", WhatsApp will open with the pre-filled message ready to send.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="sendWhatsAppBtn">
          <i class="fab fa-whatsapp me-2"></i>
          <span class="btn-text">Send via WhatsApp</span>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .avatar-circle-large {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    font-weight: bold;
  }
  
  .btn-group .btn {
    margin-right: 0.5rem;
  }
  
  .btn-group .btn:last-child {
    margin-right: 0;
  }
  
  @media (max-width: 768px) {
    .btn-group {
      flex-direction: column;
      align-items: stretch;
    }
    
    .btn-group .btn {
      margin-right: 0;
      margin-bottom: 0.5rem;
    }
    
    .btn-group .btn:last-child {
      margin-bottom: 0;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('whatsappShareModal');
  const phoneInput = document.getElementById('phoneNumber');
  const messagePreview = document.getElementById('messagePreview');
  const sendBtn = document.getElementById('sendWhatsAppBtn');
  const form = document.getElementById('whatsappShareForm');
  
  let invoiceData = {};
  
  // When modal is shown, get invoice data from the button
  modal.addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    invoiceData = {
      id: button.getAttribute('data-invoice-id'),
      number: button.getAttribute('data-invoice-number'),
      amount: button.getAttribute('data-invoice-amount'),
      customerPhone: button.getAttribute('data-customer-phone')
    };
    
    // Pre-fill phone number if available
    if (invoiceData.customerPhone) {
      phoneInput.value = invoiceData.customerPhone;
    }
    
    updateMessagePreview();
  });
  
  // Update message preview when phone number changes
  phoneInput.addEventListener('input', updateMessagePreview);
  
  function updateMessagePreview() {
    const message = `Hi! ðŸ‘‹

Your invoice has been generated:
ðŸ“„ Invoice #${invoiceData.number}
ðŸ’° Amount: â‚¹${invoiceData.amount}
ðŸ“… Date: ${new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' })}

View your invoice: [Secure Link will be generated]

Thank you for your business! ðŸ™
- Your Company`;
    
    messagePreview.value = message;
  }
  
  // Handle form submission
  sendBtn.addEventListener('click', function() {
    const phoneNumber = phoneInput.value.trim();
    
    if (!phoneNumber) {
      alert('Please enter a phone number');
      phoneInput.focus();
      return;
    }
    
    // Validate phone number format
    const phoneRegex = /^\+?[\d\s\-\(\)]{10,15}$/;
    if (!phoneRegex.test(phoneNumber)) {
      alert('Please enter a valid phone number');
      phoneInput.focus();
      return;
    }
    
    // Show loading state
    sendBtn.disabled = true;
    sendBtn.querySelector('.btn-text').textContent = 'Generating Link...';
    
    // Send AJAX request to generate WhatsApp link
    fetch(`/invoices/${invoiceData.id}/share_whatsapp`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      },
      body: JSON.stringify({
        phone_number: phoneNumber
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Open WhatsApp with the generated link
        window.open(data.whatsapp_url, '_blank');
        
        // Close the modal
        bootstrap.Modal.getInstance(modal).hide();
        
        // Show success message
        showAlert('success', 'WhatsApp link generated successfully! The message has been opened in WhatsApp.');
      } else {
        showAlert('danger', data.error || 'Failed to generate WhatsApp link');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showAlert('danger', 'An error occurred while generating the WhatsApp link');
    })
    .finally(() => {
      // Reset button state
      sendBtn.disabled = false;
      sendBtn.querySelector('.btn-text').textContent = 'Send via WhatsApp';
    });
  });
  
  function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 5000);
  }
});
</script>
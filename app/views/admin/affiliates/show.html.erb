<div class="container-fluid">
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            <i class="fas fa-user me-2"></i>
            <%= @affiliate.name %>
          </h4>
          <div>
            <%= link_to edit_admin_affiliate_path(@affiliate), class: "btn btn-light btn-sm" do %>
              <i class="fas fa-edit me-1"></i>Edit
            <% end %>
            <%= link_to admin_affiliates_path, class: "btn btn-outline-light btn-sm" do %>
              <i class="fas fa-arrow-left me-1"></i>Back
            <% end %>
          </div>
        </div>
        <div class="card-body p-4">
          <div class="row mb-4">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Contact Information</h6>
              <p><strong>Email:</strong> <%= @affiliate.email %></p>
              <p><strong>Phone:</strong> <%= @affiliate.phone %></p>
              <p><strong>Location:</strong> <%= @affiliate.location %></p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Business Details</h6>
              <p><strong>Commission Rate:</strong> <%= @affiliate.commission_rate %>%</p>
              <p><strong>Referral Code:</strong> <code class="badge bg-secondary"><%= @affiliate.referral_code %></code></p>
              <p>
                <strong>Status:</strong>
                <%
                  status_text = @affiliate.status&.capitalize || 'Pending'
                  badge_class = begin
                    if @affiliate.pending?
                      'warning'
                    elsif @affiliate.approved?
                      'success'
                    elsif @affiliate.suspended?
                      'danger'
                    else
                      'secondary'
                    end
                  rescue
                    'secondary'
                  end
                %>
                <span class="badge bg-<%= badge_class %>"><%= status_text %></span>
              </p>
              <p><strong>Active:</strong>
                <span class="badge bg-<%= @affiliate.active? ? 'success' : 'danger' %>">
                  <%= @affiliate.active? ? 'Yes' : 'No' %>
                </span>
              </p>
            </div>
          </div>

          <!-- Stats -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="text-center">
                <h4 class="text-primary"><%= @affiliate.total_referrals %></h4>
                <small class="text-muted">Total Referrals</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <h4 class="text-success"><%= @affiliate.approved_referrals %></h4>
                <small class="text-muted">Approved</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <h4 class="text-warning"><%= @affiliate.pending_referrals %></h4>
                <small class="text-muted">Pending</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <h4 class="text-info">₹<%= number_with_delimiter((@affiliate.total_earnings || 0).to_i) %></h4>
                <small class="text-muted">Total Earnings</small>
              </div>
            </div>
          </div>

          <!-- Recent Referrals -->
          <% if @referrals.any? %>
            <h6 class="text-muted mb-3">Recent Referrals</h6>
            <div class="table-responsive mb-4">
              <table class="table table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Customer</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Reward</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
                  <% @referrals.each do |referral| %>
                    <tr>
                      <td><%= referral.customer_name %></td>
                      <td><%= referral.customer_phone %></td>
                      <td>
                        <span class="badge bg-<%= referral.pending? ? 'warning' : referral.approved? ? 'success' : 'danger' %>">
                          <%= referral.status&.capitalize %>
                        </span>
                      </td>
                      <td>₹<%= referral.reward_amount.to_i %></td>
                      <td><%= referral.created_at.strftime("%d %b %Y") %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="fas fa-handshake fa-2x text-muted mb-2"></i>
              <p class="text-muted">No referrals submitted yet</p>
            </div>
          <% end %>

          <!-- Recent Bookings -->
          <% if @bookings.any? %>
            <h6 class="text-muted mb-3">Recent Bookings</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Status</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
                  <% @bookings.each do |booking| %>
                    <tr>
                      <td><%= booking.product&.name || 'Product' %></td>
                      <td><%= booking.quantity %> <%= booking.product&.unit || 'units' %></td>
                      <td>₹<%= number_with_delimiter(booking.total_amount.to_i) %></td>
                      <td>
                        <span class="badge bg-<%= booking.pending? ? 'warning' : booking.confirmed? ? 'info' : booking.completed? ? 'success' : 'danger' %>">
                          <%= booking.status&.capitalize %>
                        </span>
                      </td>
                      <td><%= booking.created_at.strftime("%d %b %Y") %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="fas fa-shopping-cart fa-2x text-muted mb-2"></i>
              <p class="text-muted">No bookings made yet</p>
            </div>
          <% end %>

          <!-- Action Buttons -->
          <div class="mt-4 text-center">
            <% begin %>
              <% if @affiliate.pending? %>
                <%= link_to approve_admin_affiliate_path(@affiliate), method: :patch, class: "btn btn-success me-2",
                    confirm: "Approve this affiliate?" do %>
                  <i class="fas fa-check me-1"></i>Approve Affiliate
                <% end %>
              <% elsif @affiliate.approved? %>
                <%= link_to suspend_admin_affiliate_path(@affiliate), method: :patch, class: "btn btn-warning me-2",
                    confirm: "Suspend this affiliate?" do %>
                  <i class="fas fa-pause me-1"></i>Suspend Affiliate
                <% end %>
              <% end %>
            <% rescue %>
              <%= link_to approve_admin_affiliate_path(@affiliate), method: :patch, class: "btn btn-success me-2",
                  confirm: "Approve this affiliate?" do %>
                <i class="fas fa-check me-1"></i>Approve Affiliate
              <% end %>
            <% end %>

            <%= link_to edit_admin_affiliate_path(@affiliate), class: "btn btn-outline-primary me-2" do %>
              <i class="fas fa-edit me-1"></i>Edit Details
            <% end %>

            <%= link_to admin_affiliate_path(@affiliate), method: :delete, class: "btn btn-outline-danger",
                confirm: "Are you sure? This will permanently delete this affiliate and all their data." do %>
              <i class="fas fa-trash me-1"></i>Delete Affiliate
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>